<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ======== 域名统一（避免 www/非www 导致 localStorage 登录态不共享） ======== */
(function(){
  try{
    if(location.hostname === 'liruna.icu'){
      location.replace('https://www.liruna.icu' + location.pathname + location.search + location.hash);
    }
  }catch(e){}
})();

/* ======== Supabase 初始化（不触发网络请求） ======== */
(function(){
  try{
    window.SUPABASE_URL = 'https://yqsjkdndasbdfmjwahwk.supabase.co';
    window.SUPABASE_KEY = 'sb_publishable_8owDy_9hIN3uaBCzd6jncg_i8e68dL0';
    if(window.supabase && window.SUPABASE_URL && window.SUPABASE_KEY){
      window.__supa = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_KEY, {
        auth: { persistSession: true, autoRefreshToken: false, detectSessionInUrl: false }
      });
    }
  }catch(e){}
})();
</script>

﻿<!DOCTYPE html>

<!--
======================== 项目交接表（写入文件版） ========================
系统：商业订单利润管理系统（单文件 HTML，无框架无构建）
写入时间：2026-02-11

0. 一句话总览
- 本地为唯一真相；云端仅“手动快照”；不自动拉取/保存；UI 与云逻辑严格解耦。

1. 唯一稳定基线
- v15k 为唯一干净稳定可继续演进版本；禁止从 v15d/v22/v23 叠加。

2. 三条铁律（绝对不能破）
(1) 本地为本体：orders/计算结果只在本地；init/login/refresh/import 禁止自动云读写
(2) 云端只做手动快照：仅允许通过 window.saveSnapshotToCloud() / window.loadSnapshotFromCloud()
    ☁️/菜单面板只做入口，禁止直接 Supabase/直接读写 orders/绕过 API
(3) 登录态恢复必须走 API：刷新/恢复必须 __setLoginState(true)，禁止只改 __isLoggedIn

3. ☁️/菜单按钮关键机制
- ☁️/按钮为 JS 动态插入，位置脚本反复重算；纯 CSS top/font-size 多数无效
- 唯一跨浏览器稳定方案：MutationObserver 捕获真实节点 + 读取 computed transform + 在 transform 后叠加
- 禁止包裹按钮 DOM（会导致按钮消失）
- 本轮定版：仅将显示文案从“☁️”改为“菜单”，保持原按钮点击/定位机制不变

4. 管理员系统（已接通可用）
- 管理员邮箱：912872449@qq.com
- 未登录管理员账号：管理员入口隐藏
- 功能：新建账号 / 删除账号 / 重置密码 / 展示账号列表 / 禁用/解禁登录（user_profiles.disabled）
- 原则：仅手动点击触发；不在页面加载时自动请求云端；不触碰 orders

5. 云快照（稳定）
- 保存/拉取均为“手动触发”；需保持本地 orders 一致性完整恢复

6. 登录 UI（体验优化）
- 登录弹窗居中、按钮统一风格
- 推荐使用 App Toast 替代 alert（避免浏览器系统弹窗）

7. 管理员联系入口
- 登录弹窗加入：联系管理员vx：pinking0000（点我复制）

8. 踩坑记录
- 新造“菜单按钮”在移动端常点不到（遮挡/事件被吃）；最稳是复用 v15k 原生插入按钮节点
- “不要悬浮”= 页面滑下去按钮也要一起滑走（随页面滚动）

9. 下一步建议
P0：统一提示入口（替换残留 alert 为 Toast）
P1：继续做视觉/动效（只改 transform/opacity/阴影，不改布局）
P2：管理员列表搜索/排序/快速禁用等（仍全部手动触发）

10. 禁止事项（再强调）
- 禁止自动云端拉取/保存；禁止页面加载触发 Supabase 请求；
- 禁止主界面出现额外云按钮；禁止包裹按钮 DOM；禁止绕过 __setLoginState

======================== /项目交接表（写入文件版） =======================
-->

<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0b1220">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>商业订单利润管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 10px;
            min-height: 100vh;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1080px;
            margin: 0 auto;
        }
        
        .header {
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
        
        .header h1 i {
            margin-right: 8px;
            font-size: 20px;
        }
        
        .total-profit {
            font-size: 24px;
            font-weight: 700;
            margin-top: 8px;
            display: flex;
            align-items: center;
        }
        
        .profit-positive {
            color: #2ecc71;
        }
        
        .profit-negative {
            color: #e74c3c;
        }
        
        .filter-status {
            font-size: 12px;
            color: #bdc3c7;
            margin-top: 4px;
            display: flex;
            align-items: center;
        }
        
        .filter-status i {
            margin-right: 4px;
        }
        
        .actions {
            display: flex;
            margin-bottom: 15px;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: thin;
            scrollbar-color: #bdc3c7 transparent;
        }
        
        .actions::-webkit-scrollbar {
            height: 4px;
        }
        
        .actions::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 2px;
        }
        
        .actions::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 2px;
        }
        
        .action-btn {
            flex: 0 0 auto;
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }
        
        .action-btn i {
            margin-right: 6px;
            font-size: 14px;
        }
        
        .btn-add {
            background-color: #3498db;
            color: white;
        }
        
        .btn-export {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-import {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-save {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-calculator {
            background-color: #e67e22;
            color: white;
        }
        
        .btn-filter {
            background-color: #1abc9c;
            color: white;
            position: relative;
        }
        
        .btn-filter.active {
            background-color: #16a085;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .btn-clear-filter {
            background-color: #95a5a6;
            color: white;
        }
        
        .filter-select-container {
            position: relative;
            flex: 0 0 auto;
            min-width: 140px;
        }
        
        .filter-select {
            width: 100%;
            padding: 10px 30px 10px 10px;
            border: none;
            border-radius: 6px;
            background-color: #ecf0f1;
            color: #2c3e50;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .filter-select:focus {
            outline: none;
            background-color: #dfe6e9;
        }
        
        .filter-select:hover {
            background-color: #dfe6e9;
        }
        
        .filter-select-container::after {
            content: '\f0d7';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            pointer-events: none;
        }
        
        .action-btn:hover, .filter-select:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }
        
        .action-btn:active, .filter-select:active {
            transform: translateY(0);
        }
        
        .table-container {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 15px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }
        
        thead {
            background-color: #34495e;
            color: white;
        }
        
        th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        
        th.sortable:hover {
            background-color: #2c3e50;
        }
        
        .sort-indicator {
            margin-left: 4px;
            opacity: 0.7;
        }
        
        tbody tr {
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tbody tr:hover {
            background-color: #f0f7ff;
        }
        
        td {
            padding: 8px;
            font-size: 12.5px;
        }
        
        input, select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12.5px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .profit-cell {
            font-weight: 600;
        }
        
        .date-cell {
            cursor: pointer;
            position: relative;
        }
        
        .date-cell:hover {
            color: #3498db;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .delete-btn i {
            font-size: 11px;
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .toast {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 500;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .file-input {
            display: none;
        }
        
        /* 计算器样式 */
        .calculator-container {
            position: fixed;
            bottom: 15px;
            right: 15px;
            width: 300px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
            overflow: hidden;
        }
        
        .calculator-header {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .calculator-title {
            font-weight: 600;
            font-size: 15px;
        }
        
        .calculator-close {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .calculator-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .calculator-display {
            padding: 12px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
            text-align: right;
            font-size: 22px;
            font-weight: 600;
            min-height: 55px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            word-break: break-all;
            overflow-wrap: break-word;
            font-family: 'Courier New', monospace;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .calculator-history {
            font-size: 13px;
            color: #7f8c8d;
            min-height: 18px;
            width: 100%;
            text-align: right;
            margin-bottom: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .calculator-current {
            font-size: 26px;
            width: 100%;
            text-align: right;
            word-break: break-all;
        }
        
        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background-color: #ddd;
        }
        
        .calculator-btn {
            border: none;
            padding: 15px 8px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .calculator-btn:hover {
            background-color: #f5f5f5;
        }
        
        .calculator-btn.operator {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .calculator-btn.equals {
            background-color: #e67e22;
            color: white;
            font-weight: 600;
        }
        
        .calculator-btn.equals:hover {
            background-color: #d35400;
        }
        
        .calculator-btn.clear {
            background-color: #e74c3c;
            color: white;
            font-weight: 600;
        }
        
        .calculator-btn.clear:hover {
            background-color: #c0392b;
        }
        
        .calculator-btn.zero {
            grid-column: span 2;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            
            .header {
                margin-bottom: 12px;
                padding: 12px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .total-profit {
                font-size: 22px;
            }
            
            .actions {
                margin-bottom: 12px;
                gap: 6px;
            }
            
            .action-btn, .filter-select {
                font-size: 12px;
                padding: 8px 10px;
            }
            
            .action-btn i {
                font-size: 13px;
                margin-right: 4px;
            }
            
            .filter-select-container {
                min-width: 120px;
            }
            
            .filter-select {
                padding: 8px 25px 8px 8px;
            }
            
            th, td {
                padding: 6px;
                font-size: 12px;
            }
            
            input, select {
                padding: 5px 6px;
                font-size: 12px;
            }
            
            .table-container {
                margin-bottom: 12px;
            }
            
            .calculator-container {
                width: 280px;
                right: 8px;
                bottom: 8px;
            }
            
            .calculator-display {
                font-size: 18px;
                min-height: 50px;
            }
            
            .calculator-history {
                font-size: 11px;
            }
            
            .calculator-current {
                font-size: 22px;
            }
            
            .calculator-btn {
                padding: 12px 6px;
                font-size: 14px;
            }
        }
    
/* ===== 管理员面板：三按钮并排 ===== */
#adminPanel .admin-action-row{display:flex; gap:12px; align-items:stretch;}
#adminPanel .admin-action-row button{flex:1; margin:0 !important;}
@media (max-width:420px){
  #adminPanel .admin-action-row{gap:10px;}
}


/* === Login modal centering + button unification (mobile keyboard friendly) === */
.login-box{
  position: fixed !important;
  left: 50% !important;
  top: 50% !important;
  transform: translate(-50%, -50%) !important;
  width: min(92vw, 360px) !important;
  max-height: calc(100vh - 90px) !important;
  overflow: auto !important;
  z-index: 999999 !important;
  background: #fff !important;
  border-radius: 16px !important;
  padding: 14px 14px 12px !important;
  box-shadow: 0 18px 55px rgba(0,0,0,.22) !important;
}

/* backdrop */
#loginBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.18);
  backdrop-filter: blur(2px);
  z-index: 999998;
  display: none;
}

/* inputs a bit tighter */
.login-field input{
  height: 44px;
  border-radius: 12px;
}

/* actions row: same height, same radius, equal width */
.login-actions{
  display:flex;
  gap: 10px;
  margin-top: 10px;
}
.login-actions button{
  flex: 1;
  height: 40px;
  border-radius: 12px;
  font-size: 15px;
  padding: 0 10px;
  white-space: nowrap;
}
.login-btn-primary{
  background:#fff;
  color:#111827;
  border:1px solid rgba(17,24,39,.25);
}
.login-btn-ghost{
  background:#fff;
  color:#111827;
  border:1px solid rgba(17,24,39,.25);
}


/* === 登录框：联系管理员（可复制） === */
.login-contact{
  margin: 6px 2px 10px;
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap: wrap;
}
.login-contact-label{
  color: rgba(17,24,39,.75);
  font-size: 13px;
}
.login-contact-copy{
  border: 1px dashed rgba(17,24,39,.35);
  background: rgba(17,24,39,.04);
  color: #111827;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 700;
  letter-spacing: .2px;
}
.login-contact-copy:active{ transform: scale(.98); }
#copyToast{
  position: fixed;
  left: 50%;
  bottom: 72px;
  transform: translateX(-50%);
  background: rgba(17,24,39,.92);
  color: #fff;
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 13px;
  z-index: 2147483647;
  display:none;
}


/* === 菜单按钮：不悬浮（随页面滚动）+ 缩小20px === */
.cloud-addon-toggle{
  width:41px !important;
  height:41px !important;
  border-radius:12px !important;
  font-size:14px !important;
  line-height:1 !important;
}

/* 面板/卡片：绝对定位覆盖层（弹开不影响页面布局，不推挤内容） */
.cloud-addon-panel{
  position: absolute !important;
  right: 16px !important;
  top: 50px !important;
  bottom: auto !important;
  left: auto !important;
}
.cloud-addon-card{
  position: absolute !important;
  right: 16px !important;
  top: 96px !important; /* 50 + 36 + 10 */
  bottom: auto !important;
  left: auto !important;
  z-index: 99998 !important;
}


/* === UI 微特效（不改布局，仅 transform/opacity/阴影） === */
:root{
  --fx-ease: cubic-bezier(.2,.8,.2,1);
  --fx-fast: 140ms;
  --fx-med: 220ms;
}

/* 全局按钮/可点击控件：按压反馈 */
button, .btn, .cloud-addon-toggle, .login-contact-copy, .admin-btn, .admin-btn-create, .admin-btn-reset, .admin-btn-delete{
  transition: transform var(--fx-fast) var(--fx-ease), box-shadow var(--fx-fast) var(--fx-ease), filter var(--fx-fast) var(--fx-ease), opacity var(--fx-fast) var(--fx-ease);
  -webkit-tap-highlight-color: transparent;
}
button:active, .btn:active, .cloud-addon-toggle:active, .login-contact-copy:active, .admin-btn:active{
  transform: scale(.98);
}

/* 菜单按钮：轻微呼吸（仅当面板收起时） */
@keyframes fxBreath{
  0%,100%{ transform: translateY(0); }
  50%{ transform: translateY(-2px); }
}
.cloud-addon-toggle.fx-idle{
  animation: fxBreath 2.8s var(--fx-ease) infinite;
}

/* 面板弹出/收起：淡入 + 上浮，不影响布局 */
.cloud-addon-card{
  opacity: 0;
  transform: translateY(-6px);
  transition: opacity var(--fx-med) var(--fx-ease), transform var(--fx-med) var(--fx-ease);
  will-change: opacity, transform;
}
.cloud-addon-card.fx-open{
  opacity: 1;
  transform: translateY(0);
}

/* 登录框：出现淡入（不改位置尺寸） */
.login-box{
  opacity: 0;
  transform: translate(-50%, -50%) scale(.98);
  transition: opacity var(--fx-med) var(--fx-ease), transform var(--fx-med) var(--fx-ease);
  will-change: opacity, transform;
}
.login-box.fx-open{
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}

/* 表格/列表行：仅 hover/active 视觉，不动布局 */
table tr, .row, .order-row{
  transition: background-color var(--fx-med) var(--fx-ease), box-shadow var(--fx-med) var(--fx-ease), filter var(--fx-med) var(--fx-ease);
}
table tr:hover{
  background-color: rgba(17,24,39,.03);
}
table tr:active{
  background-color: rgba(17,24,39,.05);
}

/* 输入框聚焦：轻微阴影 */
input, select, textarea{
  transition: box-shadow var(--fx-med) var(--fx-ease), border-color var(--fx-med) var(--fx-ease);
}
input:focus, select:focus, textarea:focus{
  box-shadow: 0 0 0 4px rgba(59,130,246,.12);
}

/* Toast 出现/消失更顺滑 */
#copyToast{
  transition: opacity var(--fx-fast) var(--fx-ease), transform var(--fx-fast) var(--fx-ease);
  opacity: 0;
  transform: translateX(-50%) translateY(6px);
}
#copyToast.fx-show{
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}


/* === APP 丝滑增强（不改布局，仅视觉与交互质感） === */
:root{
  --app-bg: #f6f7fb;
  --app-card: rgba(255,255,255,.86);
  --app-line: rgba(17,24,39,.08);
  --app-shadow: 0 14px 40px rgba(17,24,39,.10);
  --app-shadow-2: 0 10px 28px rgba(17,24,39,.08);
}

/* 更像 App 的基础渲染 */
html, body{
  background: var(--app-bg);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  overscroll-behavior-y: contain;
  scroll-behavior: smooth;
}

/* 页面首次进入：轻淡入（不移动布局） */
body{
  opacity: 0;
  transition: opacity 260ms var(--fx-ease);
}
body.fx-page-ready{
  opacity: 1;
}

/* 轻微玻璃感（只加在面板/弹层，不改尺寸） */
.cloud-addon-card,
.login-box{
  background: var(--app-card) !important;
  border: 1px solid var(--app-line) !important;
  box-shadow: var(--app-shadow) !important;
  backdrop-filter: blur(10px);
}

/* 输入框更像 App */
input, select, textarea{
  background: rgba(255,255,255,.92);
  border: 1px solid rgba(17,24,39,.14);
}
input:focus, select:focus, textarea:focus{
  border-color: rgba(59,130,246,.45);
}

/* 更顺滑的滚动手感（对可滚动容器） */
*{
  -webkit-tap-highlight-color: transparent;
}
.cloud-addon-card,
.login-box{
  -webkit-overflow-scrolling: touch;
}

/* 按钮“轻波纹感”（无需改结构） */
button, .cloud-addon-toggle, .admin-btn, .login-contact-copy{
  position: relative;
  overflow: hidden;
}
button::after, .cloud-addon-toggle::after, .admin-btn::after, .login-contact-copy::after{
  content:"";
  position:absolute;
  inset:-40%;
  background: radial-gradient(circle, rgba(255,255,255,.55) 0%, rgba(255,255,255,0) 60%);
  opacity:0;
  transform: scale(.7);
  transition: opacity var(--fx-fast) var(--fx-ease), transform var(--fx-fast) var(--fx-ease);
  pointer-events:none;
}
button:active::after, .cloud-addon-toggle:active::after, .admin-btn:active::after, .login-contact-copy:active::after{
  opacity:.9;
  transform: scale(1);
}

/* 卡片/区块 hover（桌面）轻抬升 */
@media (hover:hover){
  .cloud-addon-card:hover{
    box-shadow: 0 18px 55px rgba(17,24,39,.14) !important;
  }
}

/* 尊重系统减少动效 */
@media (prefers-reduced-motion: reduce){
  *{
    animation: none !important;
    transition: none !important;
    scroll-behavior: auto !important;
  }
}


/* === 登录弹窗：居中对齐（稳定版） === */
#loginBackdrop{
  display:none;
  align-items:center;
  justify-content:center;
}
#loginBackdrop.show{ display:flex; }

/* 登录盒子在遮罩里居中，不依赖 left/top */
#loginBox{
  position: relative !important;
  left: auto !important;
  top: auto !important;
  transform: none !important;
  margin: 0 !important;
}

/* 美化：成功提示弹窗（替代 alert） */
#appNotice{
  position: fixed;
  left: 50%;
  top: 18%;
  transform: translateX(-50%);
  z-index: 2147483647;
  min-width: min(88vw, 360px);
  padding: 12px 14px;
  border-radius: 14px;
  background: rgba(17,24,39,.92);
  color: #fff;
  font-size: 14px;
  font-weight: 700;
  box-shadow: 0 18px 55px rgba(0,0,0,.22);
  opacity: 0;
  pointer-events: none;
  transition: opacity 180ms var(--fx-ease), transform 180ms var(--fx-ease);
}
#appNotice.show{
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
#appNotice .sub{
  margin-top: 4px;
  font-size: 12px;
  font-weight: 500;
  opacity: .85;
}



/* === 登录打开时：隐藏菜单层，避免遮挡/误触（不影响登录按钮事件） === */
#loginBackdrop{ z-index: 2147483647 !important; }
body.login-open .cloud-addon-panel{
  z-index: 2147483646 !important;
  pointer-events: none !important;
  opacity: .12;
}
body.login-open .cloud-addon-card{ display:none !important; }



/* ===================== APP 视觉统一（v6） ===================== */
:root{
  --app-bg: #f5f7fb;
  --app-surface: rgba(255,255,255,.86);
  --app-surface-2: rgba(255,255,255,.94);
  --app-line: rgba(15,23,42,.08);
  --app-text: #0f172a;
  --app-muted: rgba(15,23,42,.62);
  --app-shadow: 0 18px 55px rgba(15,23,42,.10);
  --app-shadow-2: 0 10px 28px rgba(15,23,42,.08);
  --app-radius: 18px;
  --app-radius-sm: 14px;
  --app-pad: 12px;
  --app-pad-lg: 16px;
}

html, body{
  background: var(--app-bg) !important;
}

/* iOS 安全区 */
body{
  padding: calc(env(safe-area-inset-top) + 10px) 10px calc(env(safe-area-inset-bottom) + 12px) 10px;
}

/* 顶部标题卡片：更像 App 头部 */
.header{
  border-radius: var(--app-radius) !important;
  box-shadow: var(--app-shadow) !important;
  background: linear-gradient(135deg, #0b1220 0%, #111827 45%, #1f2937 100%) !important;
  position: sticky;
  top: calc(env(safe-area-inset-top) + 8px);
  z-index: 50;
  backdrop-filter: blur(10px);
}

/* 动作条：像 App 的工具栏 */
.actions{
  background: var(--app-surface);
  border: 1px solid var(--app-line);
  border-radius: var(--app-radius);
  padding: 10px;
  box-shadow: var(--app-shadow-2);
  position: sticky;
  top: calc(env(safe-area-inset-top) + 120px);
  z-index: 40;
  backdrop-filter: blur(10px);
}

/* 统一按钮质感（不改颜色体系，只提升质感） */
.action-btn{
  border-radius: 14px !important;
  box-shadow: 0 10px 22px rgba(15,23,42,.10) !important;
  transform: translateZ(0);
}
.action-btn:hover{ transform: translateY(-1px); }
.action-btn:active{ transform: scale(.98); }

/* 筛选下拉更像原生 */
.filter-select{
  border-radius: 14px !important;
  background: var(--app-surface-2) !important;
  border: 1px solid var(--app-line) !important;
}

/* 表格容器：玻璃卡片 */
.table-container{
  border-radius: var(--app-radius) !important;
  border: 1px solid var(--app-line);
  box-shadow: var(--app-shadow-2) !important;
  background: var(--app-surface);
  backdrop-filter: blur(10px);
}

/* 表头更“粘”一点（桌面/大屏可见） */
thead{
  position: sticky;
  top: 0;
  z-index: 2;
}

/* 单元格输入更像 App */
input, select, textarea{
  border-radius: 12px !important;
  border: 1px solid rgba(15,23,42,.14) !important;
  background: rgba(255,255,255,.95) !important;
}

/* toast 更像 App */
.toast{
  border-radius: 14px !important;
  box-shadow: var(--app-shadow) !important;
}

/* 计算器：更像浮层面板 */
.calculator-container{
  border-radius: var(--app-radius) !important;
  border: 1px solid var(--app-line);
  backdrop-filter: blur(10px);
}

/* 菜单按钮：玻璃按钮 */
.cloud-addon-toggle{
  border-radius: 16px !important;
  box-shadow: 0 18px 55px rgba(15,23,42,.16) !important;
  backdrop-filter: blur(10px);
}

/* 登录框：卡片层次更明显 */
#loginBox{
  width: min(92vw, 380px) !important;
  border-radius: var(--app-radius) !important;
  box-shadow: var(--app-shadow) !important;
  border: 1px solid var(--app-line) !important;
}

/* 登录按钮排版更“App 按钮” */
.login-actions button{
  height: 44px !important;
  border-radius: 14px !important;
  box-shadow: 0 10px 22px rgba(15,23,42,.10);
}

/* 表格行 hover 更轻 */
tbody tr:hover{
  background-color: rgba(59,130,246,.06) !important;
}

/* 底部留白（避免手机浏览器底栏遮挡） */
.footer{
  padding-bottom: calc(env(safe-area-inset-bottom) + 12px) !important;
  color: rgba(15,23,42,.55) !important;
}

/* 降低“系统弹窗”存在感：尽量用 notice/toast（不改逻辑） */



/* ===================== 顶部沉浸式状态栏（v6-immersive） ===================== */
/* 顶部状态栏覆盖层：让页面顶端更像 App */
#statusBarOverlay{
  position: fixed;
  left: 0;
  top: 0;
  width: 100vw;
  height: calc(env(safe-area-inset-top) + 18px);
  background: linear-gradient(135deg, rgba(11,18,32,.96) 0%, rgba(17,24,39,.88) 55%, rgba(31,41,55,.72) 100%);
  z-index: 1000; /* 高于普通内容，低于弹窗/遮罩 */
  pointer-events: none;
  backdrop-filter: blur(12px);
}

/* 让内容整体上移到安全区边缘，实现“沉浸” */
body{
  padding-top: calc(env(safe-area-inset-top) + 8px) !important;
}

/* Header 吸顶时顶边贴近状态栏 */
.header{
  margin-top: 0 !important;
  border-top-left-radius: 22px !important;
  border-top-right-radius: 22px !important;
}

/* iOS 触顶滚动时的背景一致性 */
html, body{
  background: #f5f7fb !important;
}



/* === 表格内输入框等宽修复：铺满单元格（v6-fix） === */
table input, table select, table textarea{
  width: 100% !important;
  box-sizing: border-box;
}



/* ===================== B：自适应列宽（Grid 重构 v6-B）===================== */
/* 说明：此模式不再追求“列对齐”，而是让每个输入框按内容自适应宽度，更像表单/标签流。 */
.grid-table{ display:none; padding: 10px; gap: 10px; flex-direction:column; }
.grid-row{
  display:flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  padding: 12px;
  border-radius: 18px;
  background: rgba(255,255,255,.92);
  border: 1px solid rgba(15,23,42,.08);
  box-shadow: 0 12px 30px rgba(15,23,42,.07);
}
.grid-chip{
  display:flex;
  flex-direction:column;
  gap: 6px;
  padding: 8px 10px;
  border-radius: 16px;
  border: 1px solid rgba(15,23,42,.08);
  background: rgba(255,255,255,.86);
  min-width: 110px;
}
.grid-chip .lbl{
  font-size: 11px;
  font-weight: 900;
  color: rgba(15,23,42,.55);
}
.grid-chip .val{
  display:flex;
  align-items:center;
  gap: 8px;
}
.grid-chip .val input{
  width: auto !important;
  min-width: 40px;
  max-width: 70vw;
  height: 40px;
  padding: 10px 10px;
  border-radius: 14px !important;
  font-weight: 900;
  box-sizing: content-box !important; /* 让宽度更贴近内容 */
}
.grid-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  width: 100%;
  margin-bottom: 6px;
}
.grid-title{
  min-width:0;
  display:flex;
  flex-direction:column;
  gap: 4px;
}
.grid-title .t{
  font-weight: 950;
  color: rgba(15,23,42,.92);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.grid-title .s{
  font-size: 12px;
  font-weight: 900;
  color: rgba(15,23,42,.56);
}
.grid-profit{
  font-weight: 950;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.75);
}
.grid-actions{
  width: 100%;
  display:flex;
  gap: 10px;
}
.grid-actions .delete-btn{
  width: 100%;
  border-radius: 14px !important;
}

/* 默认启用 Grid（更像自适应），如需回到表格可自行切回 display */
#orders-table{ display:none !important; }
.grid-table{ display:flex !important; }

</style>
</head>
<body>
    <div id="statusBarOverlay" aria-hidden="true"></div>

<!--
=====================================================
搞钱吧 v4 · 外挂骨架 STEP 2（官方地基版）
-----------------------------------------------------
定义：
- 本文件是“外挂系统”的唯一合法地基
- 只验证：UI + 点击链路 + 人工触发
- 不接 Supabase
- 不读写 orders
- 不自动触发任何云端行为

任何云端能力：
- 必须在此文件基础上演进
- 必须保持“手动点击触发”
=====================================================
-->

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> 商业订单利润管理系统</h1>
            <p>总计 <span id="total-count">0</span> 笔订单</p>
            <div class="total-profit" id="total-profit">总利润: ¥0.00</div>
            <div class="filter-status" id="filter-status">
                <i class="fas fa-filter"></i> <span id="filter-status-text">显示全部订单</span>
            </div>
        </div>
        
        <div class="actions">
            <button class="action-btn btn-add" id="add-btn">
                <i class="fas fa-plus-circle"></i> 新增
            </button>
            <button class="action-btn btn-export" id="export-btn">
                <i class="fas fa-file-export"></i> 导出
            </button>
            <button class="action-btn btn-import" id="import-btn">
                <i class="fas fa-file-import"></i> 导入
            </button>
            <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls">
            <button class="action-btn btn-save" id="save-btn">
                <i class="fas fa-save"></i> 保存
            </button>
            <button class="action-btn btn-calculator" id="calculator-btn">
                <i class="fas fa-calculator"></i> 计算器
            </button>
            
            <!-- 下单人筛选框 -->
            <div class="filter-select-container">
                <select class="filter-select" id="customer-filter">
                    <option value="">全部下单人</option>
                    <!-- 下单人选项将通过JS动态添加 -->
                </select>
            </div>
            
            <!-- 产品筛选框 -->
            <div class="filter-select-container">
                <select class="filter-select" id="product-filter">
                    <option value="">全部产品</option>
                    <!-- 产品选项将通过JS动态添加 -->
                </select>
            </div>
            
            <button class="action-btn btn-clear-filter" id="clear-filter">
                <i class="fas fa-times-circle"></i> 清除筛选
            </button>
        </div>
        
        <div class="table-container">
            <div id="gridTable" class="grid-table" aria-label="Grid Table"></div>
            <table id="orders-table">
                <thead>
                    <tr>
                        <th style="width: 70px;" class="sortable" id="date-header">
                            日期
                            <span class="sort-indicator" id="date-sort">↓</span>
                        </th>
                        <th>下单人</th>
                        <th>产品</th>
                        <th style="width: 80px;">下单金额</th>
                        <th style="width: 60px;">返款</th>
                        <th style="width: 60px;">运费</th>
                        <th style="width: 80px;" class="sortable" id="sell-amount-header">
                            售出金额
                            <span class="sort-indicator" id="sell-amount-sort">↕</span>
                        </th>
                        <th style="width: 80px;">利润</th>
                        <th style="width: 100px;">物流单号</th>
                        <th>备注</th>
                        <th style="width: 60px;">操作</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- 行将通过JS动态添加 -->
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            商业订单利润管理系统 &copy; 2026 | 专为移动端优化
        </div>
    </div>
    
    <!-- 计算器容器 -->
    <div class="calculator-container" id="calculator">
        <div class="calculator-header">
            <div class="calculator-title">计算器</div>
            <button class="calculator-close" id="calculator-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="calculator-display">
            <div class="calculator-history" id="calculator-history"></div>
            <div class="calculator-current" id="calculator-current">0</div>
        </div>
        <div class="calculator-buttons">
            <button class="calculator-btn clear" data-action="clear">C</button>
            <button class="calculator-btn clear" data-action="clear-entry">CE</button>
            <button class="calculator-btn operator" data-action="percent">%</button>
            <button class="calculator-btn operator" data-action="divide">÷</button>
            
            <button class="calculator-btn" data-number="7">7</button>
            <button class="calculator-btn" data-number="8">8</button>
            <button class="calculator-btn" data-number="9">9</button>
            <button class="calculator-btn operator" data-action="multiply">×</button>
            
            <button class="calculator-btn" data-number="4">4</button>
            <button class="calculator-btn" data-number="5">5</button>
            <button class="calculator-btn" data-number="6">6</button>
            <button class="calculator-btn operator" data-action="subtract">-</button>
            
            <button class="calculator-btn" data-number="1">1</button>
            <button class="calculator-btn" data-number="2">2</button>
            <button class="calculator-btn" data-number="3">3</button>
            <button class="calculator-btn operator" data-action="add">+</button>
            
            <button class="calculator-btn zero" data-number="0">0</button>
            <button class="calculator-btn" data-action="decimal">.</button>
            <button class="calculator-btn equals" data-action="equals">=</button>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // 初始化数据
        let orders = JSON.parse(localStorage.getItem('orderProfitData')) || [];
        let isDateFullFormat = {};
        
        // 排序状态
        let dateSortState = 'desc'; // 'none', 'asc', 'desc' - 默认按日期降序
        let sellAmountSortState = 'none'; // 'none', 'asc', 'desc'
        
        // 筛选状态
        let currentCustomerFilter = ''; // 当前筛选的下单人
        let currentProductFilter = ''; // 当前筛选的产品
        
        // DOM元素
        const tableBody = document.getElementById('table-body');
        const addBtn = document.getElementById('add-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const fileInput = document.getElementById('file-input');
        const saveBtn = document.getElementById('save-btn');
        const calculatorBtn = document.getElementById('calculator-btn');
        const totalProfitElement = document.getElementById('total-profit');
        const totalCountElement = document.getElementById('total-count');
        const toast = document.getElementById('toast');
        const dateHeader = document.getElementById('date-header');
        const dateSortIndicator = document.getElementById('date-sort');
        const sellAmountHeader = document.getElementById('sell-amount-header');
        const sellAmountSortIndicator = document.getElementById('sell-amount-sort');
        const filterStatusText = document.getElementById('filter-status-text');
        
        // 筛选相关DOM元素
        const customerFilter = document.getElementById('customer-filter');
        const productFilter = document.getElementById('product-filter');
        const clearFilterBtn = document.getElementById('clear-filter');
        
        // 计算器相关DOM元素
        const calculator = document.getElementById('calculator');
        const calculatorCurrent = document.getElementById('calculator-current');
        const calculatorHistory = document.getElementById('calculator-history');
        const calculatorClose = document.getElementById('calculator-close');
        const calculatorButtons = document.querySelectorAll('.calculator-btn');
        
        // 计算器状态
        let calculatorDisplayValue = '0';
        let calculatorHistoryValue = '';
        let firstOperand = null;
        let operator = null;
        let waitingForSecondOperand = false;
        let shouldResetDisplay = false;
        
        // 显示提示消息
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // 格式化日期为月-日
        function formatDateToMonthDay(dateString) {
            if (!dateString || dateString === 'undefined') return '点击设置';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}-${day}`;
        }
        
        // 计算单行利润
        function calculateProfit(sellAmount, orderAmount, refund, shipping) {
            const sell = parseFloat(sellAmount) || 0;
            const order = parseFloat(orderAmount) || 0;
            const ref = parseFloat(refund) || 0;
            const ship = parseFloat(shipping) || 0;
            
            return sell - order - ref - ship;
        }
        
        // 格式化货币
        function formatCurrency(amount) {
            return '¥' + parseFloat(amount || 0).toFixed(2);
        }
        
        // 计算并更新总利润
        function updateTotalProfit() {
            let totalProfit = 0;
            const filteredOrders = getFilteredOrders();
            
            filteredOrders.forEach(order => {
                const profit = calculateProfit(
                    order.sellAmount, 
                    order.orderAmount, 
                    order.refund, 
                    order.shipping
                );
                totalProfit += profit;
            });
            
            totalProfitElement.textContent = `总利润: ${formatCurrency(totalProfit)}`;
            totalProfitElement.className = `total-profit ${totalProfit >= 0 ? 'profit-positive' : 'profit-negative'}`;
            totalCountElement.textContent = filteredOrders.length;
        }
        
        // 获取筛选后的订单
        function getFilteredOrders() {
            return orders.filter(order => {
                // 检查下单人筛选
                const customerMatch = !currentCustomerFilter || order.customer === currentCustomerFilter;
                // 检查产品筛选
                const productMatch = !currentProductFilter || order.product === currentProductFilter;
                
                return customerMatch && productMatch;
            });
        }
        
        // 根据排序状态排序订单
        function sortOrders(ordersToSort) {
            if (dateSortState === 'none' && sellAmountSortState === 'none') {
                return ordersToSort;
            }
            
            // 创建副本进行排序
            const sortedOrders = [...ordersToSort];
            
            sortedOrders.sort((a, b) => {
                // 优先按日期排序
                if (dateSortState !== 'none') {
                    const aDate = new Date(a.date || '1970-01-01').getTime();
                    const bDate = new Date(b.date || '1970-01-01').getTime();
                    
                    if (aDate !== bDate) {
                        return dateSortState === 'desc' ? bDate - aDate : aDate - bDate;
                    }
                }
                
                // 如果日期相同，再按售出金额排序
                if (sellAmountSortState !== 'none') {
                    const aAmount = parseFloat(a.sellAmount) || 0;
                    const bAmount = parseFloat(b.sellAmount) || 0;
                    
                    if (aAmount !== bAmount) {
                        return sellAmountSortState === 'desc' ? bAmount - aAmount : aAmount - bAmount;
                    }
                }
                
                return 0;
            });
            
            return sortedOrders;
        }
        
        // 更新排序指示器
        function updateSortIndicators() {
            // 更新日期排序指示器
            switch(dateSortState) {
                case 'none':
                    dateSortIndicator.textContent = '↕';
                    break;
                case 'asc':
                    dateSortIndicator.textContent = '↑';
                    break;
                case 'desc':
                    dateSortIndicator.textContent = '↓';
                    break;
            }
            
            // 更新售出金额排序指示器
            switch(sellAmountSortState) {
                case 'none':
                    sellAmountSortIndicator.textContent = '↕';
                    break;
                case 'asc':
                    sellAmountSortIndicator.textContent = '↑';
                    break;
                case 'desc':
                    sellAmountSortIndicator.textContent = '↓';
                    break;
            }
        }
        
        // 切换日期排序状态
        function toggleDateSort() {
            const states = ['desc', 'asc', 'none'];
            const currentIndex = states.indexOf(dateSortState);
            dateSortState = states[(currentIndex + 1) % states.length];
            
            // 如果启用了日期排序，则禁用售出金额排序
            if (dateSortState !== 'none') {
                sellAmountSortState = 'none';
            }
            
            updateSortIndicators();
            renderTable();
            updateTotalProfit();
            showToast(`已按日期${dateSortState === 'none' ? '取消排序' : dateSortState === 'asc' ? '升序排序' : '降序排序'}`);
        }
        
        // 切换售出金额排序状态
        function toggleSellAmountSort() {
            const states = ['none', 'asc', 'desc'];
            const currentIndex = states.indexOf(sellAmountSortState);
            sellAmountSortState = states[(currentIndex + 1) % states.length];
            
            // 如果启用了售出金额排序，则禁用日期排序
            if (sellAmountSortState !== 'none') {
                dateSortState = 'none';
            }
            
            updateSortIndicators();
            renderTable();
            showToast(`已按售出金额${sellAmountSortState === 'none' ? '取消排序' : sellAmountSortState === 'asc' ? '升序排序' : '降序排序'}`);
        }
        
        // 创建表格行
        function createTableRow(order, index) {
            const row = document.createElement('tr');
            const profit = calculateProfit(order.sellAmount, order.orderAmount, order.refund, order.shipping);
            
            // 处理日期显示
            const dateDisplay = isDateFullFormat[index] ? order.date : formatDateToMonthDay(order.date);
            
            row.innerHTML = `
                <td class="date-cell" data-index="${index}" data-full-date="${order.date || ''}">${dateDisplay}</td>
                <td><input type="text" class="editable" data-field="customer" value="${order.customer || ''}"></td>
                <td><input type="text" class="editable" data-field="product" value="${order.product || ''}"></td>
                <td><input type="number" step="0.01" class="editable" data-field="orderAmount" value="${order.orderAmount || '0'}"></td>
                <td><input type="number" step="0.01" class="editable" data-field="refund" value="${order.refund || '0'}"></td>
                <td><input type="number" step="0.01" class="editable" data-field="shipping" value="${order.shipping || '0'}"></td>
                <td><input type="number" step="0.01" class="editable" data-field="sellAmount" value="${order.sellAmount || '0'}"></td>
                <td class="profit-cell" style="color: ${profit >= 0 ? '#2ecc71' : '#e74c3c'}">${formatCurrency(profit)}</td>
                <td><input type="text" class="editable" data-field="trackingNumber" value="${order.trackingNumber || ''}"></td>
                <td>
                    <div style="display:flex;align-items:center;gap:4px;">
                        <input type="text" class="editable note-input" data-field="notes" value="${order.notes || ''}">
                        <button type="button" class="scan-btn" title="扫码填入备注">📷</button>
                    </div>
                </td>
                <td><button class="delete-btn" data-index="${index}"><i class="fas fa-trash"></i> 删除</button></td>
            `;
            
            return row;
        }
        
        // 更新筛选状态显示
        function updateFilterStatus() {
            const filteredOrders = getFilteredOrders();
            let statusText = '';
            
            if (currentCustomerFilter && currentProductFilter) {
                statusText = `筛选: 下单人=${currentCustomerFilter}, 产品=${currentProductFilter} (${filteredOrders.length} 条记录)`;
            } else if (currentCustomerFilter) {
                statusText = `筛选: 下单人=${currentCustomerFilter} (${filteredOrders.length} 条记录)`;
            } else if (currentProductFilter) {
                statusText = `筛选: 产品=${currentProductFilter} (${filteredOrders.length} 条记录)`;
            } else {
                statusText = `显示全部订单 (${filteredOrders.length} 条记录)`;
            }
            
            filterStatusText.textContent = statusText;
            filterStatusText.style.color = (currentCustomerFilter || currentProductFilter) ? '#3498db' : '#bdc3c7';
        }
        
        // 更新筛选器选项
        function updateFilterOptions() {
            // 获取所有不重复的下单人
            const customers = [...new Set(orders.map(order => order.customer).filter(c => c))];
            // 获取所有不重复的产品
            const products = [...new Set(orders.map(order => order.product).filter(p => p))];
            
            // 清空现有选项（保留"全部下单人"选项）
            const currentCustomerValue = customerFilter.value;
            customerFilter.innerHTML = '<option value="">全部下单人</option>';
            
            // 添加下单人选项
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer;
                option.textContent = customer;
                customerFilter.appendChild(option);
            });
            
            // 恢复当前选中的值
            customerFilter.value = currentCustomerValue;
            
            // 清空现有选项（保留"全部产品"选项）
            const currentProductValue = productFilter.value;
            productFilter.innerHTML = '<option value="">全部产品</option>';
            
            // 添加产品选项
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productFilter.appendChild(option);
            });
            
            // 恢复当前选中的值
            productFilter.value = currentProductValue;
        }
        
        // 应用筛选
        function applyFilter() {
            currentCustomerFilter = customerFilter.value;
            currentProductFilter = productFilter.value;
            renderTable();
            updateFilterStatus();
            
            if (currentCustomerFilter || currentProductFilter) {
                let message = '已筛选: ';
                if (currentCustomerFilter) message += `下单人=${currentCustomerFilter}`;
                if (currentCustomerFilter && currentProductFilter) message += ', ';
                if (currentProductFilter) message += `产品=${currentProductFilter}`;
                showToast(message);
            } else {
                showToast('已显示全部订单');
            }
        }
        
        // 清除筛选
        function clearFilter() {
            customerFilter.value = '';
            productFilter.value = '';
            currentCustomerFilter = '';
            currentProductFilter = '';
            renderTable();
            updateFilterStatus();
            showToast('筛选已清除，显示全部订单');
        }
        
        // 渲染表格
        function renderTable() {
            tableBody.innerHTML = '';
            
            const filteredOrders = getFilteredOrders();
            
            if (filteredOrders.length === 0) {
                const emptyRow = document.createElement('tr');
                let message = '';
                
                if (currentCustomerFilter && currentProductFilter) {
                    message = `没有找到下单人为"${currentCustomerFilter}"且产品为"${currentProductFilter}"的订单记录`;
                } else if (currentCustomerFilter) {
                    message = `没有找到下单人为"${currentCustomerFilter}"的订单记录`;
                } else if (currentProductFilter) {
                    message = `没有找到产品为"${currentProductFilter}"的订单记录`;
                } else {
                    message = '暂无订单数据，点击上方"新增"按钮添加第一条订单记录';
                }
                
                emptyRow.innerHTML = `<td colspan="11" style="text-align: center; padding: 20px; color: #7f8c8d;">${message}</td>`;
                tableBody.appendChild(emptyRow);
                return;
            }
            
            // 根据排序状态获取订单列表
            const ordersToRender = sortOrders(filteredOrders);
            
            // 渲染订单行
            ordersToRender.forEach((order, index) => {
                // 获取原始索引
                const originalIndex = orders.indexOf(order);
                const row = createTableRow(order, originalIndex);
                tableBody.appendChild(row);
            });
            
            // 重新绑定事件
            bindEvents();
            
            // 更新总利润
            updateTotalProfit();
            
            // 更新筛选状态
            updateFilterStatus();
        }
        
        // 添加新行
        function addNewRow() {
            const newOrder = {
                date: new Date().toISOString().split('T')[0],
                customer: '',
                product: '',
                orderAmount: '0',
                refund: '0',
                shipping: '0',
                sellAmount: '0',
                trackingNumber: '',
                notes: ''
            };
            
            // 新订单添加到数组开头
            orders.unshift(newOrder);
            
            
            // 立即持久化（避免新增空行在云快照/刷新后丢失）
            try{ localStorage.setItem('orderProfitData', JSON.stringify(orders)); }catch(e){}
// 确保按日期降序排序
            dateSortState = 'desc';
            sellAmountSortState = 'none';
            
            // 更新筛选器选项
            updateFilterOptions();
            
            // 重新渲染表格
            renderTable();
            
            showToast('已添加新订单行，请编辑信息');
        }
        
        // 删除行
        function deleteRow(index) {
            if (confirm('确定要删除这条订单记录吗？')) {
                // 从数组中删除
                const deletedCustomer = orders[index].customer;
                const deletedProduct = orders[index].product;
                orders.splice(index, 1);
                
                // 更新筛选器选项
                updateFilterOptions();
                
                // 如果删除的是当前筛选的下单人或产品，检查是否需要清除筛选
                if (currentCustomerFilter === deletedCustomer || currentProductFilter === deletedProduct) {
                    // 重新渲染表格，筛选器会自动处理
                    renderTable();
                } else {
                    renderTable();
                }
                
                showToast('订单已删除');
            }
        }
        
        // 保存数据到本地存储 - 修复：始终保存全部数据
        function saveData() {
            try {
                // 从表格中获取最新数据（只更新显示的行）
                updateOrdersFromTable();
                
                // 保存全部订单数据到本地存储
                localStorage.setItem('orderProfitData', JSON.stringify(orders));
                showToast('数据已成功保存到本地存储（保存全部数据）');
            } catch (error) {
                console.error('保存数据时出错:', error);
                showToast('保存失败: ' + error.message);
            }
        }
        
        // 从表格中更新订单数据 - 修复：只更新显示的行，不替换整个orders数组
        function updateOrdersFromTable() {
            const rows = tableBody.querySelectorAll('tr');
            
            // 遍历所有行
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                
                // 跳过空行提示
                if (row.cells.length <= 1) continue;
                
                const inputs = row.querySelectorAll('input');
                if (inputs.length === 0) continue;
                
                // 获取行的原始索引
                const dateCell = row.querySelector('.date-cell');
                const indexAttr = dateCell ? dateCell.getAttribute('data-index') : null;
                
                if (indexAttr === null || indexAttr === undefined) continue;
                
                const index = parseInt(indexAttr);
                
                // 如果索引有效，更新对应的订单数据
                if (index >= 0 && index < orders.length) {
                    // 获取日期
                    const dateValue = dateCell ? dateCell.getAttribute('data-full-date') : '';
                    
                    // 更新订单数据
                    orders[index].date = dateValue || new Date().toISOString().split('T')[0];
                    orders[index].customer = inputs[0] ? inputs[0].value : '';
                    orders[index].product = inputs[1] ? inputs[1].value : '';
                    orders[index].orderAmount = inputs[2] ? inputs[2].value : '0';
                    orders[index].refund = inputs[3] ? inputs[3].value : '0';
                    orders[index].shipping = inputs[4] ? inputs[4].value : '0';
                    orders[index].sellAmount = inputs[5] ? inputs[5].value : '0';
                    orders[index].trackingNumber = inputs[6] ? inputs[6].value : '';
                    orders[index].notes = inputs[7] ? inputs[7].value : '';
                }
            }
            
            // 更新筛选器选项
            updateFilterOptions();
        }
        
        // 导出为Excel - 修复：导出全部数据，不仅仅是筛选后的数据
        function exportToExcel() {
            try {
                // 首先更新表格中的数据到orders数组
                updateOrdersFromTable();
                
                // 准备导出数据 - 导出全部数据
                const exportData = orders.map(order => {
                    const profit = calculateProfit(
                        order.sellAmount, 
                        order.orderAmount, 
                        order.refund, 
                        order.shipping
                    );
                    
                    return {
                        '日期': order.date,
                        '下单人': order.customer,
                        '产品': order.product,
                        '下单金额': parseFloat(order.orderAmount) || 0,
                        '返款': parseFloat(order.refund) || 0,
                        '运费': parseFloat(order.shipping) || 0,
                        '售出金额': parseFloat(order.sellAmount) || 0,
                        '利润': profit,
                        '物流单号': order.trackingNumber,
                        '备注': order.notes
                    };
                });
                
                // 添加汇总行
                const totalProfit = exportData.reduce((sum, row) => sum + row.利润, 0);
                exportData.push({
                    '日期': '汇总',
                    '下单人': '',
                    '产品': '',
                    '下单金额': '',
                    '返款': '',
                    '运费': '',
                    '售出金额': '总计',
                    '利润': totalProfit,
                    '物流单号': '',
                    '备注': ''
                });
                
                // 创建工作簿和工作表
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, '订单利润数据');
                
                // 设置列宽
                const wscols = [
                    {wch: 12}, // 日期
                    {wch: 10}, // 下单人
                    {wch: 20}, // 产品
                    {wch: 10}, // 下单金额
                    {wch: 10}, // 返款
                    {wch: 10}, // 运费
                    {wch: 10}, // 售出金额
                    {wch: 10}, // 利润
                    {wch: 20}, // 物流单号
                    {wch: 30}  // 备注
                ];
                worksheet['!cols'] = wscols;
                
                // 生成文件名
                const dateStr = new Date().toISOString().split('T')[0];
                const filename = `订单利润数据_${dateStr}.xlsx`;
                
                // 导出文件
                XLSX.writeFile(workbook, filename);
                showToast('数据已导出为Excel文件（导出全部数据）');
            } catch (error) {
                console.error('导出Excel时出错:', error);
                showToast('导出失败: ' + error.message);
            }
        }
        
        // 从Excel导入
        function importFromExcel(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // 转换数据格式
                    const importedOrders = jsonData
                        .filter(row => row['日期'] && row['日期'] !== '汇总')
                        .map(row => ({
                            date: row['日期'] instanceof Date ? 
                                  row['日期'].toISOString().split('T')[0] : 
                                  String(row['日期'] || ''),
                            customer: String(row['下单人'] || ''),
                            product: String(row['产品'] || ''),
                            orderAmount: String(row['下单金额'] || '0'),
                            refund: String(row['返款'] || '0'),
                            shipping: String(row['运费'] || '0'),
                            sellAmount: String(row['售出金额'] || '0'),
                            trackingNumber: String(row['物流单号'] || ''),
                            notes: String(row['备注'] || '')
                        }));
                    
                    if (importedOrders.length === 0) {
                        showToast('Excel文件中没有找到有效的订单数据');
                        return;
                    }
                    
                    // 确认导入
                    if (confirm(`从Excel文件中找到 ${importedOrders.length} 条订单记录，是否导入？`)) {
                        orders = importedOrders;
                        // 重置排序状态为日期降序
                        dateSortState = 'desc';
                        sellAmountSortState = 'none';
                        updateSortIndicators();
                        // 更新筛选器选项
                        updateFilterOptions();
                        renderTable();
                        showToast(`成功导入 ${importedOrders.length} 条订单记录`);
                    }
                } catch (error) {
                    console.error('导入Excel时出错:', error);
                    showToast('导入失败: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 绑定事件
        function bindEvents() {
            // 绑定输入框变化事件
            const inputs = tableBody.querySelectorAll('input');
            inputs.forEach(input => {
                // 移除之前的事件监听器
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
                
                newInput.addEventListener('change', function() {
                    const row = this.closest('tr');
                    const indexAttr = row.querySelector('.date-cell')?.getAttribute('data-index');
                    
                    if (indexAttr === null || indexAttr === undefined) return;
                    
                    const index = parseInt(indexAttr);
                    const field = this.getAttribute('data-field');
                    
                    // 更新数据
                    if (index >= 0 && index < orders.length) {
                        orders[index][field] = this.value;
                        
                        // 如果是下单人或产品字段发生变化，更新筛选器选项
                        if (field === 'customer' || field === 'product') {
                            updateFilterOptions();
                        }
                        
                        // 重新计算利润
                        const profitCell = row.querySelector('.profit-cell');
                        if (profitCell) {
                            const profit = calculateProfit(
                                orders[index].sellAmount,
                                orders[index].orderAmount,
                                orders[index].refund,
                                orders[index].shipping
                            );
                            
                            profitCell.textContent = formatCurrency(profit);
                            profitCell.style.color = profit >= 0 ? '#2ecc71' : '#e74c3c';
                            
                            // 更新总利润
                            updateTotalProfit();
                        }
                    }
                });
                
                // 实时计算
                newInput.addEventListener('input', function() {
                    if (this.hasAttribute('data-field')) {
                        const row = this.closest('tr');
                        const field = this.getAttribute('data-field');
                        
                        if (field === 'orderAmount' || field === 'refund' || 
                            field === 'shipping' || field === 'sellAmount') {
                            
                            const orderAmountInput = row.querySelector('input[data-field="orderAmount"]');
                            const refundInput = row.querySelector('input[data-field="refund"]');
                            const shippingInput = row.querySelector('input[data-field="shipping"]');
                            const sellAmountInput = row.querySelector('input[data-field="sellAmount"]');
                            
                            if (!orderAmountInput || !refundInput || !shippingInput || !sellAmountInput) return;
                            
                            const orderAmount = parseFloat(orderAmountInput.value) || 0;
                            const refund = parseFloat(refundInput.value) || 0;
                            const shipping = parseFloat(shippingInput.value) || 0;
                            const sellAmount = parseFloat(sellAmountInput.value) || 0;
                            
                            const profit = sellAmount - orderAmount - refund - shipping;
                            const profitCell = row.querySelector('.profit-cell');
                            
                            if (profitCell) {
                                profitCell.textContent = formatCurrency(profit);
                                profitCell.style.color = profit >= 0 ? '#2ecc71' : '#e74c3c';
                                
                                // 更新总利润
                                updateTotalProfit();
                            }
                        }
                    }
                });
            });
            
            // 绑定日期单元格点击事件
            const dateCells = tableBody.querySelectorAll('.date-cell');
            dateCells.forEach(cell => {
                // 移除之前的事件监听器
                const newCell = cell.cloneNode(true);
                cell.parentNode.replaceChild(newCell, cell);
                
                newCell.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    const fullDate = this.getAttribute('data-full-date');
                    
                    if (!fullDate || fullDate === 'undefined' || fullDate === '') {
                        // 如果没有日期，设置为今天
                        const today = new Date().toISOString().split('T')[0];
                        this.setAttribute('data-full-date', today);
                        this.textContent = formatDateToMonthDay(today);
                        
                        // 更新数据
                        const rowIndex = parseInt(index);
                        if (rowIndex >= 0 && rowIndex < orders.length) {
                            orders[rowIndex].date = today;
                        }
                        return;
                    }
                    
                    if (isDateFullFormat[index]) {
                        // 切换到简略格式
                        this.textContent = formatDateToMonthDay(fullDate);
                        isDateFullFormat[index] = false;
                    } else {
                        // 切换到完整格式
                        const date = new Date(fullDate);
                        if (!isNaN(date.getTime())) {
                            this.textContent = date.toLocaleDateString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            });
                        } else {
                            this.textContent = fullDate;
                        }
                        isDateFullFormat[index] = true;
                    }
                });
            });
            
            // 绑定删除按钮事件
            const deleteButtons = tableBody.querySelectorAll('.delete-btn');
            deleteButtons.forEach(button => {
                // 移除之前的事件监听器
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                newButton.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteRow(index);
                });
            });
        }
        
        // 计算器功能
        function initCalculator() {
            // 显示计算器
            calculatorBtn.addEventListener('click', function() {
                calculator.style.display = 'block';
            });
            
            // 关闭计算器
            calculatorClose.addEventListener('click', function() {
                calculator.style.display = 'none';
            });
            
            // 计算器按钮点击事件
            calculatorButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    const number = this.getAttribute('data-number');
                    
                    if (number !== null) {
                        inputNumber(number);
                    } else if (action !== null) {
                        handleAction(action);
                    }
                    
                    // 更新显示
                    updateCalculatorDisplay();
                });
            });
            
            // 输入数字
            function inputNumber(number) {
                if (waitingForSecondOperand) {
                    calculatorDisplayValue = number;
                    waitingForSecondOperand = false;
                } else {
                    calculatorDisplayValue = calculatorDisplayValue === '0' ? number : calculatorDisplayValue + number;
                }
                
                // 更新历史显示
                if (operator !== null && firstOperand !== null && !waitingForSecondOperand) {
                    calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)} ${calculatorDisplayValue}`;
                } else if (operator !== null && firstOperand !== null && waitingForSecondOperand) {
                    calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)}`;
                } else {
                    calculatorHistoryValue = '';
                }
            }
            
            // 处理操作符
            function handleAction(action) {
                switch (action) {
                    case 'clear':
                        // 完全清除
                        calculatorDisplayValue = '0';
                        calculatorHistoryValue = '';
                        firstOperand = null;
                        operator = null;
                        waitingForSecondOperand = false;
                        shouldResetDisplay = false;
                        break;
                    case 'clear-entry':
                        // 清除当前输入
                        calculatorDisplayValue = '0';
                        if (operator !== null && firstOperand !== null) {
                            calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)}`;
                        } else {
                            calculatorHistoryValue = '';
                        }
                        break;
                    case 'decimal':
                        if (!calculatorDisplayValue.includes('.')) {
                            calculatorDisplayValue += '.';
                        }
                        break;
                    case 'percent':
                        const currentValue = parseFloat(calculatorDisplayValue);
                        calculatorDisplayValue = (currentValue / 100).toString();
                        calculatorHistoryValue = `${currentValue}% =`;
                        break;
                    case 'add':
                    case 'subtract':
                    case 'multiply':
                    case 'divide':
                        handleOperator(action);
                        break;
                    case 'equals':
                        if (operator && firstOperand !== null) {
                            const secondOperand = parseFloat(calculatorDisplayValue);
                            const result = calculate(firstOperand, secondOperand, operator);
                            
                            // 确保结果是精确的，避免浮点数精度问题
                            const preciseResult = Math.round(result * 1000000) / 1000000;
                            
                            // 显示完整计算过程
                            calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)} ${secondOperand} =`;
                            calculatorDisplayValue = preciseResult.toString();
                            
                            // 重置状态，但保留结果作为下一次计算的第一个操作数
                            firstOperand = preciseResult;
                            waitingForSecondOperand = true;
                            shouldResetDisplay = true;
                        }
                        break;
                }
            }
            
            // 处理运算符
            function handleOperator(nextOperator) {
                const inputValue = parseFloat(calculatorDisplayValue);
                
                if (operator !== null && !waitingForSecondOperand) {
                    // 如果已经有操作符和第一个操作数，并且已经输入了第二个操作数，先计算
                    const result = calculate(firstOperand, inputValue, operator);
                    const preciseResult = Math.round(result * 1000000) / 1000000;
                    calculatorDisplayValue = preciseResult.toString();
                    firstOperand = preciseResult;
                } else {
                    // 否则设置第一个操作数
                    firstOperand = inputValue;
                }
                
                operator = nextOperator;
                waitingForSecondOperand = true;
                shouldResetDisplay = true;
                
                // 更新历史显示
                calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)}`;
            }
            
            // 执行计算
            function calculate(first, second, operator) {
                switch (operator) {
                    case 'add': return first + second;
                    case 'subtract': return first - second;
                    case 'multiply': return first * second;
                    case 'divide': return first / second;
                    default: return second;
                }
            }
            
            // 获取操作符符号
            function getOperatorSymbol(op) {
                switch (op) {
                    case 'add': return '+';
                    case 'subtract': return '-';
                    case 'multiply': return '×';
                    case 'divide': return '÷';
                    default: return '';
                }
            }
            
            // 格式化显示数字
            function formatDisplayNumber(numStr) {
                const num = parseFloat(numStr);
                if (isNaN(num)) return '0';
                
                // 如果是整数，不显示小数点
                if (Number.isInteger(num)) {
                    return num.toString();
                }
                
                // 否则显示最多6位小数
                return num.toFixed(6).replace(/\.?0+$/, '');
            }
            
            // 更新计算器显示
            function updateCalculatorDisplay() {
                calculatorCurrent.textContent = formatDisplayNumber(calculatorDisplayValue);
                calculatorHistory.textContent = calculatorHistoryValue;
            }
        }
        
        // 初始化事件监听
        function initEventListeners() {
            addBtn.addEventListener('click', addNewRow);
            exportBtn.addEventListener('click', exportToExcel);
            importBtn.addEventListener('click', () => fileInput.click());
            saveBtn.addEventListener('click', saveData);
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    importFromExcel(this.files[0]);
                    this.value = ''; // 重置文件输入
                }
            });
            
            // 绑定排序事件
            dateHeader.addEventListener('click', toggleDateSort);
            sellAmountHeader.addEventListener('click', toggleSellAmountSort);
            
            // 绑定筛选事件
            customerFilter.addEventListener('change', applyFilter);
            productFilter.addEventListener('change', applyFilter);
            clearFilterBtn.addEventListener('click', clearFilter);
            
            // 初始化计算器
            initCalculator();
        }
        
        // 初始化应用
        function initApp() {
            // 更新筛选器选项
            updateFilterOptions();
            
            renderTable();
            initEventListeners();
            updateSortIndicators();
            
            // 检查是否有已保存的数据
            if (orders.length > 0) {
                showToast(`已加载 ${orders.length} 条订单记录，默认按日期降序排列`);
            } else {
                showToast('欢迎使用订单利润管理系统，点击"新增"按钮开始添加订单');
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initApp);
        
        // 监听页面离开前保存数据
        
        /* ========= 备注扫码功能 ========= */
        let currentScanTargetInput = null;
        let html5QrCode = null;

        const scannerModal = document.createElement('div');
        scannerModal.style.cssText = `
        position:fixed;inset:0;background:rgba(0,0,0,.6);
        display:none;align-items:center;justify-content:center;z-index:9999;
        `;
        scannerModal.innerHTML = `
        <div style="background:#fff;width:90%;max-width:420px;border-radius:10px;padding:10px;">
            <div style="text-align:right;color:#e74c3c;font-size:14px;cursor:pointer;" id="closeScannerBtn">关闭 ✖</div>
            <div id="reader" style="width:100%;"></div>
        </div>
        `;
        document.body.appendChild(scannerModal);

        function openScanner(inputEl){
            currentScanTargetInput = inputEl;
            scannerModal.style.display = 'flex';

            html5QrCode = new Html5Qrcode("reader");
            // 仅用于：扫描条形码/二维码，然后写入「备注」输入框（本地数据优先，不触碰其它字段）
            let _formatsToSupport = undefined;
            try {
                if (typeof Html5QrcodeSupportedFormats !== "undefined") {
                    _formatsToSupport = [
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.CODE_39,
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E,
                        Html5QrcodeSupportedFormats.ITF,
                        Html5QrcodeSupportedFormats.QR_CODE,
                    ].filter(Boolean);
                }
            } catch(e) {}
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 280, aspectRatio: 1.7778, disableFlip: false, formatsToSupport: _formatsToSupport },
                decodedText => {
                    currentScanTargetInput.value = decodedText;
                    currentScanTargetInput.dispatchEvent(new Event('change'));
                    closeScanner();
                }
            ).catch(err=>{
                showToast("摄像头启动失败，请检查浏览器权限");
                closeScanner();
            });
        }

        function closeScanner(){
            scannerModal.style.display = 'none';
            if(html5QrCode){
                html5QrCode.stop().then(()=>html5QrCode.clear());
                html5QrCode = null;
            }
        }

        document.addEventListener('click', function(e){
            if(e.target && e.target.classList.contains('scan-btn')){
                const input = e.target.closest('td').querySelector('.note-input');
                if(input) openScanner(input);
            }
            if(e.target && e.target.id === 'closeScannerBtn'){
                closeScanner();
            }
        });

        window.addEventListener('beforeunload', function() {
            updateOrdersFromTable();
            localStorage.setItem('orderProfitData', JSON.stringify(orders));
        });
    </script>

<style>
.cloud-addon-panel{position:fixed;right:20px;bottom:20px;z-index:2147483647;font-family:sans-serif}
.cloud-addon-toggle{width:56px;height:56px;border-radius:16px;background:#111827;color:#fff;
display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer}
.cloud-addon-card{position:fixed;right:20px;bottom:90px;width:260px;background:#fff;
border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.25);padding:10px;display:none}
.cloud-addon-card button{width:100%;margin:6px 0;padding:10px;border-radius:12px;
border:1px solid #e5e7eb;background:#f9fafb;font-weight:700;cursor:pointer}

/* 登录盒子（更美观） */
.login-box{margin-top:8px;padding:10px;border:1px solid #e5e7eb;border-radius:14px;background:#f8fafc}
.login-title{font-weight:800;font-size:14px;margin-bottom:8px;color:#111827}
.login-field{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
.login-field label{font-size:12px;color:#6b7280}
.login-field input{height:36px;border-radius:10px;border:1px solid #e5e7eb;padding:0 10px;font-size:14px;outline:none;background:#fff}
.login-field input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(147,197,253,.35)}
.login-actions{display:flex;gap:8px;margin-top:6px}
.login-actions button{flex:1;height:34px;border-radius:10px;font-weight:800;cursor:pointer}
.login-btn-primary{
  background:#fff;
  color:#111827;
  border:1px solid rgba(17,24,39,.25);
}
.login-btn-ghost{background:#fff;color:#111827;border:1px solid #e5e7eb}
.login-msg{margin-top:8px;font-size:12px;color:#b91c1c;line-height:1.4}

/* 管理员三件套：小尺寸横排 */
#adminTools{margin-top:10px !important;}
#adminPanel .admin-action-row, .admin-action-row{display:flex;gap:8px;flex-wrap:nowrap;align-items:center}
#adminPanel .admin-action-row .admin-btn, .admin-action-row .admin-btn{
  flex:1;height:36px;padding:0 8px;font-size:14px;border-radius:10px;white-space:nowrap;margin:0 !important;
}
.admin-btn-create{background:#1f2937;color:#fff;border:0}
.admin-btn-reset{background:#b91c1c;color:#fff;border:0}
.admin-btn-delete{background:#fff;color:#b91c1c;border:1px solid #b91c1c}

/* 面板里的按钮整体更紧凑一点 */
.cloud-addon-card{width:280px;}
.cloud-addon-card button{padding:9px 10px;font-size:14px;border-radius:12px}
</style>

<div id="loginBackdrop"></div>
<div class="cloud-addon-panel">
  <div class="cloud-addon-card" id="addon-card">
    <button id="btnCloudLogin">🔐 登录</button>
    <div id="loginBox" class="login-box" style="display:none">
      <div class="login-title">登录云端</div>

    <div class="login-contact">
      <span class="login-contact-label">联系管理员vx：</span>
      <button type="button" class="login-contact-copy" id="copyAdminVxBtn" data-copy="pinking0000">pinking0000（点我复制）</button>
    </div>
    
      <div class="login-field">
        <label>邮箱</label>
        <input id="loginEmail" type="email" placeholder="例如：123456@qq.com" autocomplete="username" />
      </div>
      <div class="login-field">
        <label>密码</label>
        <input id="loginPassword" type="password" placeholder="请输入密码" autocomplete="current-password" />
      </div>
      <div class="login-actions">
        <button id="loginSubmit" class="login-btn-primary">登录</button>
        <button id="loginCancel" class="login-btn-ghost">取消</button>
      </div>
      <div id="loginMsg" class="login-msg" style="display:none"></div>
    </div>
    <button id="btnCloudLogout">🚪 退出</button>
    <button id="btnCloudSave">⬆️ 保存到云端</button>
    <button id="btnCloudLoad">⬇️ 从云端拉取</button>
    <button id="btnCloudAdmin" style="display:none">👤 管理员</button>

    <div class="admin-box" id="adminBox" style="display:none;margin-top:8px;border-top:1px solid #e5e7eb;padding-top:8px">
      <div style="font-weight:700;margin-bottom:6px">管理员面板（仅管理员邮箱可见）</div>
      <div style="font-size:12px;color:#555;margin-bottom:8px">
        这里控制“是否允许登录”。被禁用的账号登录后会立刻被退出，并提示“账号已被管理员禁用”。
      </div>
      <div class="am-row" style="margin-top:0">
        <button id="adminRefresh">刷新用户列表</button>
      </div>

      <div id="adminTools" style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
        <div class="admin-action-row">
  <button id="adminCreateUserBtn" class="admin-btn admin-btn-create">新建账号</button>
  <button id="adminResetPwdBtn" class="admin-btn admin-btn-reset">重置密码</button>
  <button id="adminDeleteUserBtn" class="admin-btn admin-btn-delete">删除账号</button>
</div>
      </div>

      <div style="overflow:auto;max-height:220px;margin-top:8px">
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr><th style="text-align:left;padding:6px 4px;border-bottom:1px solid #eee">邮箱</th><th style="text-align:left;padding:6px 4px;border-bottom:1px solid #eee">允许登录</th><th style="text-align:left;padding:6px 4px;border-bottom:1px solid #eee">创建时间</th></tr>
          </thead>
          <tbody id="adminTbody"></tbody>
        </table>
      </div>

      <details style="margin-top:10px">
        <summary style="cursor:pointer;font-size:12px;color:#555">如果列表为空/报错：点这里复制一次初始化SQL（在Supabase的SQL Editor运行）</summary>
        <textarea class="sqlbox" readonly id="adminSql" style="width:100%;min-height:140px;margin-top:6px;border-radius:10px;border:1px solid #e5e7eb;padding:8px;font-size:12px"></textarea>
      </details>
    </div>
  </div>
  <div class="cloud-addon-toggle" id="addon-toggle">菜单</div>
</div>

<script>
(function(){
 const t=document.getElementById('addon-toggle');
 const c=document.getElementById('addon-card');
 t.onclick=function(){ c.style.display = (c.style.display==='block')?'none':'block'; };
})();
</script>


<script>
/* ======== 权限门禁：登录后才能 增加 / 导入 / 导出（Step 2） ======== */
(function(){
  // 单一真相源：登录态（Step2 仅UI权限，不触碰数据/云端）
  window.__isLoggedIn = false;

  function toast(msg){
    try{ if(typeof showToast==='function') showToast(msg); else alert(msg); }
    catch(e){ alert(msg); }
  }

  // 根据按钮文字匹配“写操作”
  const WRITE_KEYWORDS = ['增加','新增','导入','导出'];

  function isWriteButton(btn){
    const t = (btn.innerText || btn.textContent || '').trim();
    return WRITE_KEYWORDS.some(k => t.includes(k));
  }

  function applyGate(){
    const buttons = Array.from(document.querySelectorAll('button'));
    buttons.forEach(btn=>{
      if(!isWriteButton(btn)) return;

      // 视觉态
      btn.disabled = !window.__isLoggedIn;
      btn.style.opacity = window.__isLoggedIn ? '1' : '0.55';
      btn.style.cursor  = window.__isLoggedIn ? 'pointer' : 'not-allowed';

      // 点击门禁（兜底）
      btn.addEventListener('click', function(e){
        if(!window.__isLoggedIn){
          e.preventDefault(); e.stopPropagation();
          toast('请先登录后再使用该功能');
          return false;
        }
      }, true); // 捕获阶段，防止被其它监听吞掉
    });
  }

  // 供外挂登录按钮调用（不自动触发任何业务）
  window.__setLoginState = function(v){
    window.__isLoggedIn = !!v;
    try{
      localStorage.setItem("__LOGIN_STATE__", window.__isLoggedIn ? "1" : "0");
      if(window.__isLoggedIn){
        if(window.__currentUserEmail) localStorage.setItem("__LOGIN_EMAIL__", window.__currentUserEmail);
      }else{
        localStorage.removeItem("__LOGIN_EMAIL__");
      }
    }catch(e){}
    applyGate();
  };

  // 初始：未登录
  applyGate();

// 刷新恢复：只读本地标记，不触发任何 Supabase 请求
  try{
    const s = localStorage.getItem("__LOGIN_STATE__");
    const em = (localStorage.getItem("__LOGIN_EMAIL__")||"").trim();
    if(s === "1" && em){
      window.__currentUserEmail = em;
      window.__setLoginState(true);
    }
  }catch(e){}

})();
</script>


<script>
/* ======== 计算器拖动条（稳定合并版：不影响权限/云端） ======== */
(function(){
  const selectors = ['#calculator','#calculator-panel','.calculator','.calc-panel','[data-role="calculator"]'];

  function attach(){
    let panel=null;
    for(const sel of selectors){
      const el=document.querySelector(sel);
      if(el){ panel=el; break; }
    }
    if(!panel) return false;

    panel.style.position='fixed';
    panel.style.zIndex=panel.style.zIndex||'10020';

    if(panel.querySelector('.calc-drag-handle')) return true;

    const handle=document.createElement('div');
    handle.className='calc-drag-handle';
    handle.textContent='⇕ 拖动计算器';
    handle.style.cssText=[
      'height:36px',
      'line-height:36px',
      'background:#2563eb',
      'color:#fff',
      'font-weight:700',
      'text-align:center',
      'cursor:move',
      'user-select:none'
    ].join(';');

    panel.prepend(handle);

    let sx=0,sy=0,ox=0,oy=0,drag=false;

    function start(e){
      drag=true;
      const p=(e.touches&&e.touches[0])||e;
      sx=p.clientX; sy=p.clientY;
      const r=panel.getBoundingClientRect();
      ox=r.left; oy=r.top;
      document.addEventListener('mousemove',move);
      document.addEventListener('mouseup',end);
      document.addEventListener('touchmove',move,{passive:false});
      document.addEventListener('touchend',end);
      e.preventDefault();
    }
    function move(e){
      if(!drag) return;
      const p=(e.touches&&e.touches[0])||e;
      panel.style.left=(ox+p.clientX-sx)+'px';
      panel.style.top =(oy+p.clientY-sy)+'px';
      panel.style.right='auto'; panel.style.bottom='auto';
      e.preventDefault();
    }
    function end(){
      drag=false;
      document.removeEventListener('mousemove',move);
      document.removeEventListener('mouseup',end);
      document.removeEventListener('touchmove',move);
      document.removeEventListener('touchend',end);
    }

    handle.addEventListener('mousedown',start);
    handle.addEventListener('touchstart',start,{passive:false});
    return true;
  }

  let tries=0;
  const timer=setInterval(()=>{
    tries++;
    if(attach()||tries>20) clearInterval(timer);
  },500);
})();
</script>


<script>
/* ======== 官方地基 API：云端快照（修正版：对齐 orders / localStorage / upsert） ======== */
(function(){
  function getClient(){ return window.__supa || null; }
  const LS_KEY = 'orderProfitData';

  function getOrders(){
    try{ return (typeof orders !== 'undefined') ? orders : (JSON.parse(localStorage.getItem(LS_KEY))||[]); }
    catch(e){ return []; }
  }
  function setOrders(next){
    try{
      if(typeof orders !== 'undefined'){ orders = Array.isArray(next) ? next : []; }
      localStorage.setItem(LS_KEY, JSON.stringify(Array.isArray(next)?next:[]));
    }catch(e){}
    try{ if(typeof updateFilterOptions==='function') updateFilterOptions(); }catch(e){}
    try{ if(typeof renderTable==='function') renderTable(); }catch(e){}
    try{ if(typeof updateTotalProfit==='function') updateTotalProfit(); }catch(e){}
  }

  window.saveSnapshotToCloud = async function saveSnapshotToCloud(){
    if(!window.__isLoggedIn){ alert('请先登录'); return; }
    if(!confirm('是否确认用【当前本地数据】覆盖云端？')) return;

    const client = getClient();
    if(!client){ alert('Supabase 未初始化'); return; }

    const { data:u, error:ue } = await client.auth.getUser();
    if(ue || !u?.user){ alert('无法获取用户'); return; }

    const payload = { id: u.user.id, data: getOrders() };

    // 用 upsert：不存在就创建，存在就覆盖（避免 update 0 行“成功但没变化”）
    const { error } = await client
      .from('app_state_user')
      .upsert(payload, { onConflict: 'id' });

    if(error){ alert('保存失败：' + error.message); return; }
    alert('已保存到云端');
  };

  window.loadSnapshotFromCloud = async function loadSnapshotFromCloud(){
    if(!window.__isLoggedIn){ alert('请先登录'); return; }

    const client = getClient();
    if(!client){ alert('Supabase 未初始化'); return; }

    const { data:u, error:ue } = await client.auth.getUser();
    if(ue || !u?.user){ alert('无法获取用户'); return; }

    const { data, error } = await client
      .from('app_state_user')
      .select('data')
      .eq('id', u.user.id)
      .maybeSingle();

    if(error){ alert('拉取失败：' + error.message); return; }
    if(!data || data.data == null){ alert('云端暂无数据'); return; }

    if(!confirm('云端数据将【覆盖当前本地数据】，是否确认？')) return;

    setOrders(data.data);
    alert('已从云端拉取');
  };
})();
</script>

<script>
/* ======== UI 收口：主界面放回旧版云端按钮；菜单面板移除保存/拉取 ======== */
document.addEventListener('DOMContentLoaded', function(){
  // 菜单面板移除“保存到云端/从云端拉取”
  try{
    document.querySelectorAll('button,div').forEach(function(el){
      const t=(el.innerText||'').trim();
      if(t==='保存到云端' || t==='从云端拉取'){ el.remove(); }
    });
  }catch(e){}

  

});
</script>


<script>
/* ===== 登录态持久化恢复（仅恢复登录状态，不拉数据） ===== */
document.addEventListener('DOMContentLoaded', function(){
  if(!window.__supa) return;
  window.__supa.auth.getSession().then(function(res){
    if(res && res.data && res.data.session){
      window.__isLoggedIn = true;
      console.log('[AUTH] session restored');
    }
  });
});
</script>


<script>
/* ===== 菜单 面板：云端按钮回归（仅调用地基 API） ===== */
document.addEventListener('DOMContentLoaded', function(){
  // 找到 菜单 面板容器（兜底）
  let panel = document.querySelector('.cloud-panel') || document.querySelector('.addon-panel') || null;
  if(!panel) return;

  // 避免重复插入
  if(panel.querySelector('.cloud-snapshot-actions')) return;

  const box = document.createElement('div');
  box.className = 'cloud-snapshot-actions';
  box.style.cssText = 'margin-top:12px;display:flex;flex-direction:column;gap:8px';

  const btnSave = document.createElement('button');
  btnSave.textContent = '菜单 保存到云端';
  btnSave.onclick = function(){
    if(window.saveSnapshotToCloud) window.saveSnapshotToCloud();
  };

  const btnLoad = document.createElement('button');
  btnLoad.textContent = '⬇️ 从云端拉取';
  btnLoad.onclick = function(){
    if(window.loadSnapshotFromCloud) window.loadSnapshotFromCloud();
  };

  box.appendChild(btnSave);
  box.appendChild(btnLoad);
  panel.appendChild(box);
});
</script>


<script>
/* ===== 主界面：移除残留的云端“菜单保存/拉取”按钮（只保留菜单面板入口） ===== */
document.addEventListener('DOMContentLoaded', function(){
  // 删除总利润卡片右侧插入的容器
  document.querySelectorAll('.top-cloud-actions,.cloud-actions-row').forEach(function(el){ el.remove(); });

  // 删除可能存在的右上/右侧兜底浮层
  ['cloud-force-fab','cloud-csp-fab','cloud-direct-actions','cloud-csp-actions','cloud-fab'].forEach(function(id){
    var el=document.getElementById(id);
    if(el) el.remove();
  });

  // 文本兜底：把主界面的“菜单 保存/⬇️ 拉取”按钮移除（菜单面板里的保留）
  document.querySelectorAll('button').forEach(function(btn){
    var t=(btn.innerText||'').trim();
    if(t==='菜单 保存' || t==='⬇️ 拉取'){
      if(!btn.closest('.cloud-snapshot-actions')) btn.remove();
    }
  });
});
</script>


<script>
/* ======== 管理员接入（从旧系统逻辑移植，手动触发，不自动请求） ======== */
(function(){
  const ADMIN_EMAIL = "912872449@qq.com".toLowerCase();
  const PROFILE_TABLE = "user_profiles";

  function getClient(){ return window.__supa || null; }
  function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  const __ADMIN_SQL = `create table if not exists public.user_profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  email text,
  disabled boolean not null default false,
  role text not null default 'user',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

alter table public.user_profiles enable row level security;

drop policy if exists "profiles read own" on public.user_profiles;
drop policy if exists "profiles insert own" on public.user_profiles;
drop policy if exists "profiles update own" on public.user_profiles;
drop policy if exists "admin manage profiles" on public.user_profiles;

-- 用户读取/写入自己的 profile
create policy "profiles read own" on public.user_profiles
for select
using (auth.uid() = id and disabled = false);

create policy "profiles insert own" on public.user_profiles
for insert
with check (auth.uid() = id);

create policy "profiles update own" on public.user_profiles
for update
using (auth.uid() = id)
with check (auth.uid() = id);

-- 管理员：可管理全部用户（需要自己的 role='admin' 且未禁用）
create policy "admin manage profiles" on public.user_profiles
for all
using (
  exists (
    select 1 from public.user_profiles p
    where p.id = auth.uid() and p.role = 'admin' and p.disabled = false
  )
)
with check (
  exists (
    select 1 from public.user_profiles p
    where p.id = auth.uid() and p.role = 'admin' and p.disabled = false
  )
);
`;

  function isLoggedIn(){ return !!window.__isLoggedIn; }
  function getCurrentEmail(){ return (window.__currentUserEmail || "").toLowerCase(); }
  function isAdmin(){ return isLoggedIn() && getCurrentEmail() === ADMIN_EMAIL; }

  async function getAccessToken(){
    const client = getClient();
    if(!client) return null;
    try {
      const { data } = await client.auth.getSession();
      const token = data?.session?.access_token || null;
      return token;
    } catch(e) {
      return null;
    }
  }

  async function __callEdgeBodyToken(fnName, body){
    const token = await getAccessToken();
    if(!token) throw new Error("会话已失效：未获取到 access_token（请退出后重新登录）");
    const url = (window.SUPABASE_URL || "").replace(/\/$/,"") + "/functions/v1/" + fnName + "?t=" + Date.now();
    const payload = Object.assign({ access_token: token }, (body||{}));
    const resp = await fetch(url, {
      method: "POST",
      mode: "cors",
      cache: "no-store",
      headers: {
        "apikey": window.SUPABASE_KEY || "",
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });
    let json = null;
    try{ json = await resp.json(); }catch(e){}
    if(!resp.ok){
      const msg = (json && (json.error||json.message)) ? (json.error||json.message) : (resp.status + " " + resp.statusText);
      throw new Error(msg);
    }
    if(json && json.error) throw new Error(json.error);
    return json;
  }

  function _genStrongPw(n){
    n = n || 12;
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%*?";
    let out = "";
    for(let i=0;i<n;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }

  async function checkProfileAndMaybeKick(user){
    // 仅在“手动登录成功后”调用（属于用户动作触发）
    try{
      const client = getClient();
      if(!client || !user) return;
      const { data, error } = await client.from(PROFILE_TABLE).select("disabled,role").eq("id", user.id).maybeSingle();
      if(error || !data) return; // 读不到就降级不拦
      if(data.disabled === true){
        try{ await client.auth.signOut(); }catch(e){}
        window.__currentUserEmail = "";
        try{ window.__setLoginState(false); }catch(e){ window.__isLoggedIn=false; }
        alert("账号已被管理员禁用");
      }
    }catch(e){}
  }

  function refreshAdminVisibility(){
    const btn = document.getElementById("btnCloudAdmin");
    const box = document.getElementById("adminBox");
    if(btn) btn.style.display = isAdmin() ? "block" : "none";
    if(box && !isAdmin()) box.style.display = "none";
  }

  function showAdminUI(){
    const box = document.getElementById("adminBox");
    const sql = document.getElementById("adminSql");
    if(sql) sql.value = __ADMIN_SQL;
    if(box) box.style.display = "block";
    loadAdminList();
  }

  async function loadAdminList(){
    const tb = document.getElementById("adminTbody");
    if(!tb) return;
    tb.innerHTML = `<tr><td colspan="3" style="color:#555">加载中…</td></tr>`;

    const client = getClient();
    if(!client){ tb.innerHTML = `<tr><td colspan="3" style="color:#e74c3c">Supabase 未初始化</td></tr>`; return; }

    const { data, error } = await client.from(PROFILE_TABLE)
      .select("id,email,disabled,role,created_at,updated_at")
      .order("created_at",{ascending:false}).limit(200);

    if(error){
      tb.innerHTML = `<tr><td colspan="3" style="color:#e74c3c">读取失败：${escapeHtml(error.message||error)}</td></tr>`;
      return;
    }
    if(!data || !data.length){
      tb.innerHTML = `<tr><td colspan="3" style="color:#555">暂无用户（或未初始化表/策略）</td></tr>`;
      return;
    }

    tb.innerHTML = data.map(r=>{
      const email = r.email || r.id;
      const enabled = r.disabled !== true;
      const t = r.created_at ? String(r.created_at).replace("T"," ").slice(0,19) : "";
      return `<tr>
        <td style="padding:6px 4px;border-bottom:1px solid #f3f4f6">${escapeHtml(email)}</td>
        <td style="padding:6px 4px;border-bottom:1px solid #f3f4f6"><a class="toggleLogin" data-uid="${r.id}" data-enabled="${enabled ? "1":"0"}" href="javascript:void(0)">${enabled ? "✅ 允许":"⛔ 禁用"}</a></td>
        <td style="padding:6px 4px;border-bottom:1px solid #f3f4f6">${escapeHtml(t)}</td>
      </tr>`;
    }).join("");

    tb.querySelectorAll("a.toggleLogin").forEach(a=>{
      a.onclick = async ()=>{
        const uid = a.getAttribute("data-uid");
        const cur = a.getAttribute("data-enabled")==="1";
        const next = !cur;
        const { error: upE } = await client.from(PROFILE_TABLE).update({ disabled: !next }).eq("id", uid);
        if(upE){ alert("更新失败：" + (upE.message||upE)); return; }
        loadAdminList();
      };
    });
  }

  
  /* ===== 登录UI（不自动请求，仅按钮触发） ===== */
  function toggleLoginBox(show){
    const box = document.getElementById("loginBox");
    if(!box) return;
    const isOpen = box.style.display === "block";
    const shouldOpen = (show===undefined)?(!isOpen):!!show;
    box.style.display = shouldOpen ? "block" : "none";
    if(shouldOpen){
      const emailEl = document.getElementById("loginEmail");
      const pwEl = document.getElementById("loginPassword");
      if(emailEl && !emailEl.value) emailEl.value = (getCurrentEmail()||"");
      setTimeout(()=>{ (emailEl||pwEl)?.focus?.(); }, 30);
    } else {
      hideLoginMsg();
    }
  }
  function hideLoginBox(){ toggleLoginBox(false); }

  function showLoginMsg(msg){
    const el = document.getElementById("loginMsg");
    if(!el) return;
    el.textContent = msg;
    el.style.display = "block";
  }
  function hideLoginMsg(){
    const el = document.getElementById("loginMsg");
    if(!el) return;
    el.style.display = "none";
    el.textContent = "";
  }
  function setLoginLoading(isLoading){
    const btn = document.getElementById("loginSubmit");
    if(btn){
      btn.disabled = !!isLoading;
      btn.textContent = isLoading ? "登录中…" : "登录";
    }
  }

async function doLogin(email, pw){
    const client = getClient();
    if(!client){ showLoginMsg("Supabase 未初始化"); return; }
    email = (email||"").trim();
    pw = (pw||"").trim();
    if(!email){ showLoginMsg("请输入邮箱"); return; }
    if(!pw){ showLoginMsg("请输入密码"); return; }

    try {
      setLoginLoading(true);
      hideLoginMsg();
      const { data, error } = await client.auth.signInWithPassword({ email, password: pw });
      if(error) throw error;
      const user = data?.user;
      window.__currentUserEmail = user?.email || email;
      window.__setLoginState(true);
      refreshAdminVisibility();
      await checkProfileAndMaybeKick(user);
      hideLoginBox();
      window.showAppNotice && window.showAppNotice("登录成功", "已开启功能权限");
    } catch(e) {
      showLoginMsg("登录失败：" + (e?.message || e));
    } finally{
      setLoginLoading(false);
    }
  }

  async function doLogout(){
    const client = getClient();
    try{ if(client) await client.auth.signOut(); }catch(e){}
    window.__currentUserEmail = "";
    try{ window.__setLoginState(false); }catch(e){ window.__isLoggedIn=false; }
    refreshAdminVisibility();
    alert("已退出");
  }

  function bind(){
    const btnLogin = document.getElementById("btnCloudLogin");
    const btnLogout = document.getElementById("btnCloudLogout");
    const btnSave = document.getElementById("btnCloudSave");
    const btnLoad = document.getElementById("btnCloudLoad");
    const btnAdmin = document.getElementById("btnCloudAdmin");

    if(btnLogin) btnLogin.onclick = ()=>toggleLoginBox(true);
    if(btnLogout) btnLogout.onclick = doLogout;
    if(btnSave) btnSave.onclick = ()=>window.saveSnapshotToCloud && window.saveSnapshotToCloud();
    if(btnLoad) btnLoad.onclick = ()=>window.loadSnapshotFromCloud && window.loadSnapshotFromCloud();

    if(btnAdmin) btnAdmin.onclick = ()=>{
      if(!isAdmin()) return;
      showAdminUI();
    };

    
    const loginSubmit = document.getElementById("loginSubmit");
    const loginCancel = document.getElementById("loginCancel");
    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");

    if(loginSubmit) loginSubmit.onclick = ()=>doLogin(loginEmail?.value, loginPassword?.value);
    if(loginCancel) loginCancel.onclick = ()=>hideLoginBox();
    if(loginPassword) loginPassword.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ doLogin(loginEmail?.value, loginPassword?.value); } });
const btnRefresh = document.getElementById("adminRefresh");
    if(btnRefresh) btnRefresh.onclick = ()=>loadAdminList();

    const btnCreate = document.getElementById("adminCreateUserBtn");
    if(btnCreate) btnCreate.onclick = async ()=>{
      try{
        const email = (prompt("请输入要新建的用户邮箱：")||"").trim();
        if(!email) return;
        let pw = (prompt("请输入初始密码（留空自动生成强密码）：")||"").trim();
        if(!pw) pw = _genStrongPw(12);
        if(pw.length < 8){ alert("密码至少8位"); return; }
        await __callEdgeBodyToken("admin-create-user", {
          admin_email: getCurrentEmail(),
          target_email: email,
          target_password: pw
        });
        alert("创建成功！\n邮箱：" + email + "\n初始密码：" + pw);
        loadAdminList();
      }catch(e){ alert("创建失败：" + (e?.message||e)); }
    };

    const btnReset = document.getElementById("adminResetPwdBtn");
    if(btnReset) btnReset.onclick = async ()=>{
      try{
        const email = (prompt("请输入要重置密码的用户邮箱：")||"").trim();
        if(!email) return;
        let pw = (prompt("请输入新密码（留空自动生成强密码）：")||"").trim();
        if(!pw) pw = _genStrongPw(12);
        if(pw.length < 8){ alert("密码至少8位"); return; }
        await __callEdgeBodyToken("reset-password", {
          admin_email: getCurrentEmail(),
          target_email: email,
          new_password: pw
        });
        alert("重置成功！\n邮箱：" + email + "\n新密码：" + pw);
      }catch(e){ alert("重置失败：" + (e?.message||e)); }
    };

    const btnDel = document.getElementById("adminDeleteUserBtn");
    if(btnDel) btnDel.onclick = async ()=>{
      try{
        const email = (prompt("请输入要删除的账号邮箱：")||"").trim();
        if(!email) return;
        if(!confirm("确定删除账号：" + email + " ?\n删除后不可恢复")) return;
        // 兼容旧函数名：admin-delete-user，同时兼容你 zip 里的 delete-user
        try {
          await __callEdgeBodyToken("admin-delete-user", { admin_email: getCurrentEmail(), target_email: email, email });
        } catch(e1) {
          await __callEdgeBodyToken("delete-user", { admin_email: getCurrentEmail(), target_email: email, email });
        }
        alert("删除成功：" + email);
        loadAdminList();
      }catch(e){ alert("删除失败：" + (e?.message||e)); }
    };

    refreshAdminVisibility();
  }

  document.addEventListener("DOMContentLoaded", bind);
})();
</script>

<script>

/* === cloud button reposition patch (top-right + 30px) ===
   Keep v15k mechanism: do not wrap DOM, just append translate on top of final transform.
*/
(function () {
  function applyTopRightOffset(node) {
    // Base inline transform after v15k placement
    const base = node.dataset.__cloudBaseTransform || node.style.transform || getComputedStyle(node).transform || '';
    // Measure current rect
    const rect = node.getBoundingClientRect();
    const targetTop = 50;      // 30px from top
    const targetRightGap = 16; // 16px from right edge

    const dx = (window.innerWidth - targetRightGap) - rect.right;
    const dy = targetTop - rect.top;

    const baseClean = (base && base !== 'none') ? base : '';
    node.style.transform = baseClean + ` translate(${dx}px, ${dy}px)`;
  }

  // Wrap v15k apply function if present
  const orig = window.__applyCloudTransform;
  if (typeof orig === 'function') {
    window.__applyCloudTransform = function (node) {
      orig(node);
      // capture base inline transform produced by orig (avoid stacking)
      node.dataset.__cloudBaseTransform = node.style.transform || '';
      requestAnimationFrame(() => applyTopRightOffset(node));
    };
  } else {
    // Fallback: observe for the cloud button and apply once
    const mo = new MutationObserver(() => {
      const btn = document.querySelector('#addon-toggle,[data-addon-toggle],.cloud-toggle,.cloud-btn');
      if (!btn) return;
      mo.disconnect();
      requestAnimationFrame(() => applyTopRightOffset(btn));
      window.addEventListener('resize', () => applyTopRightOffset(btn), { passive: true });
    });
    mo.observe(document.documentElement, { childList: true, subtree: true });
  }

  // Also re-apply on resize for safety (only when button exists)
  window.addEventListener('resize', () => {
    const btn = document.querySelector('#addon-toggle,[data-addon-toggle],.cloud-toggle,.cloud-btn');
    if (btn) requestAnimationFrame(() => applyTopRightOffset(btn));
  }, { passive: true });
})();

</script>

<script>
/* === Login modal viewport-centering patch (handles mobile keyboard) === */
(function(){
  const box = document.getElementById('loginBox');
  const backdrop = document.getElementById('loginBackdrop');
  if(!box || !backdrop) return;

  function centerBox(){
    // use VisualViewport when available to avoid keyboard pushing things around
    const vv = window.visualViewport;
    if(vv){
      const cx = (vv.width / 2);
      const cy = (vv.height / 2) + vv.offsetTop;
      box.style.left = (cx) + 'px';
      box.style.top  = (cy - 30) + 'px';
      box.style.transform = 'translate(-50%, -50%)';
    }else{
      box.style.left = '50%';
      box.style.top  = '50%';
      box.style.transform = 'translate(-50%, -50%)';
    }
  }

  function showBackdrop(){
    backdrop.classList.add('show');
  }
  function hideBackdrop(){
    backdrop.classList.remove('show');
  }

  // Detect show/hide by observing display style changes
  const mo = new MutationObserver(() => {
    const visible = box.style.display !== 'none';
    if(visible){
      document.body.classList.add('login-open');
      showBackdrop();
      centerBox();
      setTimeout(centerBox, 0);
    }else{
      document.body.classList.remove('login-open');
      hideBackdrop();
    }
  });
  mo.observe(box, { attributes:true, attributeFilter:['style','class'] });

  // Clicking backdrop cancels login UI
  backdrop.addEventListener('click', (e) => {
    // 只点到遮罩空白处才关闭
    if(e && e.target !== backdrop) return;
const cancel = document.getElementById('loginCancel');
    if(cancel) cancel.click();
    else box.style.display = 'none';
  });

  // Keep centered while keyboard opens/closes
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', centerBox, { passive:true });
    window.visualViewport.addEventListener('scroll', centerBox, { passive:true });
  }
  window.addEventListener('resize', centerBox, { passive:true });
})();
</script>


<script>
/* === FORCE admin button styles (inline, bypass CSS cache/state) === */
(function(){
  function applyAdminBtnStyles(){
    const map = [
      {id:'adminCreateUserBtn', bg:'rgba(34,197,94,.14)', bd:'rgba(34,197,94,.45)', cl:'#065f46'},
      {id:'adminResetPwdBtn',  bg:'rgba(59,130,246,.14)', bd:'rgba(59,130,246,.45)', cl:'#1e3a8a'},
      {id:'adminDeleteUserBtn',bg:'rgba(239,68,68,.14)', bd:'rgba(239,68,68,.55)', cl:'#991b1b'}
    ];
    map.forEach(x=>{
      const b=document.getElementById(x.id);
      if(!b) return;
      b.style.height='38px';
      b.style.borderRadius='14px';
      b.style.fontSize='14px';
      b.style.fontWeight='700';
      b.style.background=x.bg;
      b.style.border='1px solid '+x.bd;
      b.style.color=x.cl;
      b.style.boxShadow='0 8px 22px rgba(17,24,39,.10)';
    });
  }
  // run when admin panel toggles
  const obs=new MutationObserver(applyAdminBtnStyles);
  obs.observe(document.body,{subtree:true,childList:true});
  window.addEventListener('load', applyAdminBtnStyles);
})();
</script>

<div id="copyToast">已复制：pinking0000</div>

<script>
/* === 复制管理员微信号 === */
(function(){
  function showToast(){
    const t = document.getElementById('copyToast');
    if(!t) return;
    t.style.display='block';
    clearTimeout(t.__hideTimer);
    t.__hideTimer = setTimeout(()=>{ t.style.display='none'; }, 1200);
  }
  async function copyText(txt){
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(txt);
      }else{
        const ta=document.createElement('textarea');
        ta.value=txt;
        ta.setAttribute('readonly','');
        ta.style.position='fixed';
        ta.style.left='-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }
      showToast();
    }catch(e){
      alert('复制失败，请手动复制：' + txt);
    }
  }
  document.addEventListener('click', (e)=>{
    const btn = e.target && e.target.closest && e.target.closest('#copyAdminVxBtn');
    if(!btn) return;
    e.preventDefault();
    copyText(btn.dataset.copy || 'pinking0000');
  });
})();
</script>


<script>
/* === 菜单：锁定为页面元素（随页面滚动，不悬浮）；弹开不影响页面布局 === */
(function(){
  const RIGHT = 16;
  const TOP = 50;
  const GAP = 10;
  const BTN = 41;

  function apply(){
    const t = document.querySelector('.cloud-addon-toggle');
    const card = document.querySelector('.cloud-addon-card');
    const panel = document.querySelector('.cloud-addon-panel');
    if(panel){
      panel.style.position = 'absolute';
      panel.style.right = RIGHT + 'px';
      panel.style.top = TOP + 'px';
      panel.style.left = 'auto';
      panel.style.bottom = 'auto';
      panel.style.transform = 'none';
    }
    if(t){
      t.style.position = 'absolute';
      t.style.right = RIGHT + 'px';
      t.style.top = TOP + 'px';
      t.style.left = 'auto';
      t.style.bottom = 'auto';
      t.style.transform = 'none'; // 禁止跟随 transform 重算漂移
    }
    if(card){
      card.style.position = 'absolute';
      card.style.right = RIGHT + 'px';
      card.style.top = (TOP + BTN + GAP) + 'px';
      card.style.left = 'auto';
      card.style.bottom = 'auto';
      card.style.transform = 'none';
    }
  }

  window.addEventListener('load', () => { setTimeout(apply, 0); setTimeout(apply, 80); });

  const mo = new MutationObserver(() => apply());
  mo.observe(document.documentElement, {subtree:true, childList:true, attributes:true, attributeFilter:['style','class']});
})();
</script>


<script>
/* === UI 微特效：仅切 class，不改布局 === */
(function(){
  const cardSel = '.cloud-addon-card';
  const toggleSel = '.cloud-addon-toggle';
  const loginBoxId = 'loginBox';
  const toastId = 'copyToast';

  function isShown(el){
    if(!el) return false;
    return getComputedStyle(el).display !== 'none';
  }

  function refresh(){
    const card = document.querySelector(cardSel);
    const toggle = document.querySelector(toggleSel);
    const login = document.getElementById(loginBoxId);

    if(card){
      card.classList.toggle('fx-open', isShown(card));
    }
    if(toggle){
      // idle breath only when card is closed
      toggle.classList.toggle('fx-idle', !(card && isShown(card)));
    }
    if(login){
      login.classList.toggle('fx-open', isShown(login));
    }
  }

  // Observe style changes to update classes
  const mo = new MutationObserver(()=>refresh());
  mo.observe(document.documentElement, {subtree:true, attributes:true, attributeFilter:['style','class'], childList:true});

  window.addEventListener('load', ()=>{ setTimeout(refresh, 0); setTimeout(refresh, 120); });

  // Patch toast show to add class if exists
  const toast = document.getElementById(toastId);
  if(toast){
    const origDisplaySetter = Object.getOwnPropertyDescriptor(HTMLElement.prototype,'style');
  }

  // Hook into existing toast usage: when display is set to block, add fx-show then remove later
  document.addEventListener('click', (e)=>{
    const btn = e.target && e.target.closest && e.target.closest('#copyAdminVxBtn');
    if(!btn) return;
    // toast will be shown by existing logic; we add a tiny delay then apply class
    setTimeout(()=>{
      const t = document.getElementById(toastId);
      if(t){
        t.classList.add('fx-show');
        clearTimeout(t.__fxTimer);
        t.__fxTimer = setTimeout(()=>t.classList.remove('fx-show'), 1150);
      }
    }, 20);
  }, true);

})();
</script>


<script>
/* === 页面丝滑淡入 === */
(function(){
  function ready(){ document.body.classList.add('fx-page-ready'); }
  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(ready, 0);
  }else{
    window.addEventListener('DOMContentLoaded', ()=> setTimeout(ready, 0));
  }
})();
</script>


<div id="appNotice"><div class="main"></div><div class="sub"></div></div>

<script>
/* === 登录框强制挂到遮罩层：确保真正居中（不受菜单卡片布局影响） + 美化提示 === */
(function(){
  function ensureLoginModalParent(){
    var box = document.getElementById('loginBox');
    var backdrop = document.getElementById('loginBackdrop');
    if(!box || !backdrop) return;
    if(box.parentNode !== backdrop){
      try{ backdrop.appendChild(box); }catch(e){}
    }
  }

  window.showAppNotice = function(title, subtitle){
    var n = document.getElementById('appNotice');
    if(!n) return;
    var main = n.querySelector('.main') || n;
    var sub  = n.querySelector('.sub');
    if(main) main.textContent = title || '';
    if(sub) sub.textContent = subtitle || '';
    n.classList.add('show');
    clearTimeout(n.__t);
    n.__t = setTimeout(function(){ n.classList.remove('show'); }, 1400);
  };

  document.addEventListener('DOMContentLoaded', function(){
    ensureLoginModalParent();
  });

  var mo = new MutationObserver(function(){ ensureLoginModalParent(); });
  mo.observe(document.documentElement, {subtree:true, childList:true});
})();
</script>


<script>
/* === 登录按钮/取消兜底绑定：防止某些浏览器事件丢失 === */
(function(){
  function bindOnce(){
    var box = document.getElementById('loginBox');
    var cancel = document.getElementById('loginCancel');
    var backdrop = document.getElementById('loginBackdrop');
    if(!box || !cancel || !backdrop) return;

    if(cancel.__bound) return;
    cancel.__bound = true;

    cancel.addEventListener('click', function(e){
      e.preventDefault();
      box.style.display = 'none';
      backdrop.classList.remove('show');
      document.body.classList.remove('login-open');
    }, false);
  }
  document.addEventListener('DOMContentLoaded', bindOnce);
  var mo = new MutationObserver(bindOnce);
  mo.observe(document.documentElement, {subtree:true, childList:true});
})();
</script>

</body>
</html>
