<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†ä¸šè®¢å•åˆ©æ¶¦ç®¡ç†ç³»ç»Ÿ v20.0æ­£å¼ç‰ˆ</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2c3e50">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: #333;
            padding: 10px;
            min-height: 100vh;
            max-width: 100%;
            overflow-x: hidden;
            animation: fadeInBody 0.8s ease-out;
        }
        
        @keyframes fadeInBody {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .container {
            max-width: 1080px;
            margin: 0 auto;
        }
        
        .header {
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            animation: fadeIn 0.7s ease-out 0.2s both;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .header h1 i {
            margin-right: 8px;
            font-size: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .total-profit {
            font-size: 24px;
            font-weight: 700;
            margin-top: 8px;
            display: flex;
            align-items: center;
            animation: fadeIn 0.7s ease-out 0.3s both;
        }
        
        .profit-positive {
            color: #2ecc71;
            text-shadow: 0 2px 4px rgba(46, 204, 113, 0.3);
        }
        
        .profit-negative {
            color: #e74c3c;
            text-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
        }
        
        .filter-status {
            font-size: 12px;
            color: #bdc3c7;
            margin-top: 4px;
            display: flex;
            align-items: center;
            animation: fadeIn 0.7s ease-out 0.4s both;
        }
        
        .filter-status i {
            margin-right: 4px;
        }
        
        .actions {
            display: flex;
            margin-bottom: 15px;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: thin;
            scrollbar-color: #bdc3c7 transparent;
            animation: slideUp 0.5s ease-out 0.5s both;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .actions::-webkit-scrollbar {
            height: 4px;
        }
        
        .actions::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 2px;
        }
        
        .actions::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 2px;
        }
        
        .action-btn {
            flex: 0 0 auto;
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .action-btn:focus:not(:active)::after {
            animation: ripple 0.6s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .action-btn i {
            margin-right: 6px;
            font-size: 14px;
            transition: transform 0.3s ease;
        }
        
        .action-btn:hover i {
            transform: scale(1.1);
        }
        
        .btn-add {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }
        
        .btn-export {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }
        
        .btn-import {
            background: linear-gradient(135deg, #f39c12 0%, #d35400 100%);
            color: white;
        }
        
        .btn-save {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
        }
        
        .btn-calculator {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
        }
        
        .btn-filter {
            background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
            color: white;
            position: relative;
        }
        
        .btn-filter.active {
            background: linear-gradient(135deg, #16a085 0%, #149174 100%);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .btn-clear-filter {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }
        
        .action-btn:hover, .filter-select:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .action-btn:active, .filter-select:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .filter-select-container {
            position: relative;
            flex: 0 0 auto;
            min-width: 140px;
        }
        
        .filter-select {
            width: 100%;
            padding: 10px 30px 10px 10px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, #ecf0f1 0%, #dfe6e9 100%);
            color: #2c3e50;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .filter-select:focus {
            outline: none;
            background: linear-gradient(135deg, #dfe6e9 0%, #d1d8dd 100%);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }
        
        .filter-select:hover {
            background: linear-gradient(135deg, #dfe6e9 0%, #d1d8dd 100%);
        }
        
        .filter-select-container::after {
            content: '\f0d7';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            pointer-events: none;
            transition: transform 0.3s ease;
        }
        
        .filter-select-container:hover::after {
            transform: translateY(-50%) rotate(180deg);
        }
        
        .table-container {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 15px;
            overflow-x: auto;
            animation: slideUp 0.5s ease-out 0.6s both;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 960px;
        }
        
        thead {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
        }
        
        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: background-color 0.3s ease;
        }
        
        th.sortable:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sort-indicator {
            margin-left: 4px;
            opacity: 0.7;
            transition: transform 0.3s ease;
        }
        
        th.sortable:hover .sort-indicator {
            transform: scale(1.2);
        }
        
        tbody tr {
            border-bottom: 1px solid #f1f1f1;
            transition: all 0.3s ease;
            animation: fadeInRow 0.5s ease-out;
        }
        
        @keyframes fadeInRow {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tbody tr:hover {
            background-color: #f0f7ff;
            transform: translateX(5px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        td {
            padding: 10px 8px;
            font-size: 12.5px;
            transition: background-color 0.3s ease;
        }
        
        input, select {
            width: 100%;
            padding: 7px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12.5px;
            transition: all 0.3s ease;
            background-color: white;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        input:hover, select:hover {
            border-color: #bbb;
        }
        
        .profit-cell {
            font-weight: 600;
            transition: transform 0.3s ease;
        }
        
        tbody tr:hover .profit-cell {
            transform: scale(1.05);
        }
        
        .date-cell {
            cursor: pointer;
            position: relative;
            transition: color 0.3s ease;
        }
        
        .date-cell:hover {
            color: #3498db;
        }
        
        .date-cell::after {
            content: 'ğŸ“…';
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%) scale(0);
            transition: transform 0.3s ease;
            opacity: 0.5;
        }
        
        .date-cell:hover::after {
            transform: translateY(-50%) scale(1);
        }
        
        .delete-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 7px 10px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
        }
        
        .delete-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(231, 76, 60, 0.4);
        }
        
        .delete-btn:active {
            transform: translateY(0);
        }
        
        .delete-btn i {
            font-size: 11px;
            transition: transform 0.3s ease;
        }
        
        .delete-btn:hover i {
            transform: scale(1.1);
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            color: #7f8c8d;
            font-size: 12px;
            animation: fadeIn 0.7s ease-out 0.7s both;
        }
        
        .toast {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 90%;
            text-align: center;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .file-input {
            display: none;
        }
        
        /* è®¡ç®—å™¨æ ·å¼ */
        .calculator-container {
            position: fixed;
            bottom: 15px;
            right: 15px;
            width: 300px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
            overflow: hidden;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .calculator-container.show {
            display: block;
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        
        .calculator-header {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .calculator-title {
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
        }
        
        .calculator-title i {
            margin-right: 8px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        .calculator-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .calculator-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .calculator-display {
            padding: 15px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
            text-align: right;
            font-size: 22px;
            font-weight: 600;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            word-break: break-all;
            overflow-wrap: break-word;
            font-family: 'Courier New', monospace;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .calculator-history {
            font-size: 13px;
            color: #7f8c8d;
            min-height: 18px;
            width: 100%;
            text-align: right;
            margin-bottom: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .calculator-current {
            font-size: 26px;
            width: 100%;
            text-align: right;
            word-break: break-all;
            transition: all 0.3s ease;
        }
        
        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background-color: #ddd;
        }
        
        .calculator-btn {
            border: none;
            padding: 16px 8px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .calculator-btn:hover {
            background-color: #f5f5f5;
            transform: scale(1.05);
            z-index: 1;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .calculator-btn.operator {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .calculator-btn.equals {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            font-weight: 600;
        }
        
        .calculator-btn.equals:hover {
            background: linear-gradient(135deg, #d35400 0%, #c0392b 100%);
        }
        
        .calculator-btn.clear {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            font-weight: 600;
        }
        
        .calculator-btn.clear:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }
        
        .calculator-btn.zero {
            grid-column: span 2;
        }
        
        .scan-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
        }
        
        .scan-btn:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1f6aa5 100%);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(52, 152, 219, 0.4);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            
            .header {
                margin-bottom: 12px;
                padding: 12px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .total-profit {
                font-size: 22px;
            }
            
            .actions {
                margin-bottom: 12px;
                gap: 6px;
            }
            
            .action-btn, .filter-select {
                font-size: 12px;
                padding: 8px 10px;
            }
            
            .action-btn i {
                font-size: 13px;
                margin-right: 4px;
            }
            
            .filter-select-container {
                min-width: 120px;
            }
            
            .filter-select {
                padding: 8px 25px 8px 8px;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 12px;
            }
            
            input, select {
                padding: 6px;
                font-size: 12px;
            }
            
            .table-container {
                margin-bottom: 12px;
            }
            
            .calculator-container {
                width: 280px;
                right: 8px;
                bottom: 8px;
            }
            
            .calculator-display {
                font-size: 18px;
                min-height: 55px;
            }
            
            .calculator-history {
                font-size: 11px;
            }
            
            .calculator-current {
                font-size: 22px;
            }
            
            .calculator-btn {
                padding: 14px 6px;
                font-size: 14px;
            }
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 9999;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* æ‰«ææ¨¡æ€æ¡†ç¾åŒ– */
        #scannerModal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-out;
        }
        
        #scannerModal.show {
            display: flex;
        }
        
        #scannerModal > div {
            background: white;
            width: 90%;
            max-width: 420px;
            border-radius: 12px;
            padding: 15px;
            animation: zoomIn 0.3s ease-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* æ•°æ®è¡Œæ·»åŠ åŠ¨ç”» */
        .row-added {
            animation: highlightRow 1s ease-out;
        }
        
        @keyframes highlightRow {
            0% { background-color: rgba(52, 152, 219, 0.3); }
            100% { background-color: transparent; }
        }
        
        /* æ•°å­—è¾“å…¥æ¡†åŠ¨ç”» */
        input[type="number"]:focus {
            animation: pulseBorder 1.5s infinite;
        }
        
        @keyframes pulseBorder {
            0% { box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); }
            50% { box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.5); }
            100% { box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); }
        }
    
        /* é¡¶éƒ¨å³ä¾§ï¼šäº‘ç«¯æ“ä½œæŒ‰é’®ï¼ˆä¸ å¯¼å‡º/å¯¼å…¥ åŒé£æ ¼ï¼‰ */
        .top-right-cloud-actions{
            position:absolute;
            top: 94px;
            right:6px;
            z-index:20;
        }
        /* ç»™æ ‡é¢˜åŒºåŸŸç•™å‡ºå³ä¾§ç©ºé—´ï¼Œé¿å…è¢«æŒ‰é’®é®æŒ¡ */
        .header{
            padding-right: 170px;
        }
        @media (max-width: 420px){
            .header{
            padding-right: 170px;
        }
        }
        .top-right-cloud-actions .action-btn{
            padding:8px 10px;
            font-size:12px;
            border-radius:8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            white-space:nowrap;
        }
        .btn-cloud-save{
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color:#fff;
        }
        .btn-cloud-load{
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color:#fff;
        }
        .btn-cloud-pin{
            background: linear-gradient(135deg, #111827 0%, #374151 100%);
            color:#fff;
        }
        .btn-cloud-diag{
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color:#fff;
        }
        .btn-cloud-sort{
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color:#fff;
        }

        /* äº‘ç«¯æŒ‰é’®ï¼šå›ºå®š 2x2 + çŠ¶æ€å ä¸€è¡Œï¼ˆé¿å…å¹³æ¿è¢«è£åˆ‡ï¼‰ */
        #cloudBar{
            display:grid;
            grid-template-columns: repeat(2, minmax(92px, auto));
            gap:8px;
            align-items:center;
        }
        #cloudBar #cloudStatus{
            grid-column: 1 / -1;
            max-width: 220px;
        }
        /* å¹³æ¿/æ¡Œé¢ï¼šç»™ header åº•éƒ¨ç•™å‡ºç©ºé—´ï¼Œé¿å…ç¬¬äºŒè¡ŒæŒ‰é’®è¢« overflow è£æ‰ */
        @media (min-width: 600px){
            .header{ padding-bottom: 80px; }
        }
.top-right-actions{
  position:absolute;
  top:10px;
  right:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
  z-index:999;
}
.top-right-actions .action-btn{
  height:40px;
  min-width:104px;
  padding:0 12px;
  font-size:14px;
  border-radius:20px;
}
.top-right-actions .action-btn .icon,
.top-right-actions .action-btn svg{
  width:18px;
  height:18px;
}
@media (max-width:420px){
  .top-right-actions{top:8px; right:8px; gap:5px;}
  .top-right-actions .action-btn{height:36px; min-width:96px; padding:0 10px; font-size:13px; border-radius:18px;}
  .top-right-actions .action-btn .icon,
  .top-right-actions .action-btn svg{width:16px; height:16px;}
}

/* v18 UI tuned: smaller right-top buttons + more breathing room */
.top-right-actions{top:8px; right:8px; gap:6px;}
.top-right-actions .action-btn{
  height:34px;
  min-width:90px;
  padding:0 10px;
  font-size:12.5px;
  border-radius:17px;
}
.top-right-actions .action-btn .icon,
.top-right-actions .action-btn svg{
  width:15px;
  height:15px;
}
@media (max-width:420px){
  .top-right-actions{top:6px; right:6px; gap:5px;}
  .top-right-actions .action-btn{height:32px; min-width:84px; padding:0 9px; font-size:12px; border-radius:16px;}
  .top-right-actions .action-btn .icon,
  .top-right-actions .action-btn svg{width:14px; height:14px;}
}

/* v18.4: cloud buttons 2x2, moved right-down */
#cloudBar{
  display:grid;
  grid-template-columns: repeat(2, max-content);
  gap:10px 12px;
  align-items:center;
  justify-content:end;
}
#cloudBar #cloudStatus{
  grid-column: 1 / 3;
  justify-self:end;
  margin-top:-2px;
}
#cloudBar .action-btn{
  height:34px;
  min-width:108px;
  padding:0 12px;
  font-size:13px;
  border-radius:18px;
}
#cloudBar .action-btn .icon,
#cloudBar .action-btn svg{
  width:14px;
  height:14px;
}
@media (max-width:420px){
  .top-right-cloud-actions{ top: 72px; right:4px; }
  #cloudBar{ gap:8px 10px; }
  #cloudBar .action-btn{ height:32px; min-width:98px; padding:0 10px; font-size:12.5px; border-radius:16px; }
  #cloudBar .action-btn .icon,
  #cloudBar .action-btn svg{ width:13px; height:13px; }
}

/* ===== è®¾å¤‡ç»‘å®š/å®¡æ‰¹ï¼šè®¿é—®æ§åˆ¶å±‚ ===== */
#appRoot{ display:none; }
.auth-gate{
  position:fixed; inset:0; z-index:99999;
  background:rgba(15,23,42,.85);
  display:flex; align-items:center; justify-content:center;
  padding:16px;
}
.auth-card{
  width:min(520px, 96vw);
  background:#fff;
  border-radius:14px;
  box-shadow:0 18px 60px rgba(0,0,0,.25);
  padding:18px 18px 14px;
}
.auth-card h2{ margin:0 0 10px; font-size:18px; color:#111; }
.auth-card p{ margin:8px 0; color:#334155; line-height:1.45; }
.auth-row{ margin:10px 0; }
.auth-input{
  width:100%; padding:10px 12px;
  border:1px solid #cbd5e1; border-radius:10px;
  font-size:14px;
}
.auth-btn{
  width:100%;
  padding:10px 12px;
  border:none; border-radius:10px;
  background:#2563eb; color:#fff; font-size:14px;
}
.auth-btn.secondary{ background:#64748b; margin-top:8px; }
.auth-btn.danger{ background:#dc2626; margin-top:8px; }
.auth-small{ font-size:12px; color:#64748b; }
.auth-code{
  user-select:all;
  background:#f1f5f9;
  border:1px dashed #94a3b8;
  padding:10px 12px;
  border-radius:10px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px;
  word-break:break-all;
}
</style>

<style>
/* v16 é¡¶æ æ ·å¼ */
#cloudBar button{
  border: none !important;
  padding: 8px 12px !important;
  border-radius: 999px !important;
  font-weight: 700 !important;
  font-size: 12px !important;
  cursor: pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,.10);
  transition: transform .08s ease, filter .12s ease;
}
#cloudBar button:active{ transform: scale(.98); filter: brightness(.95); }
#cloudStatus{
  font-size: 12px !important;
  opacity: .88;
}
</style>

</head>
<body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-spinner" id="loading-spinner"></div>

    <div id="appRoot">
    
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> å•†ä¸šè®¢å•åˆ©æ¶¦ç®¡ç†ç³»ç»Ÿ v20.0æ­£å¼ç‰ˆ</h1>
            <p>æ€»è®¡ <span id="total-count">0</span> ç¬”è®¢å•</p>
            <div id="cloudIdHeader" style="margin-top:8px;font-size:12px;color:#059669;opacity:.95;">äº‘ç«¯IDï¼šæœªè®¾ç½®å¯†ç </div>
            <div id="topRightCloudActions" class="top-right-cloud-actions"></div>

            <div class="total-profit" id="total-profit">æ€»åˆ©: Â¥0.0</div>
            <div class="filter-status" id="filter-status">
                <i class="fas fa-filter"></i> <span id="filter-status-text">æ˜¾ç¤ºå…¨éƒ¨è®¢å•</span>
            </div>
        </div>
        
        <div class="actions">
            <button class="action-btn btn-add" id="add-btn">
                <i class="fas fa-plus-circle"></i> æ–°å¢
            </button>
            <button class="action-btn btn-export" id="export-btn">
                <i class="fas fa-file-export"></i> å¯¼å‡º
            </button>
            <button class="action-btn btn-import" id="import-btn">
                <i class="fas fa-file-import"></i> å¯¼å…¥
            </button>
<input type="file" id="file-input" class="file-input" accept=".xlsx,.xls">
            <button class="action-btn btn-save" id="save-btn">
                <i class="fas fa-save"></i> ä¿å­˜
            </button>
            <button class="action-btn btn-calculator" id="calculator-btn">
                <i class="fas fa-calculator"></i> è®¡ç®—å™¨
            </button>
            
            <!-- ä¸‹å•äººç­›é€‰æ¡† -->
            <div class="filter-select-container">
                <select class="filter-select" id="customer-filter">
                    <option value="">å…¨éƒ¨ä¸‹å•äºº</option>
                    <!-- ä¸‹å•äººé€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </select>
            </div>
            
            <!-- äº§å“ç­›é€‰æ¡† -->
            <div class="filter-select-container">
                <select class="filter-select" id="product-filter">
                    <option value="">å…¨éƒ¨äº§å“</option>
                    <!-- äº§å“é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </select>
            </div>
            
            <button class="action-btn btn-clear-filter" id="clear-filter">
                <i class="fas fa-times-circle"></i> æ¸…é™¤ç­›é€‰
            </button>

            <button class="action-btn btn-restore" id="restore-btn">
                <i class="fas fa-rotate-left"></i> æ¢å¤
            </button>

        </div>
        
        <div class="table-container">
            <table id="orders-table">
                <thead>
                    <tr>
                        <th style="width: 60px;" class="sortable" id="date-header">
                            æ—¥æœŸ
                            <span class="sort-indicator" id="date-sort">â†“</span>
                        </th>
                        <th style="width: 70px;">ä¸‹å•äºº</th>
                        <th style="width: 80px;">äº§å“</th>
                        <th style="width: 60px;">ä¸‹å•é‡‘é¢</th>
                        <th style="width: 60px;">è¿”æ¬¾</th>
                        <th style="width: 60px;">è¿è´¹</th>
                        <th style="width: 60px;" class="sortable" id="sell-amount-header">
                            å”®å‡ºé‡‘é¢
                            <span class="sort-indicator" id="sell-amount-sort">â†•</span>
                        </th>
                        <th style="width: 60px;">åˆ©æ¶¦</th>
                        <th style="width: 60px;">è´§å•†</th>
                        <th style="width: 110px;">ç‰©æµå•å·</th>
                        <th style="width: 110px;">å¤‡æ³¨</th>
                        <th style="width: 60px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- è¡Œå°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            å•†ä¸šè®¢å•åˆ©æ¶¦ç®¡ç†ç³»ç»Ÿ &copy; 2026 | ä¸“ä¸ºç§»åŠ¨ç«¯ä¼˜åŒ–
        </div>
    </div>
    
    <!-- è®¡ç®—å™¨å®¹å™¨ -->
    <div class="calculator-container" id="calculator">
        <div class="calculator-header">
            <div class="calculator-title"><i class="fas fa-calculator"></i> è®¡ç®—å™¨</div>
            <button class="calculator-close" id="calculator-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="calculator-display">
            <div class="calculator-history" id="calculator-history"></div>
            <div class="calculator-current" id="calculator-current">0</div>
        </div>
        <div class="calculator-buttons">
            <button class="calculator-btn clear" data-action="clear">C</button>
            <button class="calculator-btn clear" data-action="clear-entry">CE</button>
            <button class="calculator-btn operator" data-action="percent">%</button>
            <button class="calculator-btn operator" data-action="divide">Ã·</button>
            
            <button class="calculator-btn" data-number="7">7</button>
            <button class="calculator-btn" data-number="8">8</button>
            <button class="calculator-btn" data-number="9">9</button>
            <button class="calculator-btn operator" data-action="multiply">Ã—</button>
            
            <button class="calculator-btn" data-number="4">4</button>
            <button class="calculator-btn" data-number="5">5</button>
            <button class="calculator-btn" data-number="6">6</button>
            <button class="calculator-btn operator" data-action="subtract">-</button>
            
            <button class="calculator-btn" data-number="1">1</button>
            <button class="calculator-btn" data-number="2">2</button>
            <button class="calculator-btn" data-number="3">3</button>
            <button class="calculator-btn operator" data-action="add">+</button>
            
            <button class="calculator-btn zero" data-number="0">0</button>
            <button class="calculator-btn" data-action="decimal">.</button>
            <button class="calculator-btn equals" data-action="equals">=</button>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // åˆå§‹åŒ–æ•°æ®
        let orders = JSON.parse(localStorage.getItem('orderProfitData')) || [];
        // v19-Bï¼šè‡ªåŠ¨å¤‡ä»½/æ¢å¤ï¼ˆæœ¬æœºï¼Œä¿ç•™æœ€è¿‘20ä»½ï¼‰
        function _backupKey(cloudId){ return `orderProfitBackups:${cloudId || "local"}`; }

        function _calcTotalProfit(list){
            try{
                return (list||[]).reduce((s,o)=>s + (Number(o.profit)||0), 0);
            }catch{ return 0; }
        }

        function createLocalBackup(reason="auto"){
            const cloudId = (localStorage.getItem("cloudPIN") || localStorage.getItem("cloudId") || "local");
            const key = _backupKey(cloudId);
            let arr = [];
            try{ arr = JSON.parse(localStorage.getItem(key) || "[]"); }catch{ arr = []; }
            const entry = {
                ts: new Date().toISOString(),
                reason,
                count: (orders||[]).length,
                profit: _calcTotalProfit(orders),
                data: orders
            };
            // å»é‡ï¼šå¦‚æœæœ€æ–°ä¸€ä»½å’Œå½“å‰å®Œå…¨ä¸€æ ·å°±ä¸å†å­˜
            try{
                const last = arr[0];
                if(last && JSON.stringify(last.data) === JSON.stringify(entry.data)){
                    return;
                }
            }catch{}
            arr.unshift(entry);
            arr = arr.slice(0, 20);
            localStorage.setItem(key, JSON.stringify(arr));
        }

        function openBackupRestore(){
            const cloudId = (localStorage.getItem("cloudPIN") || localStorage.getItem("cloudId") || "local");
            const key = _backupKey(cloudId);
            let arr = [];
            try{ arr = JSON.parse(localStorage.getItem(key) || "[]"); }catch{ arr = []; }
            if(!arr.length){
                alert("æš‚æ— å¤‡ä»½ï¼ˆå»ºè®®å…ˆç‚¹ä¸€æ¬¡äº‘ç«¯ä¿å­˜ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆå¤‡ä»½ï¼‰");
                return;
            }
            const lines = arr.map((b,i)=>{
                const t = (b.ts||"").replace("T"," ").replace("Z","");
                const profit = (Number(b.profit)||0).toFixed(1);
                return `${i+1}. ${t} | ${b.count||0}ç¬” | Â¥${profit}`;
            }).join("\n");
            const pick = prompt("é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½ï¼ˆè¾“å…¥åºå·ï¼‰\n\n" + lines);
            const n = Number(pick);
            if(!n || n<1 || n>arr.length) return;
            const chosen = arr[n-1];
            const curCount = (orders||[]).length;
            const curProfit = _calcTotalProfit(orders);
            const msg = `ç¡®è®¤æ¢å¤ï¼Ÿ\n\nå½“å‰ï¼š${curCount}ç¬” | Â¥${curProfit.toFixed(1)}\nå¤‡ä»½ï¼š${chosen.count||0}ç¬” | Â¥${(Number(chosen.profit)||0).toFixed(1)}\næ—¶é—´ï¼š${(chosen.ts||"").replace("T"," ").replace("Z","")}`;
            if(!confirm(msg)) return;

            orders = Array.isArray(chosen.data) ? chosen.data : [];
            localStorage.setItem('orderProfitData', JSON.stringify(orders));
            if(typeof renderOrders === "function") renderOrders();
            if(typeof updateTotalProfit === "function") updateTotalProfit();
            if(typeof showToast === "function") showToast("å·²æ¢å¤å¤‡ä»½");
            // å¯é€‰ï¼šæ¢å¤åæ˜¯å¦ç«‹å³äº‘ç«¯ä¿å­˜
            if(confirm("æ˜¯å¦ç«‹å³ä¿å­˜åˆ°äº‘ç«¯ï¼Ÿï¼ˆä¼šè¦†ç›–äº‘ç«¯ï¼‰")){
                try{ cloudSave(); }catch(e){}
            }
        }

        let isDateFullFormat = {};
        
        // æ’åºçŠ¶æ€
        let dateSortState = 'desc'; // 'none', 'asc', 'desc' - é»˜è®¤æŒ‰æ—¥æœŸé™åº
        let sellAmountSortState = 'none'; // 'none', 'asc', 'desc'
        
        // ç­›é€‰çŠ¶æ€
        let currentCustomerFilter = ''; // å½“å‰ç­›é€‰çš„ä¸‹å•äºº
        let currentProductFilter = ''; // å½“å‰ç­›é€‰çš„äº§å“
        
        // DOMå…ƒç´ 
        const tableBody = document.getElementById('table-body');
        const addBtn = document.getElementById('add-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        document.getElementById('restore-btn').addEventListener('click', openBackupRestore);
        const fileInput = document.getElementById('file-input');
        const saveBtn = document.getElementById('save-btn');
        const calculatorBtn = document.getElementById('calculator-btn');
        const totalProfitElement = document.getElementById('total-profit');
        const totalCountElement = document.getElementById('total-count');
        const toast = document.getElementById('toast');
        const dateHeader = document.getElementById('date-header');
        const dateSortIndicator = document.getElementById('date-sort');
        const sellAmountHeader = document.getElementById('sell-amount-header');
        const sellAmountSortIndicator = document.getElementById('sell-amount-sort');
        const filterStatusText = document.getElementById('filter-status-text');
        
        // ç­›é€‰ç›¸å…³DOMå…ƒç´ 
        const customerFilter = document.getElementById('customer-filter');
        const productFilter = document.getElementById('product-filter');
        const clearFilterBtn = document.getElementById('clear-filter');
        
        // è®¡ç®—å™¨ç›¸å…³DOMå…ƒç´ 
        const calculator = document.getElementById('calculator');
        const calculatorCurrent = document.getElementById('calculator-current');
        const calculatorHistory = document.getElementById('calculator-history');
        const calculatorClose = document.getElementById('calculator-close');
        const calculatorButtons = document.querySelectorAll('.calculator-btn');
        
        // åŠ è½½åŠ¨ç”»
        const loadingSpinner = document.getElementById('loading-spinner');
        
        // è®¡ç®—å™¨çŠ¶æ€
        let calculatorDisplayValue = '0';
        let calculatorHistoryValue = '';
        let firstOperand = null;
        let operator = null;
        let waitingForSecondOperand = false;
        let shouldResetDisplay = false;
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        function showLoading() {
            loadingSpinner.style.display = 'block';
        }
        
        // éšè—åŠ è½½åŠ¨ç”»
        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸ºæœˆ-æ—¥
        function formatDateToMonthDay(dateString) {
            if (!dateString || dateString === 'undefined') return 'ç‚¹å‡»è®¾ç½®';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}-${day}`;
        }
        
        // è®¡ç®—å•è¡Œåˆ©æ¶¦
        function calculateProfit(sellAmount, orderAmount, refund, shipping) {
            const sell = parseFloat(sellAmount) || 0;
            const order = parseFloat(orderAmount) || 0;
            const ref = parseFloat(refund) || 0;
            const ship = parseFloat(shipping) || 0;
            
            return sell - order - ref - ship;
        }
        
        // æ ¼å¼åŒ–è´§å¸
        function formatCurrency(amount) {
            return 'Â¥' + parseFloat(amount || 0).toFixed(1);
        }
        
        // è®¡ç®—å¹¶æ›´æ–°æ€»åˆ©æ¶¦
        function updateTotalProfit() {
            let totalProfit = 0;
            const filteredOrders = getFilteredOrders();
            
            filteredOrders.forEach(order => {
                const profit = calculateProfit(
                    order.sellAmount, 
                    order.orderAmount, 
                    order.refund, 
                    order.shipping
                );
                totalProfit += profit;
            });
            
            // æ·»åŠ æ•°å­—å˜åŒ–åŠ¨ç”»
            const currentProfit = parseFloat(totalProfitElement.textContent.replace(/[^0-9.-]+/g, ''));
            const newProfit = totalProfit;
            
            if (currentProfit !== newProfit) {
                totalProfitElement.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    totalProfitElement.style.transform = 'scale(1)';
                }, 300);
            }
            
            totalProfitElement.textContent = `æ€»åˆ©: ${formatCurrency(totalProfit)}`;
            totalProfitElement.className = `total-profit ${totalProfit >= 0 ? 'profit-positive' : 'profit-negative'}`;
            totalCountElement.textContent = filteredOrders.length;
        }
        
        // è·å–ç­›é€‰åçš„è®¢å•
        function getFilteredOrders() {
            return orders.filter(order => {
                // æ£€æŸ¥ä¸‹å•äººç­›é€‰
                const customerMatch = !currentCustomerFilter || order.customer === currentCustomerFilter;
                // æ£€æŸ¥äº§å“ç­›é€‰
                const productMatch = !currentProductFilter || order.product === currentProductFilter;
                
                return customerMatch && productMatch;
            });
        }
        
        // æ ¹æ®æ’åºçŠ¶æ€æ’åºè®¢å•
        function sortOrders(ordersToSort) {
            if (dateSortState === 'none' && sellAmountSortState === 'none') {
                return ordersToSort;
            }
            
            // åˆ›å»ºå‰¯æœ¬è¿›è¡Œæ’åº
            const sortedOrders = [...ordersToSort];
            
            sortedOrders.sort((a, b) => {
                // ä¼˜å…ˆæŒ‰æ—¥æœŸæ’åº
                if (dateSortState !== 'none') {
                    const aDate = new Date(a.date || '1970-01-01').getTime();
                    const bDate = new Date(b.date || '1970-01-01').getTime();
                    
                    if (aDate !== bDate) {
                        return dateSortState === 'desc' ? bDate - aDate : aDate - bDate;
                    }
                }
                
                // å¦‚æœæ—¥æœŸç›¸åŒï¼Œå†æŒ‰å”®å‡ºé‡‘é¢æ’åº
                if (sellAmountSortState !== 'none') {
                    const aAmount = parseFloat(a.sellAmount) || 0;
                    const bAmount = parseFloat(b.sellAmount) || 0;
                    
                    if (aAmount !== bAmount) {
                        return sellAmountSortState === 'desc' ? bAmount - aAmount : aAmount - bAmount;
                    }
                }
                
                return 0;
            });
            
            return sortedOrders;
        }
        
        // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
        function updateSortIndicators() {
            // æ›´æ–°æ—¥æœŸæ’åºæŒ‡ç¤ºå™¨
            switch(dateSortState) {
                case 'none':
                    dateSortIndicator.textContent = 'â†•';
                    dateSortIndicator.style.color = '#bdc3c7';
                    break;
                case 'asc':
                    dateSortIndicator.textContent = 'â†‘';
                    dateSortIndicator.style.color = '#2ecc71';
                    break;
                case 'desc':
                    dateSortIndicator.textContent = 'â†“';
                    dateSortIndicator.style.color = '#2ecc71';
                    break;
            }
            
            // æ›´æ–°å”®å‡ºé‡‘é¢æ’åºæŒ‡ç¤ºå™¨
            switch(sellAmountSortState) {
                case 'none':
                    sellAmountSortIndicator.textContent = 'â†•';
                    sellAmountSortIndicator.style.color = '#bdc3c7';
                    break;
                case 'asc':
                    sellAmountSortIndicator.textContent = 'â†‘';
                    sellAmountSortIndicator.style.color = '#2ecc71';
                    break;
                case 'desc':
                    sellAmountSortIndicator.textContent = 'â†“';
                    sellAmountSortIndicator.style.color = '#2ecc71';
                    break;
            }
        }
        
        // åˆ‡æ¢æ—¥æœŸæ’åºçŠ¶æ€
        function toggleDateSort() {
            const states = ['desc', 'asc', 'none'];
            const currentIndex = states.indexOf(dateSortState);
            dateSortState = states[(currentIndex + 1) % states.length];
            
            // å¦‚æœå¯ç”¨äº†æ—¥æœŸæ’åºï¼Œåˆ™ç¦ç”¨å”®å‡ºé‡‘é¢æ’åº
            if (dateSortState !== 'none') {
                sellAmountSortState = 'none';
            }
            
            // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
            dateHeader.style.transform = 'scale(0.95)';
            setTimeout(() => {
                dateHeader.style.transform = 'scale(1)';
            }, 150);
            
            updateSortIndicators();
            renderTable();
            updateTotalProfit();
            showToast(`å·²æŒ‰æ—¥æœŸ${dateSortState === 'none' ? 'å–æ¶ˆæ’åº' : dateSortState === 'asc' ? 'å‡åºæ’åº' : 'é™åºæ’åº'}`);
        }
        
        // åˆ‡æ¢å”®å‡ºé‡‘é¢æ’åºçŠ¶æ€
        function toggleSellAmountSort() {
            const states = ['none', 'asc', 'desc'];
            const currentIndex = states.indexOf(sellAmountSortState);
            sellAmountSortState = states[(currentIndex + 1) % states.length];
            
            // å¦‚æœå¯ç”¨äº†å”®å‡ºé‡‘é¢æ’åºï¼Œåˆ™ç¦ç”¨æ—¥æœŸæ’åº
            if (sellAmountSortState !== 'none') {
                dateSortState = 'none';
            }
            
            // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
            sellAmountHeader.style.transform = 'scale(0.95)';
            setTimeout(() => {
                sellAmountHeader.style.transform = 'scale(1)';
            }, 150);
            
            updateSortIndicators();
            renderTable();
            showToast(`å·²æŒ‰å”®å‡ºé‡‘é¢${sellAmountSortState === 'none' ? 'å–æ¶ˆæ’åº' : sellAmountSortState === 'asc' ? 'å‡åºæ’åº' : 'é™åºæ’åº'}`);
        }
        
        // åˆ›å»ºè¡¨æ ¼è¡Œ
        function createTableRow(order, index) {
            const row = document.createElement('tr');
            const profit = calculateProfit(order.sellAmount, order.orderAmount, order.refund, order.shipping);
            
            // å¤„ç†æ—¥æœŸæ˜¾ç¤º
            const dateDisplay = isDateFullFormat[index] ? order.date : formatDateToMonthDay(order.date);
            
            row.innerHTML = `
                <td class="date-cell" data-index="${index}" data-full-date="${order.date || ''}">${dateDisplay}</td>
                <td><input type="text" class="editable" data-field="customer" value="${order.customer || ''}"></td>
                <td><input type="text" class="editable" data-field="product" value="${order.product || ''}"></td>
                <td><input type="number" step="0.01" class="editable" data-field="orderAmount" value="${order.orderAmount || '0'}"></td>
                <td><input type="number" step="0.01" class="editable" data-field="refund" value="${order.refund || '0'}"></td>
                <td><input type="number" step="0.01" class="editable" data-field="shipping" value="${order.shipping || '0'}"></td>
                <td><input type="number" step="0.01" class="editable" data-field="sellAmount" value="${order.sellAmount || '0'}"></td>
                <td class="profit-cell" style="color: ${profit >= 0 ? '#2ecc71' : '#e74c3c'}">${formatCurrency(profit)}</td>
                <td><input type="text" class="editable" data-field="supplier" value="${order.supplier || ''}"></td>
                <td><input type="text" class="editable" data-field="trackingNumber" value="${order.trackingNumber || ''}"></td>
                <td>
                    <div style="display:flex;align-items:center;gap:4px;">
                        <input type="text" class="editable note-input" data-field="notes" value="${order.notes || ''}">
                        <button type="button" class="scan-btn" title="æ‰«ç å¡«å…¥å¤‡æ³¨">ğŸ“·</button>
                    </div>
                </td>
                <td><button class="delete-btn" data-index="${index}"><i class="fas fa-trash"></i> åˆ é™¤</button></td>
            `;
            
            return row;
        }
        
        // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
        function updateFilterStatus() {
            const filteredOrders = getFilteredOrders();
            let statusText = '';
            
            if (currentCustomerFilter && currentProductFilter) {
                statusText = `ç­›é€‰: ä¸‹å•äºº=${currentCustomerFilter}, äº§å“=${currentProductFilter} (${filteredOrders.length} æ¡è®°å½•)`;
            } else if (currentCustomerFilter) {
                statusText = `ç­›é€‰: ä¸‹å•äºº=${currentCustomerFilter} (${filteredOrders.length} æ¡è®°å½•)`;
            } else if (currentProductFilter) {
                statusText = `ç­›é€‰: äº§å“=${currentProductFilter} (${filteredOrders.length} æ¡è®°å½•)`;
            } else {
                statusText = `æ˜¾ç¤ºå…¨éƒ¨è®¢å• (${filteredOrders.length} æ¡è®°å½•)`;
            }
            
            filterStatusText.textContent = statusText;
            filterStatusText.style.color = (currentCustomerFilter || currentProductFilter) ? '#3498db' : '#bdc3c7';
        }
        
        // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
        function updateFilterOptions() {
            // è·å–æ‰€æœ‰ä¸é‡å¤çš„ä¸‹å•äºº
            const customers = [...new Set(orders.map(order => order.customer).filter(c => c))];
            // è·å–æ‰€æœ‰ä¸é‡å¤çš„äº§å“
            const products = [...new Set(orders.map(order => order.product).filter(p => p))];
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"å…¨éƒ¨ä¸‹å•äºº"é€‰é¡¹ï¼‰
            const currentCustomerValue = customerFilter.value;
            customerFilter.innerHTML = '<option value="">å…¨éƒ¨ä¸‹å•äºº</option>';
            
            // æ·»åŠ ä¸‹å•äººé€‰é¡¹
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer;
                option.textContent = customer;
                customerFilter.appendChild(option);
            });
            
            // æ¢å¤å½“å‰é€‰ä¸­çš„å€¼
            customerFilter.value = currentCustomerValue;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"å…¨éƒ¨äº§å“"é€‰é¡¹ï¼‰
            const currentProductValue = productFilter.value;
            productFilter.innerHTML = '<option value="">å…¨éƒ¨äº§å“</option>';
            
            // æ·»åŠ äº§å“é€‰é¡¹
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productFilter.appendChild(option);
            });
            
            // æ¢å¤å½“å‰é€‰ä¸­çš„å€¼
            productFilter.value = currentProductValue;
        }
        
        // åº”ç”¨ç­›é€‰
        function applyFilter() {
            currentCustomerFilter = customerFilter.value;
            currentProductFilter = productFilter.value;
            
            // æ·»åŠ ç­›é€‰åŠ¨ç”»
            tableBody.style.opacity = '0.5';
            setTimeout(() => {
                renderTable();
                tableBody.style.opacity = '1';
            }, 300);
            
            updateFilterStatus();
            
            if (currentCustomerFilter || currentProductFilter) {
                let message = 'å·²ç­›é€‰: ';
                if (currentCustomerFilter) message += `ä¸‹å•äºº=${currentCustomerFilter}`;
                if (currentCustomerFilter && currentProductFilter) message += ', ';
                if (currentProductFilter) message += `äº§å“=${currentProductFilter}`;
                showToast(message);
            } else {
                showToast('å·²æ˜¾ç¤ºå…¨éƒ¨è®¢å•');
            }
        }
        
        // æ¸…é™¤ç­›é€‰
        function clearFilter() {
            customerFilter.value = '';
            productFilter.value = '';
            currentCustomerFilter = '';
            currentProductFilter = '';
            
            // æ·»åŠ æ¸…é™¤åŠ¨ç”»
            clearFilterBtn.style.transform = 'rotate(180deg)';
            setTimeout(() => {
                clearFilterBtn.style.transform = 'rotate(0)';
            }, 300);
            
            renderTable();
            updateFilterStatus();
            showToast('ç­›é€‰å·²æ¸…é™¤ï¼Œæ˜¾ç¤ºå…¨éƒ¨è®¢å•');
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            tableBody.innerHTML = '';
            
            const filteredOrders = getFilteredOrders();
            
            if (filteredOrders.length === 0) {
                const emptyRow = document.createElement('tr');
                let message = '';
                
                if (currentCustomerFilter && currentProductFilter) {
                    message = `æ²¡æœ‰æ‰¾åˆ°ä¸‹å•äººä¸º"${currentCustomerFilter}"ä¸”äº§å“ä¸º"${currentProductFilter}"çš„è®¢å•è®°å½•`;
                } else if (currentCustomerFilter) {
                    message = `æ²¡æœ‰æ‰¾åˆ°ä¸‹å•äººä¸º"${currentCustomerFilter}"çš„è®¢å•è®°å½•`;
                } else if (currentProductFilter) {
                    message = `æ²¡æœ‰æ‰¾åˆ°äº§å“ä¸º"${currentProductFilter}"çš„è®¢å•è®°å½•`;
                } else {
                    message = 'æš‚æ— è®¢å•æ•°æ®ï¼Œç‚¹å‡»ä¸Šæ–¹"æ–°å¢"æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡è®¢å•è®°å½•';
                }
                
                emptyRow.innerHTML = `<td colspan="12" style="text-align: center; padding: 20px; color: #7f8c8d;">${message}</td>`;
                tableBody.appendChild(emptyRow);
                return;
            }
            
            // æ ¹æ®æ’åºçŠ¶æ€è·å–è®¢å•åˆ—è¡¨
            const ordersToRender = sortOrders(filteredOrders);
            
            // æ¸²æŸ“è®¢å•è¡Œ
            ordersToRender.forEach((order, index) => {
                // è·å–åŸå§‹ç´¢å¼•
                const originalIndex = orders.indexOf(order);
                const row = createTableRow(order, originalIndex);
                
                // è®¾ç½®è¡Œçš„å»¶è¿ŸåŠ¨ç”»
                row.style.animationDelay = `${index * 0.05}s`;
                tableBody.appendChild(row);
            });
            
            // é‡æ–°ç»‘å®šäº‹ä»¶
            bindEvents();
            
            // æ›´æ–°æ€»åˆ©æ¶¦
            updateTotalProfit();
            
            // æ›´æ–°ç­›é€‰çŠ¶æ€
            updateFilterStatus();
        }
        
        // æ·»åŠ æ–°è¡Œ
        function addNewRow() {
            // æ·»åŠ æŒ‰é’®ç‚¹å‡»åŠ¨ç”»
            addBtn.style.transform = 'scale(0.95)';
            setTimeout(() => {
                addBtn.style.transform = 'scale(1)';
            }, 150);
            
            const newOrder = {
                date: new Date().toISOString().split('T')[0],
                customer: '',
                product: '',
                orderAmount: '0',
                refund: '0',
                shipping: '0',
                sellAmount: '0',
                supplier: '', // æ–°å¢è´§å•†å­—æ®µ
                trackingNumber: '',
                notes: ''
            };
            
            // æ–°è®¢å•æ·»åŠ åˆ°æ•°ç»„å¼€å¤´
            orders.unshift(newOrder);
            
            // ç¡®ä¿æŒ‰æ—¥æœŸé™åºæ’åº
            dateSortState = 'desc';
            sellAmountSortState = 'none';
            
            // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
            updateFilterOptions();
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderTable();
            
            // é«˜äº®æ˜¾ç¤ºæ–°æ·»åŠ çš„è¡Œ
            const firstRow = tableBody.querySelector('tr');
            if (firstRow) {
                firstRow.classList.add('row-added');
                setTimeout(() => {
                    firstRow.classList.remove('row-added');
                }, 1000);
            }
            
            showToast('å·²æ·»åŠ æ–°è®¢å•è¡Œï¼Œè¯·ç¼–è¾‘ä¿¡æ¯');
        }
        
        // åˆ é™¤è¡Œ
        function deleteRow(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®¢å•è®°å½•å—ï¼Ÿ')) {
                // ä»æ•°ç»„ä¸­åˆ é™¤
                const deletedCustomer = orders[index].customer;
                const deletedProduct = orders[index].product;
                orders.splice(index, 1);
                
                // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
                updateFilterOptions();
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç­›é€‰çš„ä¸‹å•äººæˆ–äº§å“ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…é™¤ç­›é€‰
                if (currentCustomerFilter === deletedCustomer || currentProductFilter === deletedProduct) {
                    // é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼Œç­›é€‰å™¨ä¼šè‡ªåŠ¨å¤„ç†
                    renderTable();
                } else {
                    renderTable();
                }
                
                showToast('è®¢å•å·²åˆ é™¤');
            }
        }
        
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveData() {
            try {
                // ä»è¡¨æ ¼ä¸­è·å–æœ€æ–°æ•°æ®
                updateOrdersFromTable();
                
                // æ·»åŠ ä¿å­˜åŠ¨ç”»
                saveBtn.innerHTML = '<i class="fas fa-check"></i> ä¿å­˜ä¸­...';
                saveBtn.style.background = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
                
                setTimeout(() => {
                    localStorage.setItem('orderProfitData', JSON.stringify(orders));
                    
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜';
                    saveBtn.style.background = 'linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%)';
                    
                    showToast('æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                }, 500);
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®æ—¶å‡ºé”™:', error);
                showToast('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // ä»è¡¨æ ¼ä¸­æ›´æ–°è®¢å•æ•°æ®
        function updateOrdersFromTable() {
            const rows = tableBody.querySelectorAll('tr');
            
            // éå†æ‰€æœ‰è¡Œ
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                
                // è·³è¿‡ç©ºè¡Œæç¤º
                if (row.cells.length <= 1) continue;
                
                const inputs = row.querySelectorAll('input');
                if (inputs.length === 0) continue;
                
                // è·å–è¡Œçš„åŸå§‹ç´¢å¼•
                const dateCell = row.querySelector('.date-cell');
                const indexAttr = dateCell ? dateCell.getAttribute('data-index') : null;
                
                if (indexAttr === null || indexAttr === undefined) continue;
                
                const index = parseInt(indexAttr);
                
                // å¦‚æœç´¢å¼•æœ‰æ•ˆï¼Œæ›´æ–°å¯¹åº”çš„è®¢å•æ•°æ®
                if (index >= 0 && index < orders.length) {
                    // è·å–æ—¥æœŸ
                    const dateValue = dateCell ? dateCell.getAttribute('data-full-date') : '';
                    
                    // æ›´æ–°è®¢å•æ•°æ®ï¼ˆæ³¨æ„ï¼šç°åœ¨æœ‰8ä¸ªè¾“å…¥æ¡†ï¼Œå› ä¸ºå¢åŠ äº†è´§å•†åˆ—ï¼‰
                    orders[index].date = dateValue || new Date().toISOString().split('T')[0];
                    orders[index].customer = inputs[0] ? inputs[0].value : '';
                    orders[index].product = inputs[1] ? inputs[1].value : '';
                    orders[index].orderAmount = inputs[2] ? inputs[2].value : '0';
                    orders[index].refund = inputs[3] ? inputs[3].value : '0';
                    orders[index].shipping = inputs[4] ? inputs[4].value : '0';
                    orders[index].sellAmount = inputs[5] ? inputs[5].value : '0';
                    orders[index].supplier = inputs[6] ? inputs[6].value : ''; // è´§å•†å­—æ®µ
                    orders[index].trackingNumber = inputs[7] ? inputs[7].value : '';
                    orders[index].notes = inputs[8] ? inputs[8].value : '';
                }
            }
            
            // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
            updateFilterOptions();
        }
        
        // å¯¼å‡ºä¸ºExcel
        function exportToExcel() {
            try {
                // é¦–å…ˆæ›´æ–°è¡¨æ ¼ä¸­çš„æ•°æ®åˆ°ordersæ•°ç»„
                updateOrdersFromTable();
                
                // æ·»åŠ å¯¼å‡ºåŠ¨ç”»
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¯¼å‡ºä¸­...';
                showLoading();
                
                setTimeout(() => {
                    // å‡†å¤‡å¯¼å‡ºæ•°æ®
                    const exportData = orders.map(order => {
                        const profit = calculateProfit(
                            order.sellAmount, 
                            order.orderAmount, 
                            order.refund, 
                            order.shipping
                        );
                        
                        return {
                            'æ—¥æœŸ': order.date,
                            'ä¸‹å•äºº': order.customer,
                            'äº§å“': order.product,
                            'ä¸‹å•é‡‘é¢': parseFloat(order.orderAmount) || 0,
                            'è¿”æ¬¾': parseFloat(order.refund) || 0,
                            'è¿è´¹': parseFloat(order.shipping) || 0,
                            'å”®å‡ºé‡‘é¢': parseFloat(order.sellAmount) || 0,
                            'åˆ©æ¶¦': profit,
                            'è´§å•†': order.supplier || '', // æ·»åŠ è´§å•†åˆ—
                            'ç‰©æµå•å·': order.trackingNumber,
                            'å¤‡æ³¨': order.notes
                        };
                    });
                    
                    // æ·»åŠ æ±‡æ€»è¡Œ
                    const totalProfit = exportData.reduce((sum, row) => sum + row.åˆ©æ¶¦, 0);
                    exportData.push({
                        'æ—¥æœŸ': 'æ±‡æ€»',
                        'ä¸‹å•äºº': '',
                        'äº§å“': '',
                        'ä¸‹å•é‡‘é¢': '',
                        'è¿”æ¬¾': '',
                        'è¿è´¹': '',
                        'å”®å‡ºé‡‘é¢': 'æ€»è®¡',
                        'åˆ©æ¶¦': totalProfit,
                        'è´§å•†': '',
                        'ç‰©æµå•å·': '',
                        'å¤‡æ³¨': ''
                    });
                    
                    // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
                    const worksheet = XLSX.utils.json_to_sheet(exportData);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'è®¢å•åˆ©æ¶¦æ•°æ®');
                    
                    // è®¾ç½®åˆ—å®½
                    const wscols = [
                        {wch: 12}, // æ—¥æœŸ
                        {wch: 10}, // ä¸‹å•äºº
                        {wch: 20}, // äº§å“
                        {wch: 10}, // ä¸‹å•é‡‘é¢
                        {wch: 10}, // è¿”æ¬¾
                        {wch: 10}, // è¿è´¹
                        {wch: 10}, // å”®å‡ºé‡‘é¢
                        {wch: 10}, // åˆ©æ¶¦
                        {wch: 15}, // è´§å•†
                        {wch: 20}, // ç‰©æµå•å·
                        {wch: 30}  // å¤‡æ³¨
                    ];
                    worksheet['!cols'] = wscols;
                    
                    // ç”Ÿæˆæ–‡ä»¶å
                    const dateStr = new Date().toISOString().split('T')[0];
                    const filename = `è®¢å•åˆ©æ¶¦æ•°æ®_${dateStr}.xlsx`;
                    
                    // å¯¼å‡ºæ–‡ä»¶
                    XLSX.writeFile(workbook, filename);
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    exportBtn.innerHTML = '<i class="fas fa-file-export"></i> å¯¼å‡º';
                    hideLoading();
                    
                    showToast('æ•°æ®å·²å¯¼å‡ºä¸ºExcelæ–‡ä»¶');
                }, 1000);
            } catch (error) {
                console.error('å¯¼å‡ºExcelæ—¶å‡ºé”™:', error);
                exportBtn.innerHTML = '<i class="fas fa-file-export"></i> å¯¼å‡º';
                hideLoading();
                showToast('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }
        
        // ä»Excelå¯¼å…¥
        function importFromExcel(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // è½¬æ¢æ•°æ®æ ¼å¼
                    const importedOrders = jsonData
                        .filter(row => row['æ—¥æœŸ'] && row['æ—¥æœŸ'] !== 'æ±‡æ€»')
                        .map(row => ({
                            date: row['æ—¥æœŸ'] instanceof Date ? 
                                  row['æ—¥æœŸ'].toISOString().split('T')[0] : 
                                  String(row['æ—¥æœŸ'] || ''),
                            customer: String(row['ä¸‹å•äºº'] || ''),
                            product: String(row['äº§å“'] || ''),
                            orderAmount: String(row['ä¸‹å•é‡‘é¢'] || '0'),
                            refund: String(row['è¿”æ¬¾'] || '0'),
                            shipping: String(row['è¿è´¹'] || '0'),
                            sellAmount: String(row['å”®å‡ºé‡‘é¢'] || '0'),
                            supplier: String(row['è´§å•†'] || ''), // æ–°å¢ï¼šè¯»å–è´§å•†åˆ—
                            trackingNumber: String(row['ç‰©æµå•å·'] || ''),
                            notes: String(row['å¤‡æ³¨'] || '')
                        }));
                    
                    if (importedOrders.length === 0) {
                        showToast('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„è®¢å•æ•°æ®');
                        return;
                    }
                    
                    // ç¡®è®¤å¯¼å…¥
                    if (confirm(`ä»Excelæ–‡ä»¶ä¸­æ‰¾åˆ° ${importedOrders.length} æ¡è®¢å•è®°å½•ï¼Œæ˜¯å¦å¯¼å…¥ï¼Ÿ`)) {
                        orders = importedOrders;
                        // é‡ç½®æ’åºçŠ¶æ€ä¸ºæ—¥æœŸé™åº
                        dateSortState = 'desc';
                        sellAmountSortState = 'none';
                        updateSortIndicators();
                        // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
                        updateFilterOptions();
                        renderTable();
                        showToast(`æˆåŠŸå¯¼å…¥ ${importedOrders.length} æ¡è®¢å•è®°å½•`);
                    }
                } catch (error) {
                    console.error('å¯¼å…¥Excelæ—¶å‡ºé”™:', error);
                    showToast('å¯¼å…¥å¤±è´¥: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ç»‘å®šè¾“å…¥æ¡†å˜åŒ–äº‹ä»¶
            const inputs = tableBody.querySelectorAll('input');
            inputs.forEach(input => {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
                
                newInput.addEventListener('change', function() {
                    const row = this.closest('tr');
                    const indexAttr = row.querySelector('.date-cell')?.getAttribute('data-index');
                    
                    if (indexAttr === null || indexAttr === undefined) return;
                    
                    const index = parseInt(indexAttr);
                    const field = this.getAttribute('data-field');
                    
                    // æ›´æ–°æ•°æ®
                    if (index >= 0 && index < orders.length) {
                        orders[index][field] = this.value;
                        
                        // å¦‚æœæ˜¯ä¸‹å•äººæˆ–äº§å“å­—æ®µå‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°ç­›é€‰å™¨é€‰é¡¹
                        if (field === 'customer' || field === 'product') {
                            updateFilterOptions();
                        }
                        
                        // é‡æ–°è®¡ç®—åˆ©æ¶¦
                        const profitCell = row.querySelector('.profit-cell');
                        if (profitCell) {
                            const profit = calculateProfit(
                                orders[index].sellAmount,
                                orders[index].orderAmount,
                                orders[index].refund,
                                orders[index].shipping
                            );
                            
                            // æ·»åŠ åˆ©æ¶¦å˜åŒ–åŠ¨ç”»
                            profitCell.style.transform = 'scale(1.2)';
                            setTimeout(() => {
                                profitCell.style.transform = 'scale(1)';
                            }, 300);
                            
                            profitCell.textContent = formatCurrency(profit);
                            profitCell.style.color = profit >= 0 ? '#2ecc71' : '#e74c3c';
                            
                            // æ›´æ–°æ€»åˆ©æ¶¦
                            updateTotalProfit();
                        }
                    }
                });
                
                // å®æ—¶è®¡ç®—
                newInput.addEventListener('input', function() {
                    if (this.hasAttribute('data-field')) {
                        const row = this.closest('tr');
                        const field = this.getAttribute('data-field');
                        
                        if (field === 'orderAmount' || field === 'refund' || 
                            field === 'shipping' || field === 'sellAmount') {
                            
                            const orderAmountInput = row.querySelector('input[data-field="orderAmount"]');
                            const refundInput = row.querySelector('input[data-field="refund"]');
                            const shippingInput = row.querySelector('input[data-field="shipping"]');
                            const sellAmountInput = row.querySelector('input[data-field="sellAmount"]');
                            
                            if (!orderAmountInput || !refundInput || !shippingInput || !sellAmountInput) return;
                            
                            const orderAmount = parseFloat(orderAmountInput.value) || 0;
                            const refund = parseFloat(refundInput.value) || 0;
                            const shipping = parseFloat(shippingInput.value) || 0;
                            const sellAmount = parseFloat(sellAmountInput.value) || 0;
                            
                            const profit = sellAmount - orderAmount - refund - shipping;
                            const profitCell = row.querySelector('.profit-cell');
                            
                            if (profitCell) {
                                profitCell.textContent = formatCurrency(profit);
                                profitCell.style.color = profit >= 0 ? '#2ecc71' : '#e74c3c';
                                
                                // æ›´æ–°æ€»åˆ©æ¶¦
                                updateTotalProfit();
                            }
                        }
                    }
                });
                
                // æ·»åŠ è¾“å…¥æ¡†ç„¦ç‚¹åŠ¨ç”»
                newInput.addEventListener('focus', function() {
                    this.parentElement.style.transform = 'translateY(-2px)';
                });
                
                newInput.addEventListener('blur', function() {
                    this.parentElement.style.transform = 'translateY(0)';
                });
            });
            
            // ç»‘å®šæ—¥æœŸå•å…ƒæ ¼ç‚¹å‡»äº‹ä»¶
            const dateCells = tableBody.querySelectorAll('.date-cell');
            dateCells.forEach(cell => {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newCell = cell.cloneNode(true);
                cell.parentNode.replaceChild(newCell, cell);
                
                newCell.addEventListener('click', function() {
                    // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 150);
                    
                    const index = this.getAttribute('data-index');
                    const fullDate = this.getAttribute('data-full-date');
                    
                    if (!fullDate || fullDate === 'undefined' || fullDate === '') {
                        // å¦‚æœæ²¡æœ‰æ—¥æœŸï¼Œè®¾ç½®ä¸ºä»Šå¤©
                        const today = new Date().toISOString().split('T')[0];
                        this.setAttribute('data-full-date', today);
                        this.textContent = formatDateToMonthDay(today);
                        
                        // æ›´æ–°æ•°æ®
                        const rowIndex = parseInt(index);
                        if (rowIndex >= 0 && rowIndex < orders.length) {
                            orders[rowIndex].date = today;
                        }
                        return;
                    }
                    
                    if (isDateFullFormat[index]) {
                        // åˆ‡æ¢åˆ°ç®€ç•¥æ ¼å¼
                        this.textContent = formatDateToMonthDay(fullDate);
                        isDateFullFormat[index] = false;
                    } else {
                        // åˆ‡æ¢åˆ°å®Œæ•´æ ¼å¼
                        const date = new Date(fullDate);
                        if (!isNaN(date.getTime())) {
                            this.textContent = date.toLocaleDateString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            });
                        } else {
                            this.textContent = fullDate;
                        }
                        isDateFullFormat[index] = true;
                    }
                });
            });
            
            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            const deleteButtons = tableBody.querySelectorAll('.delete-btn');
            deleteButtons.forEach(button => {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                newButton.addEventListener('click', function() {
                    // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
                    this.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 150);
                    
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteRow(index);
                });
            });
        }
        
        // è®¡ç®—å™¨åŠŸèƒ½
        function initCalculator() {
            // æ˜¾ç¤ºè®¡ç®—å™¨
            calculatorBtn.addEventListener('click', function() {
                calculator.classList.add('show');
            });
            
            // å…³é—­è®¡ç®—å™¨
            calculatorClose.addEventListener('click', function() {
                calculator.classList.remove('show');
            });
            
            // è®¡ç®—å™¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            calculatorButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // æ·»åŠ æŒ‰é’®ç‚¹å‡»åŠ¨ç”»
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 100);
                    
                    const action = this.getAttribute('data-action');
                    const number = this.getAttribute('data-number');
                    
                    if (number !== null) {
                        inputNumber(number);
                    } else if (action !== null) {
                        handleAction(action);
                    }
                    
                    // æ›´æ–°æ˜¾ç¤º
                    updateCalculatorDisplay();
                });
            });
            
            // è¾“å…¥æ•°å­—
            function inputNumber(number) {
                if (waitingForSecondOperand) {
                    calculatorDisplayValue = number;
                    waitingForSecondOperand = false;
                } else {
                    calculatorDisplayValue = calculatorDisplayValue === '0' ? number : calculatorDisplayValue + number;
                }
                
                // æ›´æ–°å†å²æ˜¾ç¤º
                if (operator !== null && firstOperand !== null && !waitingForSecondOperand) {
                    calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)} ${calculatorDisplayValue}`;
                } else if (operator !== null && firstOperand !== null && waitingForSecondOperand) {
                    calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)}`;
                } else {
                    calculatorHistoryValue = '';
                }
            }
            
            // å¤„ç†æ“ä½œç¬¦
            function handleAction(action) {
                switch (action) {
                    case 'clear':
                        // å®Œå…¨æ¸…é™¤
                        calculatorDisplayValue = '0';
                        calculatorHistoryValue = '';
                        firstOperand = null;
                        operator = null;
                        waitingForSecondOperand = false;
                        shouldResetDisplay = false;
                        break;
                    case 'clear-entry':
                        // æ¸…é™¤å½“å‰è¾“å…¥
                        calculatorDisplayValue = '0';
                        if (operator !== null && firstOperand !== null) {
                            calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)}`;
                        } else {
                            calculatorHistoryValue = '';
                        }
                        break;
                    case 'decimal':
                        if (!calculatorDisplayValue.includes('.')) {
                            calculatorDisplayValue += '.';
                        }
                        break;
                    case 'percent':
                        const currentValue = parseFloat(calculatorDisplayValue);
                        calculatorDisplayValue = (currentValue / 100).toString();
                        calculatorHistoryValue = `${currentValue}% =`;
                        break;
                    case 'add':
                    case 'subtract':
                    case 'multiply':
                    case 'divide':
                        handleOperator(action);
                        break;
                    case 'equals':
                        if (operator && firstOperand !== null) {
                            const secondOperand = parseFloat(calculatorDisplayValue);
                            const result = calculate(firstOperand, secondOperand, operator);
                            
                            // ç¡®ä¿ç»“æœæ˜¯ç²¾ç¡®çš„ï¼Œé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
                            const preciseResult = Math.round(result * 1000000) / 1000000;
                            
                            // æ˜¾ç¤ºå®Œæ•´è®¡ç®—è¿‡ç¨‹
                            calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)} ${secondOperand} =`;
                            calculatorDisplayValue = preciseResult.toString();
                            
                            // æ·»åŠ è®¡ç®—ç»“æœåŠ¨ç”»
                            calculatorCurrent.style.transform = 'scale(1.1)';
                            setTimeout(() => {
                                calculatorCurrent.style.transform = 'scale(1)';
                            }, 300);
                            
                            // é‡ç½®çŠ¶æ€ï¼Œä½†ä¿ç•™ç»“æœä½œä¸ºä¸‹ä¸€æ¬¡è®¡ç®—çš„ç¬¬ä¸€ä¸ªæ“ä½œæ•°
                            firstOperand = preciseResult;
                            waitingForSecondOperand = true;
                            shouldResetDisplay = true;
                        }
                        break;
                }
            }
            
            // å¤„ç†è¿ç®—ç¬¦
            function handleOperator(nextOperator) {
                const inputValue = parseFloat(calculatorDisplayValue);
                
                if (operator !== null && !waitingForSecondOperand) {
                    // å¦‚æœå·²ç»æœ‰æ“ä½œç¬¦å’Œç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼Œå¹¶ä¸”å·²ç»è¾“å…¥äº†ç¬¬äºŒä¸ªæ“ä½œæ•°ï¼Œå…ˆè®¡ç®—
                    const result = calculate(firstOperand, inputValue, operator);
                    const preciseResult = Math.round(result * 1000000) / 1000000;
                    calculatorDisplayValue = preciseResult.toString();
                    firstOperand = preciseResult;
                } else {
                    // å¦åˆ™è®¾ç½®ç¬¬ä¸€ä¸ªæ“ä½œæ•°
                    firstOperand = inputValue;
                }
                
                operator = nextOperator;
                waitingForSecondOperand = true;
                shouldResetDisplay = true;
                
                // æ›´æ–°å†å²æ˜¾ç¤º
                calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)}`;
            }
            
            // æ‰§è¡Œè®¡ç®—
            function calculate(first, second, operator) {
                switch (operator) {
                    case 'add': return first + second;
                    case 'subtract': return first - second;
                    case 'multiply': return first * second;
                    case 'divide': return first / second;
                    default: return second;
                }
            }
            
            // è·å–æ“ä½œç¬¦ç¬¦å·
            function getOperatorSymbol(op) {
                switch (op) {
                    case 'add': return '+';
                    case 'subtract': return '-';
                    case 'multiply': return 'Ã—';
                    case 'divide': return 'Ã·';
                    default: return '';
                }
            }
            
            // æ ¼å¼åŒ–æ˜¾ç¤ºæ•°å­—
            function formatDisplayNumber(numStr) {
                const num = parseFloat(numStr);
                if (isNaN(num)) return '0';
                
                // å¦‚æœæ˜¯æ•´æ•°ï¼Œä¸æ˜¾ç¤ºå°æ•°ç‚¹
                if (Number.isInteger(num)) {
                    return num.toString();
                }
                
                // å¦åˆ™æ˜¾ç¤ºæœ€å¤š6ä½å°æ•°
                return num.toFixed(6).replace(/\.?0+$/, '');
            }
            
            // æ›´æ–°è®¡ç®—å™¨æ˜¾ç¤º
            function updateCalculatorDisplay() {
                calculatorCurrent.textContent = formatDisplayNumber(calculatorDisplayValue);
                calculatorHistory.textContent = calculatorHistoryValue;
            }
        }
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            addBtn.addEventListener('click', addNewRow);
            exportBtn.addEventListener('click', exportToExcel);
            importBtn.addEventListener('click', () => fileInput.click());
            saveBtn.addEventListener('click', saveData);
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    importFromExcel(this.files[0]);
                    this.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥
                }
            });
            
            // ç»‘å®šæ’åºäº‹ä»¶
            dateHeader.addEventListener('click', toggleDateSort);
            sellAmountHeader.addEventListener('click', toggleSellAmountSort);
            
            // ç»‘å®šç­›é€‰äº‹ä»¶
            customerFilter.addEventListener('change', applyFilter);
            productFilter.addEventListener('change', applyFilter);
            clearFilterBtn.addEventListener('click', clearFilter);
            
            // åˆå§‹åŒ–è®¡ç®—å™¨
            initCalculator();
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
            updateFilterOptions();
            
            renderTable();
            initEventListeners();
            updateSortIndicators();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„æ•°æ®
            if (orders.length > 0) {
                showToast(`å·²åŠ è½½ ${orders.length} æ¡è®¢å•è®°å½•ï¼Œé»˜è®¤æŒ‰æ—¥æœŸé™åºæ’åˆ—`);
            } else {
                showToast('æ¬¢è¿ä½¿ç”¨è®¢å•åˆ©æ¶¦ç®¡ç†ç³»ç»Ÿï¼Œç‚¹å‡»"æ–°å¢"æŒ‰é’®å¼€å§‹æ·»åŠ è®¢å•');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);
        
        // ç›‘å¬é¡µé¢ç¦»å¼€å‰ä¿å­˜æ•°æ®
        window.addEventListener('beforeunload', function() {
            // æ‹‰å–äº‘ç«¯ååˆ·æ–°é¡µé¢æ—¶ï¼Œé¿å…æ—§å†…å­˜æ•°æ®è¦†ç›–åˆšæ‹‰å–çš„æ•°æ®
            if (window.__skipBeforeUnloadSave) return;
            updateOrdersFromTable();
            localStorage.setItem('orderProfitData', JSON.stringify(orders));
        });
        
        /* ========= å¤‡æ³¨æ‰«ç åŠŸèƒ½ ========= */
        let currentScanTargetInput = null;
        let html5QrCode = null;

        // åˆ›å»ºæ‰«ææ¨¡æ€æ¡†
        const scannerModal = document.createElement('div');
        scannerModal.id = 'scannerModal';
        scannerModal.innerHTML = `
        <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div style="font-weight:600;color:#2c3e50;">æ‰«æäºŒç»´ç </div>
                <div style="color:#e74c3c;font-size:16px;cursor:pointer;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.3s ease;" id="closeScannerBtn">âœ–</div>
            </div>
            <div id="reader" style="width:100%;"></div>
            <div style="text-align:center;margin-top:10px;color:#7f8c8d;font-size:12px;">å°†äºŒç»´ç å¯¹å‡†æ‘„åƒå¤´åŒºåŸŸ</div>
        </div>
        `;
        document.body.appendChild(scannerModal);

        function openScanner(inputEl){
            currentScanTargetInput = inputEl;
            scannerModal.classList.add('show');

            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                decodedText => {
                    currentScanTargetInput.value = decodedText;
                    currentScanTargetInput.dispatchEvent(new Event('change'));
                    closeScanner();
                    showToast('äºŒç»´ç æ‰«ææˆåŠŸ');
                }
            ).catch(err=>{
                showToast("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™");
                closeScanner();
            });
        }

        function closeScanner(){
            scannerModal.classList.remove('show');
            if(html5QrCode){
                html5QrCode.stop().then(()=>html5QrCode.clear());
                html5QrCode = null;
            }
        }

        document.addEventListener('click', function(e){
            if(e.target && e.target.classList.contains('scan-btn')){
                const input = e.target.closest('td').querySelector('.note-input');
                if(input) openScanner(input);
            }
            if(e.target && e.target.id === 'closeScannerBtn'){
                closeScanner();
            }
        });
    </script>
<script>if('serviceWorker'in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));}</script>
<script>
/* ========= è®¡ç®—å™¨ï¼šå¼¹çª—å±…ä¸­ + å¯æ‹–åŠ¨ï¼ˆç§»åŠ¨ç«¯è§¦æ‘¸æ‹–åŠ¨ï¼‰ ========= */
(function(){
  const POS_KEY = "calcPos_v1";
  const calc = document.getElementById("calculator");
  const btnOpen = document.getElementById("calculator-btn");
  const btnClose = document.getElementById("calculator-close");
  const header = calc ? calc.querySelector(".calculator-header") : null;

  if(!calc || !btnOpen || !btnClose || !header) return;

  // è®©å®ƒæ›´åƒå¼¹çª—ï¼šæå‡å±‚çº§ï¼Œç§»é™¤åº•éƒ¨è§’è½å®šä½ï¼ˆåªåœ¨æ‰“å¼€æ—¶è®¾ç½®ï¼‰
  function applyPopupStyle(){
    calc.style.bottom = "auto";
    calc.style.right  = "auto";
    calc.style.left   = calc.style.left || "10px";
    calc.style.top    = calc.style.top  || "80px";
    calc.style.zIndex = "10050";
    calc.style.width  = "min(340px, 92vw)";
    calc.style.maxWidth = "92vw";
  }

  function centerIfNoPos(){
    const saved = localStorage.getItem(POS_KEY);
    if(saved){
      try{
        const p = JSON.parse(saved);
        if(typeof p.left==="number" && typeof p.top==="number"){
          calc.style.left = p.left + "px";
          calc.style.top  = p.top + "px";
          return;
        }
      }catch{}
    }
    const r = calc.getBoundingClientRect();
    const w = r.width || 320;
    const h = r.height || 440;
    calc.style.left = Math.max(8, (window.innerWidth - w)/2) + "px";
    calc.style.top  = Math.max(60, (window.innerHeight - h)/4) + "px";
  }

  function savePos(){
    const r = calc.getBoundingClientRect();
    localStorage.setItem(POS_KEY, JSON.stringify({left: Math.round(r.left), top: Math.round(r.top)}));
  }

  function openCalc(){
    applyPopupStyle();
    calc.classList.add("show");
    // ç­‰æ˜¾ç¤ºåå†å±…ä¸­
    setTimeout(()=>{
      centerIfNoPos();
    }, 0);
  }

  function closeCalc(){
    calc.classList.remove("show");
    savePos();
  }

  btnOpen.addEventListener("click", openCalc);
  btnClose.addEventListener("click", closeCalc);

  // è§¦æ‘¸æ‹–åŠ¨ï¼ˆåªæ‹–headerï¼‰
  let dragging=false, offsetX=0, offsetY=0;

  header.style.cursor = "move";
  header.style.touchAction = "none";

  function clamp(){
    const r = calc.getBoundingClientRect();
    let left = r.left, top = r.top;
    left = Math.min(Math.max(8, left), window.innerWidth - 80);
    top  = Math.min(Math.max(8, top), window.innerHeight - 80);
    calc.style.left = left + "px";
    calc.style.top  = top + "px";
  }

  header.addEventListener("touchstart", (e)=>{
    const t = e.touches[0]; if(!t) return;
    dragging = true;
    const r = calc.getBoundingClientRect();
    offsetX = t.clientX - r.left;
    offsetY = t.clientY - r.top;
  }, {passive:true});

  document.addEventListener("touchmove", (e)=>{
    if(!dragging) return;
    const t = e.touches[0]; if(!t) return;
    calc.style.left = (t.clientX - offsetX) + "px";
    calc.style.top  = (t.clientY - offsetY) + "px";
    clamp();
  }, {passive:true});

  document.addEventListener("touchend", ()=>{
    if(!dragging) return;
    dragging = false;
    savePos();
  });

  // æ¡Œé¢é¼ æ ‡æ‹–åŠ¨ï¼ˆç”µè„‘ä¹Ÿå¥½ç”¨ï¼‰
  header.addEventListener("mousedown", (e)=>{
    dragging = true;
    const r = calc.getBoundingClientRect();
    offsetX = e.clientX - r.left;
    offsetY = e.clientY - r.top;
    document.body.style.userSelect = "none";
  });
  document.addEventListener("mousemove", (e)=>{
    if(!dragging) return;
    calc.style.left = (e.clientX - offsetX) + "px";
    calc.style.top  = (e.clientY - offsetY) + "px";
    clamp();
  });
  document.addEventListener("mouseup", ()=>{
    if(!dragging) return;
    dragging = false;
    document.body.style.userSelect = "";
    savePos();
  });

  // æ—‹è½¬/çª—å£å˜åŒ–æ—¶ï¼Œä¿è¯ä¸é£å‡ºå±å¹•
  window.addEventListener("resize", ()=>{
    if(calc.classList.contains("show")) clamp();
  });
})();
</script>


<script>
/* ========= æ‰«ç ï¼šç”Ÿäº§çº§ç¨³å®šç‰ˆï¼ˆä¼˜å…ˆBarcodeDetectorï¼Œå…¼å®¹ZXingï¼‰ ========= */
(function(){
  // toastå…œåº•
  function toast(msg){
    // ä¸ç”¨ alertï¼ˆä¼šå‡ºç°ç³»ç»Ÿå¼¹çª—ï¼‰ï¼Œæ”¹ä¸ºè½»é‡æç¤ºï¼Œè‡ªåŠ¨æ¶ˆå¤±
    if(typeof window.showToast==="function") return window.showToast(msg);
    try{
      let t=document.getElementById("scanToastLite");
      if(!t){
        t=document.createElement("div");
        t.id="scanToastLite";
        t.style.cssText="position:fixed;left:50%;bottom:90px;transform:translateX(-50%);background:#000c;color:#fff;padding:10px 12px;border-radius:12px;font-size:13px;z-index:10090;max-width:82vw;text-align:center;";
        document.body.appendChild(t);
      }
      t.textContent=msg;
      t.style.display="block";
      clearTimeout(t._timer);
      t._timer=setTimeout(()=>t.style.display="none",1200);
    }catch(_e){}
  }
  function secureOK(){
    return window.isSecureContext || location.hostname==="localhost" || location.hostname==="127.0.0.1";
  }
  async function ensureZXing(){
    if(window.ZXing) return;
    await new Promise((resolve,reject)=>{
      const s=document.createElement("script");
      s.src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js";
      s.onload=resolve; s.onerror=()=>reject(new Error("ZXingåŠ è½½å¤±è´¥"));
      document.head.appendChild(s);
    });
  }

  // Modal
  if(document.getElementById("scannerModalV2")) return;
  const modal=document.createElement("div");
  modal.id="scannerModalV2";
  modal.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:10060;";
  modal.innerHTML=`
    <div style="width:min(460px,94vw);background:#000;border-radius:16px;overflow:hidden;">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;color:#fff;background:rgba(0,0,0,.55)">
        <span style="font-size:13px;opacity:.9">æ‰«ç ï¼ˆæ¡ç /äºŒç»´ç ï¼‰</span>
        <button id="scanCloseBtn" style="border:none;background:none;color:#fff;font-size:18px;cursor:pointer">âœ•</button>
      </div>
      <div style="position:relative">
        <video id="scanVideo" playsinline muted style="width:100%;height:auto;display:block;"></video>
        <div style="position:absolute;inset:18%;border:2px solid #2ecc71;border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.45) inset;"></div>
      </div>
      <div id="scanHint" style="padding:6px 9px;text-align:center;color:#9ca3af;font-size:12px;background:#000">å‡†å¤‡ä¸­â€¦</div>
    </div>`;
  document.body.appendChild(modal);

  const hint = (t)=>{ const el=document.getElementById("scanHint"); if(el) el.textContent=t||""; };

  let stream=null, track=null, raf=null, targetInput=null;

  function stop(){
    if(raf) cancelAnimationFrame(raf);
    raf=null;
    if(track){ try{track.stop();}catch{} track=null; }
    if(stream){ try{stream.getTracks().forEach(t=>t.stop());}catch{} stream=null; }
    const v=document.getElementById("scanVideo");
    if(v) v.srcObject=null;
    modal.style.display="none";
    hint("å‡†å¤‡ä¸­â€¦");
  }

  document.getElementById("scanCloseBtn").addEventListener("click", stop);

  async function start(input){
    if(!secureOK()){
      toast("éœ€è¦ HTTPS æ‰èƒ½ä½¿ç”¨æ‘„åƒå¤´ï¼ˆè¯·ç”¨httpsæ‰“å¼€ï¼‰");
      return;
    }
    targetInput=input;
    modal.style.display="flex";
    hint("æ­£åœ¨æ‰“å¼€æ‘„åƒå¤´â€¦");
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false});
      track = stream.getVideoTracks()[0];
      const v=document.getElementById("scanVideo");
      v.srcObject=stream;
      await v.play();

      // Native
      if("BarcodeDetector" in window){
        let formats=["qr_code","ean_13","ean_8","code_128","code_39","upc_a","upc_e","itf","data_matrix","aztec"];
        try{
          if(BarcodeDetector.getSupportedFormats){
            const sup = await BarcodeDetector.getSupportedFormats();
            formats = formats.filter(f=>sup.includes(f));
          }
        }catch{}
        if(formats.length){
          const det = new BarcodeDetector({formats});
          hint("è¯†åˆ«ä¸­ï¼ˆåŸç”Ÿå¼•æ“ï¼‰â€¦");
          const loop = async()=>{
            if(!stream) return;
            try{
              const codes = await det.detect(v);
              if(codes && codes.length){
                const val = codes[0].rawValue || "";
                targetInput.value = val;
                targetInput.dispatchEvent(new Event("change"));
                stop();
                toast("æ‰«ç æˆåŠŸ");
                return;
              }
            }catch{}
            raf = requestAnimationFrame(loop);
          };
          raf = requestAnimationFrame(loop);
          return;
        }
      }

      // ZXing fallback
      hint("è¯†åˆ«ä¸­ï¼ˆå…¼å®¹å¼•æ“ï¼‰â€¦");
      await ensureZXing();
      const canvas=document.createElement("canvas");
      const ctx=canvas.getContext("2d",{willReadFrequently:true});
      const { BrowserMultiFormatReader, NotFoundException, RGBLuminanceSource, BinaryBitmap, HybridBinarizer } = window.ZXing;
      const reader = new BrowserMultiFormatReader();

      const loopZX = async()=>{
        if(!stream) return;
        try{
          const vw=v.videoWidth, vh=v.videoHeight;
          if(!vw||!vh){ raf=requestAnimationFrame(loopZX); return; }
          canvas.width=vw; canvas.height=vh;
          ctx.drawImage(v,0,0,vw,vh);
          const img=ctx.getImageData(0,0,vw,vh);
          const lum=new RGBLuminanceSource(img.data,vw,vh);
          const bmp=new BinaryBitmap(new HybridBinarizer(lum));
          const res=reader.decodeBitmap(bmp);
          if(res){
            const val=res.getText();
            targetInput.value=val;
            targetInput.dispatchEvent(new Event("change"));
            stop();
            toast("æ‰«ç æˆåŠŸ");
            return;
          }
        }catch(e){
          if(!(e instanceof NotFoundException)){}
        }
        raf=requestAnimationFrame(loopZX);
      };
      raf=requestAnimationFrame(loopZX);

    }catch(e){
      toast("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼šè¯·å…è®¸ç›¸æœºæƒé™");
      stop();
    }
  }

  // å¯¹å¤–æš´éœ²ï¼šç”¨äºæ‹¦æˆªæ—§æ‰«ç é€»è¾‘
  window.__startScannerV2 = start;


  // Bind to .scan-btn
  document.addEventListener("click",(e)=>{
    const btn = e.target && (e.target.closest ? e.target.closest(".scan-btn") : null);
    if(!btn) return;
    const td = btn.closest("td") || btn.parentElement;
    const input = td ? (td.querySelector(".note-input") || td.querySelector("input") || null) : null;
    if(input) start(input);
  });
})();
</script>


<script>

</script>

<script>
/* ===== æ–¹æ¡ˆäºŒï¼šè´¦å·ç»‘å®šè®¾å¤‡ï¼ˆå®¡æ‰¹åˆ¶ï¼‰=====
   - GitHub Pages çº¯é™æ€ç«™ï¼šå¿…é¡»æŠŠâ€œèƒ½ä¸èƒ½ç”¨â€æ”¾åˆ°äº‘ç«¯ï¼ˆSupabaseï¼‰
   - APK/TWA è½¬å‘æ— æ•ˆï¼šæ²¡ç™»å½•/æ²¡å®¡æ‰¹ â†’ ç›´æ¥é”å±
   - ä½ å¯åœ¨ Supabase è¡¨ allowed_devices é‡Œæ‰¹å‡†/å°ç¦è®¾å¤‡
*/
const AUTH_SUPABASE_URL = "https://yqsjkdndasbdfmjwahwk.supabase.co";
const AUTH_SUPABASE_KEY = "sb_publishable_8owDy_9hIN3uaBCzd6jncg_i8e68dL0";

function _getOrCreateDeviceToken(){
  const KEY = "device_token_v1";
  let t = localStorage.getItem(KEY);
  if(!t){
    // crypto.randomUUID() åœ¨ç°ä»£ Chrome/Android å¯ç”¨ï¼›ä¸å¯ç”¨åˆ™é™çº§
    t = (crypto && crypto.randomUUID) ? crypto.randomUUID() :
        ("dev_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2));
    localStorage.setItem(KEY, t);
  }
  return t;
}

function _showGate(html){
  const gate = document.getElementById("authGate");
  const body = document.getElementById("authGateBody");
  if(body) body.innerHTML = html;
  if(gate) gate.style.display = "flex";
  document.getElementById("appRoot").style.display = "none";
}

function _hideGate(){
  const gate = document.getElementById("authGate");
  if(gate) gate.style.display = "none";
  document.getElementById("appRoot").style.display = "block";
}

function _escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}


function _ensureWatermark(email, deviceToken){
  try{
    const id = "internalWatermark";
    let el = document.getElementById(id);
    if(!el){
      el = document.createElement("div");
      el.id = id;
      el.style.position = "fixed";
      el.style.right = "10px";
      el.style.bottom = "10px";
      el.style.zIndex = "9999";
      el.style.opacity = "0.65";
      el.style.fontSize = "12px";
      el.style.pointerEvents = "none";
      el.style.background = "rgba(0,0,0,0.25)";
      el.style.color = "#fff";
      el.style.padding = "6px 8px";
      el.style.borderRadius = "8px";
      el.style.backdropFilter = "blur(2px)";
      document.body.appendChild(el);
    }
    const tail = (deviceToken||"").slice(-6);
    el.textContent = `${email || ""} â€¢ ${tail} â€¢ ${new Date().toLocaleString()}`;
  }catch(e){}
}

async function _gateMain(){
  // é˜²æ­¢æ—§æµè§ˆå™¨ç¼º supabase-js
  if(!window.supabase || !window.supabase.createClient){
    _showGate(`<p style="color:#b91c1c">ç¼ºå°‘ Supabase SDKï¼Œæ— æ³•è¿›è¡Œè®¾å¤‡éªŒè¯ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ– CDN æ˜¯å¦å¯è®¿é—®ã€‚</p>`);
    return;
  }

  const sb = window.supabase.createClient(AUTH_SUPABASE_URL, AUTH_SUPABASE_KEY);
  // ç®¡ç†å‘˜ï¼šå†…éƒ¨ç³»ç»Ÿåå°ï¼ˆå®¡æ‰¹/å°ç¦/ä¸€äººä¸€æœº-æ‰¹å‡†å³æ¢æœºï¼‰
  const _admin = {
    inited:false,
    overlayId:"adminOverlay",
    btnId:"adminBtn",
    async list(){
      // ä¼˜å…ˆä½¿ç”¨ RPCï¼ˆæ›´å®‰å…¨ã€æ›´åƒå†…éƒ¨ç³»ç»Ÿï¼‰
      const { data, error } = await sb.rpc("admin_list_devices", { limit_count: 200 });
      if(error) throw error;
      return data || [];
    },
    async approve(deviceId){
      const { error } = await sb.rpc("admin_approve_device", { p_device_id: deviceId });
      if(error) throw error;
    },
    async block(deviceId){
      const { error } = await sb.rpc("admin_block_device", { p_device_id: deviceId });
      if(error) throw error;
    }
  };

  const _ensureAdminButton = () => {
    if(document.getElementById(_admin.btnId)) return;
    const btn = document.createElement("button");
    btn.id = _admin.btnId;
    btn.textContent = "ç®¡ç†";
    btn.style.position = "fixed";
    btn.style.left = "10px";
    btn.style.bottom = "10px";
    btn.style.zIndex = "10000";
    btn.style.padding = "10px 12px";
    btn.style.borderRadius = "10px";
    btn.style.border = "none";
    btn.style.background = "#2c3e50";
    btn.style.color = "#fff";
    btn.style.fontWeight = "700";
    btn.style.boxShadow = "0 8px 18px rgba(0,0,0,0.18)";
    btn.onclick = () => _openAdminPanel().catch(e=>alert(e.message||String(e)));
    document.body.appendChild(btn);
  };

  const _openAdminPanel = async () => {
    let ov = document.getElementById(_admin.overlayId);
    if(!ov){
      ov = document.createElement("div");
      ov.id = _admin.overlayId;
      ov.style.position = "fixed";
      ov.style.left = "0";
      ov.style.top = "0";
      ov.style.width = "100%";
      ov.style.height = "100%";
      ov.style.zIndex = "20000";
      ov.style.background = "rgba(0,0,0,0.55)";
      ov.style.display = "flex";
      ov.style.alignItems = "center";
      ov.style.justifyContent = "center";
      ov.innerHTML = `
        <div style="width:min(980px,96vw);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;padding:14px 14px 10px 14px;font-family:Segoe UI,Microsoft YaHei,sans-serif">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <div>
              <div style="font-size:16px;font-weight:800">è®¾å¤‡å®¡æ‰¹åå°</div>
              <div style="font-size:12px;opacity:.75;margin-top:2px">æ‰¹å‡† = åªç•™æœ€æ–°ä¸€å°ï¼ˆæ—§è®¾å¤‡ä¼šè¢«è‡ªåŠ¨å°ç¦ï¼‰</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="adminSearch" placeholder="æœç´¢ï¼šé‚®ç®±/è®¾å¤‡ç å6ä½" style="padding:8px 10px;border:1px solid #ddd;border-radius:10px;width:240px">
              <button id="adminRefresh" style="padding:8px 10px;border:none;border-radius:10px;background:#34495e;color:#fff;font-weight:700">åˆ·æ–°</button>
              <button id="adminClose" style="padding:8px 10px;border:none;border-radius:10px;background:#e74c3c;color:#fff;font-weight:700">å…³é—­</button>
            </div>
          </div>
          <div id="adminErr" style="display:none;margin-top:10px;padding:10px;border-radius:12px;background:#fff3f3;color:#b91c1c;font-size:12px"></div>
          <div id="adminTableWrap" style="margin-top:10px"></div>
          <div style="margin-top:10px;font-size:12px;opacity:.8">
            è‹¥æç¤º RPC ä¸å­˜åœ¨ï¼šè¯·åœ¨ Supabase SQL Editor è¿è¡Œ <code>INTERNAL_SETUP.sql</code>ï¼ˆæˆ‘å·²æ”¾åœ¨å‹ç¼©åŒ…ä¸­ï¼‰ã€‚
          </div>
        </div>
      `;
      ov.addEventListener("click", (e)=>{ if(e.target===ov) ov.remove(); });
      document.body.appendChild(ov);
      ov.querySelector("#adminClose").onclick = ()=>ov.remove();
      ov.querySelector("#adminRefresh").onclick = ()=>_renderAdminTable().catch(e=>_adminShowErr(e));
      ov.querySelector("#adminSearch").oninput = ()=>_renderAdminTable().catch(e=>_adminShowErr(e));
    }

    await _renderAdminTable();
  };

  const _adminShowErr = (e) => {
    const ov = document.getElementById(_admin.overlayId);
    if(!ov) return;
    const box = ov.querySelector("#adminErr");
    box.style.display = "block";
    box.textContent = (e && (e.message||e.toString())) || "æœªçŸ¥é”™è¯¯";
  };

  const _renderAdminTable = async () => {
    const ov = document.getElementById(_admin.overlayId);
    if(!ov) return;
    const wrap = ov.querySelector("#adminTableWrap");
    const q = (ov.querySelector("#adminSearch").value||"").trim().toLowerCase();
    let rows = [];
    try{
      rows = await _admin.list();
      ov.querySelector("#adminErr").style.display="none";
    }catch(e){
      _adminShowErr(e);
      rows = [];
    }

    const filtered = rows.filter(r=>{
      if(!q) return true;
      const tail = String(r.device_token||"").slice(-6).toLowerCase();
      return String(r.user_email||"").toLowerCase().includes(q) || tail.includes(q) || String(r.device_token||"").toLowerCase().includes(q);
    });

    const esc = (s)=>String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const badge = (txt,bg)=>`<span style="display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:${bg};color:#fff">${txt}</span>`;
    wrap.innerHTML = `
      <table style="width:100%;border-collapse:separate;border-spacing:0 8px;font-size:13px">
        <thead>
          <tr style="text-align:left;opacity:.75">
            <th>è´¦å·</th><th>è®¾å¤‡ç (å6ä½)</th><th>çŠ¶æ€</th><th>ç”³è¯·æ—¶é—´</th><th>æœ€ååœ¨çº¿</th><th style="text-align:right">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          ${filtered.map(r=>{
            const status = r.blocked ? badge("å·²å°ç¦","#e74c3c") : (r.approved ? badge("å·²æ‰¹å‡†","#2ecc71") : badge("å¾…å®¡æ‰¹","#f39c12"));
            return `
            <tr style="background:#f7f8fa;border-radius:12px">
              <td style="padding:10px 10px;border-radius:12px 0 0 12px">${esc(r.user_email)}</td>
              <td style="padding:10px 10px">${esc(String(r.device_token||"").slice(-6))}</td>
              <td style="padding:10px 10px">${status}</td>
              <td style="padding:10px 10px">${esc(r.created_at||"")}</td>
              <td style="padding:10px 10px">${esc(r.last_seen_at||"")}</td>
              <td style="padding:10px 10px;text-align:right;border-radius:0 12px 12px 0">
                <button data-act="approve" data-id="${r.id}" style="padding:6px 10px;border:none;border-radius:10px;background:#2c3e50;color:#fff;font-weight:700;margin-right:6px">æ‰¹å‡†</button>
                <button data-act="block" data-id="${r.id}" style="padding:6px 10px;border:none;border-radius:10px;background:#e74c3c;color:#fff;font-weight:700">å°ç¦</button>
              </td>
            </tr>`;
          }).join("")}
        </tbody>
      </table>
      <div style="font-size:12px;opacity:.75">å…± ${filtered.length} æ¡ï¼ˆæ˜¾ç¤ºå‰ 200 æ¡ï¼‰</div>
    `;

    wrap.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.onclick = async ()=>{
        const act = btn.getAttribute("data-act");
        const id = Number(btn.getAttribute("data-id"));
        btn.disabled = true;
        try{
          if(act==="approve") await _admin.approve(id);
          if(act==="block") await _admin.block(id);
          await _renderAdminTable();
        }catch(e){
          _adminShowErr(e);
        }finally{
          btn.disabled = false;
        }
      };
    });
  };


  const renderLogin = (msg="") => {
    const m = msg ? `<p style="color:#b91c1c">${_escapeHtml(msg)}</p>` : "";
    _showGate(`
      ${m}
      <p>è¯·å…ˆç™»å½•ï¼ˆSupabase Authï¼‰ï¼Œç™»å½•åä¼šè‡ªåŠ¨ç”Ÿæˆè®¾å¤‡ç å¹¶ç”³è¯·å®¡æ‰¹ã€‚</p>
      <div class="auth-row"><input id="gateEmail" class="auth-input" type="email" placeholder="é‚®ç®±ï¼ˆEmailï¼‰"></div>
      <div class="auth-row"><input id="gatePass" class="auth-input" type="password" placeholder="å¯†ç ï¼ˆPasswordï¼‰"></div>
      <button id="gateLoginBtn" class="auth-btn">ç™»å½•</button>
      <button id="gateSignupBtn" class="auth-btn secondary">æ³¨å†Œï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰</button>
      <p class="auth-small">æç¤ºï¼šä½ å¯ä»¥åªåˆ›å»ºå°‘é‡è´¦å·ï¼ˆä¾‹å¦‚ç»™æ¯ä¸ªå®¢æˆ·ä¸€ä¸ªè´¦å·ï¼‰ï¼Œå†ç”¨è®¾å¤‡å®¡æ‰¹é™åˆ¶â€œåªèƒ½æŸå°æ‰‹æœºèƒ½ç”¨â€ã€‚</p>
    `);

    document.getElementById("gateLoginBtn").onclick = async () => {
      const email = document.getElementById("gateEmail").value.trim();
      const password = document.getElementById("gatePass").value;
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error) return renderLogin(error.message || "ç™»å½•å¤±è´¥");
      await afterLogin();
    };
    document.getElementById("gateSignupBtn").onclick = async () => {
      const email = document.getElementById("gateEmail").value.trim();
      const password = document.getElementById("gatePass").value;
      const { error } = await sb.auth.signUp({ email, password });
      if(error) return renderLogin(error.message || "æ³¨å†Œå¤±è´¥");
      renderLogin("æ³¨å†ŒæˆåŠŸï¼šå¦‚ä½ å¯ç”¨äº†é‚®ç®±éªŒè¯ï¼Œè¯·å…ˆå»é‚®ç®±å®ŒæˆéªŒè¯åå†ç™»å½•ã€‚");
    };
  };

  const renderPending = (deviceToken, note="è®¾å¤‡æœªå®¡æ‰¹") => {
    _showGate(`
      <p><b>${_escapeHtml(note)}</b></p>
      <p>è¯·æŠŠä¸‹é¢çš„è®¾å¤‡ç å‘ç»™ç®¡ç†å‘˜ï¼Œåœ¨ Supabase çš„ <code>allowed_devices</code> è¡¨ä¸­æŠŠ <code>approved</code> è®¾ä¸º <code>true</code> æ‰èƒ½ä½¿ç”¨ã€‚</p>
      <div class="auth-code" id="gateDeviceCode">${_escapeHtml(deviceToken)}</div>
      <button id="gateCopyBtn" class="auth-btn">å¤åˆ¶è®¾å¤‡ç </button>
      <button id="gateRefreshBtn" class="auth-btn secondary">æˆ‘å·²å®¡æ‰¹ï¼Œåˆ·æ–°éªŒè¯</button>
      <button id="gateLogoutBtn" class="auth-btn danger">é€€å‡ºç™»å½•</button>
      <p class="auth-small">è¯´æ˜ï¼šè¿™ä¸æ˜¯æ§åˆ¶ APKï¼Œè€Œæ˜¯æ§åˆ¶â€œè¿™ä¸ªè´¦å·+è¿™å°è®¾å¤‡èƒ½ä¸èƒ½ç”¨â€ã€‚APK è½¬å‘ä¹Ÿæ‰“ä¸å¼€ã€‚</p>
    `);
    document.getElementById("gateCopyBtn").onclick = async () => {
      try{ await navigator.clipboard.writeText(deviceToken); alert("å·²å¤åˆ¶"); }
      catch(e){ alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰å¤åˆ¶"); }
    };
    document.getElementById("gateRefreshBtn").onclick = async () => { await afterLogin(); };
    document.getElementById("gateLogoutBtn").onclick = async () => { await sb.auth.signOut(); renderLogin("å·²é€€å‡º"); };
  };

  const renderBlocked = (deviceToken) => renderPending(deviceToken, "è¯¥è®¾å¤‡å·²è¢«ç¦ç”¨");

  async function afterLogin(){
    const { data: { user } } = await sb.auth.getUser();
    if(!user) return renderLogin();

    const deviceToken = _getOrCreateDeviceToken();

    // 0) è´¦å·ç™½åå•ï¼ˆåƒå†…éƒ¨ç³»ç»Ÿä¸€æ ·ï¼šä¸åœ¨åå•=ç›´æ¥ç¦ç”¨ï¼‰
    let allowInfo = null;
    {
      const { data: au, error: auErr } = await sb
        .from("allowed_users")
        .select("role, enabled")
        .eq("email", user.email)
        .maybeSingle();

      if(auErr){
        return _showGate(`
          <p style="color:#b91c1c"><b>ç™½åå•æ ¡éªŒå¤±è´¥</b></p>
          <p>è¯·åœ¨ Supabase åˆ›å»º <code>allowed_users</code> è¡¨ï¼Œå¹¶é…ç½® RLS/ç­–ç•¥ã€‚</p>
          <p class="auth-small">${_escapeHtml(auErr.message || String(auErr))}</p>
          <button id="gateLogoutBtn" class="auth-btn danger">é€€å‡ºç™»å½•</button>
        `), (document.getElementById("gateLogoutBtn").onclick = async()=>{await sb.auth.signOut();});
      }
      if(!au || au.enabled !== true){
        return _showGate(`
          <p style="color:#b91c1c"><b>æœªæˆæƒè´¦å·</b></p>
          <p>è¯¥è´¦å·ä¸åœ¨å…è®¸åå•ä¸­ï¼Œæ— æ³•ä½¿ç”¨ç³»ç»Ÿã€‚</p>
          <p class="auth-small">è´¦å·ï¼š${_escapeHtml(user.email || "")}</p>
          <p class="auth-small">è®¾å¤‡ç ï¼ˆå‘ç»™ç®¡ç†å‘˜å¼€é€š/æ’æŸ¥ï¼‰ï¼š</p>
          <div class="auth-code">${_escapeHtml(deviceToken)}</div>
          <button id="gateCopyBtn" class="auth-btn">å¤åˆ¶è®¾å¤‡ç </button>
          <button id="gateLogoutBtn" class="auth-btn danger">é€€å‡ºç™»å½•</button>
        `),
        (document.getElementById("gateCopyBtn").onclick = async()=>{try{await navigator.clipboard.writeText(deviceToken);}catch(e){};}),
        (document.getElementById("gateLogoutBtn").onclick = async()=>{await sb.auth.signOut();});
      }
      allowInfo = au;
    }

    const isAdmin = (allowInfo && String(allowInfo.role).toLowerCase() === "admin");

    // 1) è®¾å¤‡ç™»è®°ï¼ˆåªå†™ user_id + device_tokenï¼›å®¡æ‰¹å­—æ®µä¸ç»™å®¢æˆ·ç«¯å†™ï¼‰
    await sb.from("allowed_devices")
      .upsert({
        user_id: user.id,
        device_token: deviceToken
      }, { onConflict: "user_id,device_token" });

    // 2) æŸ¥è¯¢å®¡æ‰¹çŠ¶æ€
    const { data, error } = await sb
      .from("allowed_devices")
      .select("id, approved, blocked")
      .eq("user_id", user.id)
      .eq("device_token", deviceToken)
      .maybeSingle();

    if(error){
      // å¤šåŠæ˜¯è¡¨/ç­–ç•¥æ²¡é…ç½®å¥½
      return _showGate(`
        <p style="color:#b91c1c"><b>è®¾å¤‡éªŒè¯å¤±è´¥</b></p>
        <p>è¯·æ£€æŸ¥ Supabase æ˜¯å¦å·²åˆ›å»º <code>allowed_devices</code> è¡¨ï¼Œå¹¶å¯ç”¨æ­£ç¡®çš„ RLS ç­–ç•¥ã€‚</p>
        <p class="auth-small">${_escapeHtml(error.message || String(error))}</p>
        <button id="gateLogoutBtn" class="auth-btn danger">é€€å‡ºç™»å½•</button>
      `), (document.getElementById("gateLogoutBtn").onclick = async()=>{await sb.auth.signOut();});
    }

    if(!data) return renderPending(deviceToken, "è®¾å¤‡æœªç™»è®°/æœªå®¡æ‰¹");
    if(data.blocked) return renderBlocked(deviceToken);
    if(!data.approved) return renderPending(deviceToken, "è®¾å¤‡æœªå®¡æ‰¹");

    // é€šè¿‡ï¼šéšè—é—¨ç¦ï¼Œæ˜¾ç¤ºæ°´å°ä¸ï¼ˆå¯é€‰ï¼‰ç®¡ç†å‘˜å…¥å£
    _hideGate();
    _ensureWatermark(user.email || "", deviceToken);
    if(isAdmin) _ensureAdminButton();
  }

  // åˆæ¬¡ï¼šå¦‚æœæ²¡æœ‰ä¼šè¯ â†’ ç™»å½•ï¼›æœ‰ä¼šè¯ â†’ ç›´æ¥èµ°å®¡æ‰¹
 _hideGate();
  }

  // åˆæ¬¡ï¼šå¦‚æœæ²¡æœ‰ä¼šè¯ â†’ ç™»å½•ï¼›æœ‰ä¼šè¯ â†’ ç›´æ¥èµ°å®¡æ‰¹
  const { data: { session } } = await sb.auth.getSession();
  if(!session) renderLogin();
  else await afterLogin();

  // å®šæ—¶æ ¡éªŒï¼šå°ç¦/æ¢æœºå¯åœ¨ 1 åˆ†é’Ÿå†…ç”Ÿæ•ˆï¼ˆæ›´åƒå†…éƒ¨ç³»ç»Ÿï¼‰
  setInterval(async ()=>{
    try{
      const { data: { session } } = await sb.auth.getSession();
      if(session) await afterLogin();
    }catch(e){}
  }, 60000);


  // ä¼šè¯å˜åŒ–æ—¶è‡ªåŠ¨åˆ·æ–°
  sb.auth.onAuthStateChange(async (_event, _session) => {
    const { data: { session } } = await sb.auth.getSession();
    if(!session) renderLogin();
    else await afterLogin();
  });
}

// é¡µé¢åŠ è½½åå¯åŠ¨é—¨ç¦
window.addEventListener("load", () => {
  try{ _gateMain(); }catch(e){ console.error(e); }
});
</script>

<script>
/* ========= äº‘ç«¯åŒæ­¥ï¼ˆSupabaseï¼Œå•äººä¸¤æœºï¼Œå¸¦å¯†ç ï¼‰ =========
   PIN -> SHA256 -> äº‘ç«¯è¡ŒIDã€‚æ‹‰å–åè‡ªåŠ¨åˆ·æ–°é¡µé¢ç¡®ä¿ç”Ÿæ•ˆã€‚
*/
const SUPABASE_URL = "https://yqsjkdndasbdfmjwahwk.supabase.co";
const SUPABASE_KEY = "sb_publishable_8owDy_9hIN3uaBCzd6jncg_i8e68dL0";
const REST = SUPABASE_URL.replace(/\/$/,'') + "/rest/v1/app_state";
const LOCAL_KEY = "orderProfitData";
const PIN_KEY = "cloudSyncPIN";

function _supabaseHeaders(extra={}){
  return Object.assign({
    "apikey": SUPABASE_KEY,
    "Authorization": "Bearer " + SUPABASE_KEY,
    "Content-Type": "application/json"
  }, extra);
}
function _nowIso(){ return new Date().toISOString(); }
function _getLocalRaw(){ return localStorage.getItem(LOCAL_KEY); }
function _setLocalRaw(v){ localStorage.setItem(LOCAL_KEY, v); }

function _setCloudStatus(msg, ok=true){
  const el = document.getElementById("cloudStatus");
  if(!el) return;
  el.textContent = msg;
  el.style.color = ok ? "#2ecc71" : "#e74c3c";
}

async function _sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
}

async function _getRowId(){
  let pin = localStorage.getItem(PIN_KEY);
  if(!pin){
    pin = prompt("è®¾ç½®/è¾“å…¥åŒæ­¥å¯†ç ï¼ˆä¸¤å°è®¾å¤‡è¦ä¸€è‡´ï¼‰");
    if(!pin) throw new Error("æœªè®¾ç½®å¯†ç ");
    localStorage.setItem(PIN_KEY, pin);
  }
  const hex = await _sha256Hex(pin);
  return "main_" + hex.slice(0,24);
}

function changePIN(){
  const pin = prompt("è¾“å…¥æ–°çš„åŒæ­¥å¯†ç ï¼ˆä¸¤å°è®¾å¤‡è¦ä¸€è‡´ï¼‰");
  if(!pin) return;
  localStorage.setItem(PIN_KEY, pin);
  _setCloudStatus("å·²è®¾ç½®æ–°å¯†ç ï¼ˆè¯·é‡æ–°ä¿å­˜/æ‹‰å–ï¼‰", true);
}

async function cloudSave(){
  try{
    _setCloudStatus("äº‘ç«¯ä¿å­˜ä¸­â€¦", true);
    const raw = _getLocalRaw();
    if(!raw) return _setCloudStatus("æœ¬åœ°æš‚æ— æ•°æ®ï¼ˆå…ˆåœ¨é¡µé¢ä¿å­˜/æˆ–æ–°å¢ï¼‰", false);
    const id = await _getRowId();
    let dataObj;
    try{ dataObj = JSON.parse(raw); }catch{ dataObj = raw; }
    const payload = [{ id, data:dataObj, updated_at:_nowIso() }];
    const res = await fetch(REST + "?on_conflict=id", {
      method:"POST",
      headers:_supabaseHeaders({"Prefer":"resolution=merge-duplicates,return=representation"}),
      body: JSON.stringify(payload)
    });
    const txt = await res.text();
    if(!res.ok) return _setCloudStatus("ä¿å­˜å¤±è´¥ï¼š" + txt.slice(0,200), false);
    _setCloudStatus("âœ… äº‘ç«¯å·²ä¿å­˜", true);
    try{ createLocalBackup("cloudSave"); }catch(e){}
    if(typeof showToast==="function") showToast("äº‘ç«¯å·²ä¿å­˜ï¼ˆå·²å¤‡ä»½ï¼‰");
  }catch(e){
    _setCloudStatus("ä¿å­˜å¼‚å¸¸ï¼š" + (e?.message||e), false);
  }
}

async function cloudLoad(){
  try{
    _setCloudStatus("äº‘ç«¯æ‹‰å–ä¸­â€¦", true);
    const id = await _getRowId();
    const res = await fetch(REST + "?id=eq." + encodeURIComponent(id) + "&select=data,updated_at", {
      method:"GET",
      headers:_supabaseHeaders()
    });
    const txt = await res.text();
    if(!res.ok) return _setCloudStatus("æ‹‰å–å¤±è´¥ï¼š" + txt.slice(0,200), false);
    const arr = JSON.parse(txt);
    if(!arr.length) return _setCloudStatus("äº‘ç«¯æš‚æ— æ•°æ®ï¼ˆå…ˆç”¨åŒä¸€å¯†ç ç‚¹ä¿å­˜ï¼‰", false);
    const row = arr[0];

    _setLocalRaw(JSON.stringify(row.data));
    _setCloudStatus("âœ… å·²æ‹‰å–ï¼ˆ" + (row.updated_at||"") + "ï¼‰", true);

    // âœ… å…œåº•ï¼šåˆ·æ–°é¡µé¢ç¡®ä¿å†…å­˜æ•°æ®æ›´æ–°
    sessionStorage.setItem("__cloudReloadOnce", "1");
    window.__skipBeforeUnloadSave = true;
    location.reload();
  }catch(e){
    _setCloudStatus("æ‹‰å–å¼‚å¸¸ï¼š" + (e?.message||e), false);
  }
}


async function cloudDiag(){
  const t0 = (typeof performance!=="undefined" && performance.now) ? performance.now() : Date.now();
  const lines = [];
  const now = new Date();
  lines.push("=== äº‘ç«¯åŒæ­¥è¯Šæ–­ / Cloud Sync Diagnostics ===");
  lines.push("æ—¶é—´: " + now.toLocaleString());
  try{ lines.push("é¡µé¢: " + location.href); }catch(e){}
  try{ lines.push("åœ¨çº¿çŠ¶æ€: " + (navigator.onLine ? "åœ¨çº¿" : "ç¦»çº¿/æœªçŸ¥")); }catch(e){}

  // localStorage basic check
  let lsOK = true;
  try{
    const k="__ls_test__"+Math.random().toString(16).slice(2);
    localStorage.setItem(k,"1");
    localStorage.removeItem(k);
  }catch(e){
    lsOK = false;
    lines.push("âŒ localStorage ä¸å¯ç”¨: " + (e?.message||e));
  }
  if(lsOK) lines.push("âœ… localStorage å¯ç”¨");

  // local data
  try{
    const raw = _getLocalRaw();
    if(!raw){
      lines.push("âš ï¸ æœ¬åœ°æ•°æ®: æ— ï¼ˆLOCAL_KEY=" + LOCAL_KEY + "ï¼‰");
    }else{
      const kb = Math.round((raw.length/1024)*10)/10;
      lines.push("âœ… æœ¬åœ°æ•°æ®: æœ‰ï¼Œå¤§å°çº¦ " + kb + " KBï¼ˆLOCAL_KEY=" + LOCAL_KEY + "ï¼‰");
      try{
        const obj = JSON.parse(raw);
        if(obj && typeof obj==="object"){
          const keys = Object.keys(obj);
          lines.push("  - JSON è§£æ: OKï¼Œé¡¶å±‚å­—æ®µæ•°: " + keys.length);
        }
      }catch(e){
        lines.push("  - JSON è§£æ: å¤±è´¥ï¼ˆå¯èƒ½ä¸æ˜¯ JSON æˆ–å·²æŸåï¼‰: " + (e?.message||e));
      }
    }
  }catch(e){
    lines.push("âŒ è¯»å–æœ¬åœ°æ•°æ®å¼‚å¸¸: " + (e?.message||e));
  }

  // PIN & row id (no prompt)
  let pin = null, rowId = null;
  try{
    pin = localStorage.getItem(PIN_KEY);
    if(!pin){
      lines.push("âš ï¸ åŒæ­¥å¯†ç (PIN): æœªè®¾ç½®ï¼ˆç‚¹å‡»â€œå¯†ç â€å…ˆè®¾ç½®ï¼‰");
    }else{
      lines.push("âœ… åŒæ­¥å¯†ç (PIN): å·²è®¾ç½®ï¼ˆé•¿åº¦ " + pin.length + "ï¼Œå·²éšè—ï¼‰");
      const hex = await _sha256Hex(pin);
      rowId = "main_" + hex.slice(0,24);
      lines.push("âœ… äº‘ç«¯è¡ŒID: " + rowId);
    }
  }catch(e){
    lines.push("âŒ è¯»å–/è®¡ç®— PIN å¼‚å¸¸: " + (e?.message||e));
  }

  // supabase reachability
  async function probe(url, label){
    const p0 = (typeof performance!=="undefined" && performance.now) ? performance.now() : Date.now();
    try{
      const res = await fetch(url, { method:"GET", headers:_supabaseHeaders() });
      const txt = await res.text();
      const p1 = (typeof performance!=="undefined" && performance.now) ? performance.now() : Date.now();
      lines.push((res.ok ? "âœ… " : "âŒ ") + label + ": HTTP " + res.status + "ï¼Œè€—æ—¶ " + Math.round(p1-p0) + " ms");
      if(!res.ok){
        lines.push("  - è¿”å›: " + txt.slice(0,200).replace(/\s+/g," "));
      }
      return {ok:res.ok, status:res.status, text:txt};
    }catch(e){
      const p1 = (typeof performance!=="undefined" && performance.now) ? performance.now() : Date.now();
      lines.push("âŒ " + label + ": è¯·æ±‚å¼‚å¸¸ï¼Œè€—æ—¶ " + Math.round(p1-p0) + " msï¼Œé”™è¯¯: " + (e?.message||e));
      return {ok:false, status:0, text:String(e)};
    }
  }

  await probe(REST + "?select=id&limit=1", "Supabase REST è¿é€šæ€§");
  if(rowId){
    await probe(REST + "?id=eq." + encodeURIComponent(rowId) + "&select=updated_at", "äº‘ç«¯è®°å½•è¯»å–ï¼ˆæŒ‰è¡ŒIDï¼‰");
  }else{
    lines.push("â„¹ï¸ æœªè®¡ç®—è¡ŒIDï¼Œè·³è¿‡â€œæŒ‰è¡ŒIDè¯»å–â€æµ‹è¯•");
  }

  const t1 = (typeof performance!=="undefined" && performance.now) ? performance.now() : Date.now();
  lines.push("æ€»è€—æ—¶: " + Math.round(t1 - t0) + " ms");
  const report = lines.join("\n");

  // modal
  const id = "__cloudDiagModal";
  let modal = document.getElementById(id);
  if(modal) modal.remove();
  modal = document.createElement("div");
  modal.id = id;
  modal.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:999999;display:flex;align-items:center;justify-content:center;padding:16px;";
  modal.innerHTML = `
    <div style="width:min(920px,100%);max-height:85vh;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25);display:flex;flex-direction:column;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#111827;color:#fff;">
        <div style="font-weight:700;">äº‘ç«¯åŒæ­¥è¯Šæ–­æŠ¥å‘Š</div>
        <button id="__cloudDiagClose" style="border:0;background:transparent;color:#fff;font-size:18px;cursor:pointer;">âœ•</button>
      </div>
      <div style="padding:12px 14px;display:flex;gap:10px;flex-wrap:wrap;border-bottom:1px solid #eee;">
        <button id="__cloudDiagCopy" class="action-btn" style="padding:8px 12px;border-radius:10px;">å¤åˆ¶æŠ¥å‘Š</button>
        <button id="__cloudDiagRefresh" class="action-btn" style="padding:8px 12px;border-radius:10px;">é‡æ–°è¯Šæ–­</button>
      </div>
      <pre id="__cloudDiagPre" style="margin:0;padding:12px 14px;white-space:pre-wrap;word-break:break-word;overflow:auto;flex:1;font-size:12px;line-height:1.4;background:#fafafa;"></pre>
    </div>`;
  document.body.appendChild(modal);
  modal.querySelector("#__cloudDiagPre").textContent = report;

  function close(){ modal.remove(); }
  modal.querySelector("#__cloudDiagClose").onclick = close;
  modal.addEventListener("click", (e)=>{ if(e.target===modal) close(); });

  modal.querySelector("#__cloudDiagCopy").onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(report);
      if(typeof showToast==="function") showToast("å·²å¤åˆ¶è¯Šæ–­æŠ¥å‘Š");
    }catch(e){
      // fallback
      prompt("å¤åˆ¶ä¸‹é¢å†…å®¹ï¼š", report);
    }
  };
  modal.querySelector("#__cloudDiagRefresh").onclick = ()=>{
    close();
    setTimeout(()=>cloudDiag(), 50);
  };
}


function openSortMenu(){
  try{
    const choice = prompt(
    );
    if(!choice) return;
    const c = String(choice).trim();
    if(c==="1"){ dateSortState='desc'; sellAmountSortState='none'; }
    else if(c==="2"){ dateSortState='asc'; sellAmountSortState='none'; }
    else if(c==="3"){ dateSortState='none'; sellAmountSortState='desc'; }
    else if(c==="4"){ dateSortState='none'; sellAmountSortState='asc'; }
    else if(c==="5"){ dateSortState='none'; sellAmountSortState='none'; }
    else { return; }

    if(typeof updateSortIndicators==="function") updateSortIndicators();
    if(typeof renderTable==="function") renderTable();
    if(typeof updateTotalProfit==="function") updateTotalProfit();
    if(typeof showToast==="function") showToast("æ’åºå·²æ›´æ–°");
  }catch(e){
    if(typeof showToast==="function") showToast("æ’åºå¤±è´¥ï¼š" + (e?.message||e));
  }
}

function mountCloudBar(){
  if(document.getElementById("cloudBar")) return;
  const bar = document.createElement("div");
  bar.id = "cloudBar";
  bar.innerHTML = `
    <button class="action-btn btn-cloud-save" id="btnCloudSave"><i class="fas fa-cloud-arrow-up"></i> ä¿å­˜</button>
    <button class="action-btn btn-cloud-load" id="btnCloudLoad"><i class="fas fa-cloud-arrow-down"></i> æ‹‰å–</button>
    <button class="action-btn btn-cloud-pin" id="btnCloudPIN"><i class="fas fa-key"></i> å¯†ç </button>
    <button class="action-btn btn-cloud-diag" id="btnCloudDiag"><i class="fas fa-stethoscope"></i> è¯Šæ–­</button>
    <div id="cloudStatus" style="font-size:12px;color:#d1fae5;opacity:.9;max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">äº‘ç«¯ï¼šæœªåŒæ­¥</div>
  `;
  const slot = document.getElementById("topRightCloudActions") || document.querySelector(".header") || document.body;
  slot.appendChild(bar);

  document.getElementById("btnCloudSave").onclick = cloudSave;
  document.getElementById("btnCloudLoad").onclick = cloudLoad;
  document.getElementById("btnCloudPIN").onclick = changePIN;
  document.getElementById("btnCloudDiag").onclick = cloudDiag;
}
window.addEventListener("load", mountCloudBar);

window.addEventListener("load", ()=>{
  if(sessionStorage.getItem("__cloudReloadOnce")==="1"){
    sessionStorage.removeItem("__cloudReloadOnce");
    _setCloudStatus("âœ… å·²æ‹‰å–å¹¶åˆ·æ–°", true);
  }
});
</script>


<script>
/* ========= v8 äº‘ç«¯åŒæ­¥æç¤ºå¢å¼º ========= */
(function(){
  function safeToast(msg){
    if(typeof window.showToast==="function") return window.showToast(msg);
    try{
      let t=document.getElementById("cloudToastLite");
      if(!t){
        t=document.createElement("div");
        t.id="cloudToastLite";
        t.style.cssText="position:fixed;left:50%;bottom:130px;transform:translateX(-50%);background:#000c;color:#fff;padding:10px 12px;border-radius:12px;font-size:13px;z-index:10080;max-width:82vw;text-align:center;";
        document.body.appendChild(t);
      }
      t.textContent=msg;
      t.style.display="block";
      clearTimeout(t._timer);
      t._timer=setTimeout(()=>t.style.display="none",1600);
    }catch(_e){}
  }
  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  async function idPreview(){
    try{
      const pin = (localStorage.getItem("cloudSyncPIN") || "").trim();
      if(!pin) return "";
      const hex = await sha256Hex(pin);
      return "main_" + hex.slice(0,6) + "â€¦";
    }catch{ return ""; }
  }
  async function refreshStatus(){
    const el = document.getElementById("cloudStatus");
    if(!el) return;
    const pv = await idPreview();
  }
  window.addEventListener("load", refreshStatus);

  // æ”¹å¯†ç åæé†’
  const oldChange = window.changePIN;
  if(typeof oldChange==="function"){
    window.changePIN = async function(){
      oldChange();
      safeToast("æç¤ºï¼šä¸¤å°è®¾å¤‡å¯†ç è¦ä¸€è‡´ï¼›æ”¹å¯†ç åè¯·åœ¨Aæ‰‹æœºç‚¹ä¸€æ¬¡â˜ï¸ä¿å­˜");
      await refreshStatus();
    }
  }

  // æ‹‰å–æ— æ•°æ®æ—¶ç»™æ›´æ˜ç¡®æç¤º
  const oldLoad = window.cloudLoad;
  if(typeof oldLoad==="function"){
    window.cloudLoad = async function(){
      await oldLoad();
      const el = document.getElementById("cloudStatus");
      const txt = el ? (el.textContent||"") : "";
      if(txt.includes("æš‚æ— æ•°æ®")){
        safeToast("äº‘ç«¯æ²¡æ‰¾åˆ°æ•°æ®ï¼šè¯·ç¡®è®¤ä¸¤å°æ‰‹æœºå¯†ç ä¸€è‡´ï¼Œå¹¶åœ¨Aæ‰‹æœºç‚¹â˜ï¸ä¿å­˜ä¸€æ¬¡");
      }
      await refreshStatus();
    }
  }

  const oldSave = window.cloudSave;
  if(typeof oldSave==="function"){
    window.cloudSave = async function(){
      await oldSave();
      await refreshStatus();
    }
  }
})();
</script>


<script>
/* ========= v9 ä¿®å¤ï¼šæ‹¦æˆªæ—§æ‰«ç ï¼ˆhtml5-qrcodeï¼‰é¿å…å åŠ  ========= */
(function(){
  // å…³æ‰æ—§å¼¹çª—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  window.addEventListener("load", ()=>{
    try{
      const old = document.getElementById("scannerModal");
      if(old){ old.classList.remove("show"); old.style.display="none"; }
    }catch{}
  });

  // æ•è·é˜¶æ®µæ‹¦æˆª .scan-btn ç‚¹å‡»ï¼Œé˜»æ­¢æ—§é€»è¾‘ç»§ç»­æ‰§è¡Œ
  document.addEventListener("click", (e)=>{
    const btn = e.target && (e.target.closest ? e.target.closest(".scan-btn") : null);
    if(!btn) return;

    // é˜»æ­¢åç»­ï¼ˆåŒ…æ‹¬æ—§è„šæœ¬çš„ç›‘å¬å™¨ï¼‰
    e.preventDefault();
    e.stopPropagation();
    if(e.stopImmediatePropagation) e.stopImmediatePropagation();

    // æ‰¾è¾“å…¥æ¡†
    const td = btn.closest("td") || btn.parentElement;
    const input = td ? (td.querySelector(".note-input") || td.querySelector("input") || null) : null;
    if(input && typeof window.__startScannerV2==="function"){
      window.__startScannerV2(input);
    }
  }, true); // true = æ•è·é˜¶æ®µ
})();
</script>


<script>


<script>
(function(){
  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  async function idText(){
    const pin = (localStorage.getItem("cloudSyncPIN")||"").trim();
    const hex = await sha256Hex(pin);
  }
  async function refresh(){
    const el = document.getElementById("cloudIdHeader");
    if(!el) return;
    el.textContent = await idText();
  }
  window.addEventListener("load", refresh);
  document.addEventListener("click", (e)=>{
    const t=e.target;
    if(t && (t.id==="btnCloudPIN" || (t.closest && t.closest("#btnCloudPIN")))) setTimeout(refresh, 350);
  }, true);
  const oldSave = window.cloudSave;
  if(typeof oldSave==="function") window.cloudSave = async function(){ await oldSave(); await refresh(); };
  const oldLoad = window.cloudLoad;
  if(typeof oldLoad==="function") window.cloudLoad = async function(){ await oldLoad(); await refresh(); };
})();
</script>


<script>
(function(){
  const KEYS = ["cloudSyncPIN","cloudSyncPin","cloud_pin","syncPIN"];
  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  function getPin(){
    for(const k of KEYS){
      const v = (localStorage.getItem(k)||"").trim();
      if(v) return v;
    }
    return "";
  }
  async function idText(){
    const pin = getPin();
    const hex = await sha256Hex(pin);
  }
  async function refresh(){
    const el = document.getElementById("cloudIdHeader");
    if(!el) return;
    el.textContent = await idText();
  }

  const oldChange = window.changePIN;
  if(typeof oldChange==="function"){
    window.changePIN = function(){
      oldChange();
      setTimeout(refresh, 120);
      setTimeout(refresh, 400);
    };
  }

  window.addEventListener("load", ()=>{
    refresh();
    let n=0;
    const t=setInterval(()=>{
      refresh();
      if(++n>=8) clearInterval(t);
    }, 300);
  });

  const oldSave = window.cloudSave;
  if(typeof oldSave==="function") window.cloudSave = async function(){ await oldSave(); await refresh(); };
  const oldLoad = window.cloudLoad;
  if(typeof oldLoad==="function") window.cloudLoad = async function(){ await oldLoad(); await refresh(); };
})();
</script>


<script>
   å…¸å‹åŸå› ï¼šSupabase RLS ä»å¼€å¯ä½†ç¼ºå°‘ SELECT policy â†’ æœåŠ¡å™¨è¿”å› 200 + []ï¼ˆè¢«ç­–ç•¥è¿‡æ»¤ï¼‰
*/
(function(){
  function liteToast(msg){
    if(typeof window.showToast==="function") return window.showToast(msg);
    try{
      let t=document.getElementById("diagToastLite");
      if(!t){
        t=document.createElement("div");
        t.id="diagToastLite";
        t.style.cssText="position:fixed;left:50%;bottom:160px;transform:translateX(-50%);background:#000c;color:#fff;padding:10px 12px;border-radius:12px;font-size:13px;z-index:10120;max-width:86vw;text-align:center;white-space:pre-wrap;";
        document.body.appendChild(t);
      }
      t.textContent=msg;
      t.style.display="block";
      clearTimeout(t._timer);
      t._timer=setTimeout(()=>t.style.display="none",2600);
    }catch(_e){}
  }

  async function sha256Hex(str){
    const enc=new TextEncoder().encode(str);
    const buf=await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  async function rowId(){
    const pin=(localStorage.getItem("cloudSyncPIN")||"").trim();
    if(!pin) return null;
    const hex=await sha256Hex(pin);
    return "main_" + hex.slice(0,24);
  }

  // è¯»å– Supabase URL/KEY/RESTï¼ˆç”±ä¸»è„šæœ¬å®šä¹‰ï¼‰
  async function diagFetch(){
    const id = await rowId();
    if(!id) return liteToast("æœªè®¾ç½®å¯†ç ï¼šå…ˆç‚¹å³ä¸‹è§’ğŸ”å¯†ç ");
    if(typeof REST==="undefined") return liteToast("è¯Šæ–­å¤±è´¥ï¼šREST æœªå®šä¹‰ï¼ˆç‰ˆæœ¬ä¸ä¸€è‡´ï¼‰");
    const url = REST + "?id=eq." + encodeURIComponent(id) + "&select=id,updated_at,data";
    let res, txt;
    try{
      res = await fetch(url, {method:"GET", headers: _supabaseHeaders()});
      txt = await res.text();
    }catch(e){
      return liteToast("ç½‘ç»œ/è·¨åŸŸé”™è¯¯ï¼š" + (e?.message||e));
    }
    let rows = null;
    try{ rows = JSON.parse(txt); }catch{}
    if(res.status===200 && Array.isArray(rows) && rows.length===0){
      liteToast("äº‘ç«¯è¿”å› 0 è¡Œï¼ˆä½†æ²¡æŠ¥é”™ï¼‰\nâœ… è¿™é€šå¸¸æ˜¯ RLS å¼€ç€å¯¼è‡´ SELECT è¢«è¿‡æ»¤\nè§£å†³ï¼šSupabase è¡¨ app_state å…ˆå…³ RLSï¼Œæˆ–åŠ  SELECT policyã€‚");
      return;
    }
    if(!res.ok){
      liteToast("æ‹‰å–HTTPå¤±è´¥ "+res.status+"ï¼š\n"+txt.slice(0,220));
      return;
    }
    if(Array.isArray(rows) && rows.length){
      const size = (txt||"").length;
      liteToast("äº‘ç«¯æœ‰æ•°æ® âœ…\nupdated_at: "+(rows[0].updated_at||"")+"\nJSONå­—èŠ‚: "+size);
    } else {
      liteToast("è¿”å›æ ¼å¼å¼‚å¸¸ï¼š\n"+txt.slice(0,240));
    }
  }

  window.addEventListener("load", ()=>{
    const btn = document.getElementById("btnCloudDiag");
    if(btn) btn.onclick = diagFetch;
  });

  // Hook cloudSaveï¼šæç¤ºå®é™…ä¸Šä¼ ä½“ç§¯ï¼ˆé¿å…ä¿å­˜äº†ç©ºæ•°æ®ï¼‰
  const oldSave = window.cloudSave;
  if(typeof oldSave==="function"){
    window.cloudSave = async function(){
      const raw = localStorage.getItem("orderProfitData") || "";
      const bytes = raw.length;
      await oldSave();
      liteToast("å·²æ‰§è¡Œä¿å­˜\næœ¬åœ°orderProfitDataå­—èŠ‚: "+bytes);
    };
  }
})();
</script>

    </div><!--APPROOT_END-->

    <!-- è®¾å¤‡ç»‘å®š/å®¡æ‰¹é®ç½©å±‚ -->
    <div id="authGate" class="auth-gate" style="display:none;">
      <div class="auth-card">
        <h2>è®¾å¤‡è®¿é—®æ§åˆ¶</h2>
        <div id="authGateBody"></div>
      </div>
    </div>

</body>
</html>