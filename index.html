<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
ï»¿<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†ä¸šè®¢å•åˆ©æ¶¦ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 10px;
            min-height: 100vh;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1080px;
            margin: 0 auto;
        }
        
        .header {
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
        
        .header h1 i {
            margin-right: 8px;
            font-size: 20px;
        }
        
        .total-profit {
            font-size: 24px;
            font-weight: 700;
            margin-top: 8px;
            display: flex;
            align-items: center;
        }
        
        .profit-positive {
            color: #2ecc71;
        }
        
        .profit-negative {
            color: #e74c3c;
        }
        
        .filter-status {
            font-size: 12px;
            color: #bdc3c7;
            margin-top: 4px;
            display: flex;
            align-items: center;
        }
        
        .filter-status i {
            margin-right: 4px;
        }
        
        .actions {
            display: flex;
            margin-bottom: 15px;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: thin;
            scrollbar-color: #bdc3c7 transparent;
        }
        
        .actions::-webkit-scrollbar {
            height: 4px;
        }
        
        .actions::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 2px;
        }
        
        .actions::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 2px;
        }
        
        .action-btn {
            flex: 0 0 auto;
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }
        
        .action-btn i {
            margin-right: 6px;
            font-size: 14px;
        }
        
        .btn-add {
            background-color: #3498db;
            color: white;
        }
        
        .btn-export {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-import {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-save {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-calculator {
            background-color: #e67e22;
            color: white;
        }
        
        .btn-filter {
            background-color: #1abc9c;
            color: white;
            position: relative;
        }
        
        .btn-filter.active {
            background-color: #16a085;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .btn-clear-filter {
            background-color: #95a5a6;
            color: white;
        }
        
        .filter-select-container {
            position: relative;
            flex: 0 0 auto;
            min-width: 140px;
        }
        
        .filter-select {
            width: 100%;
            padding: 10px 30px 10px 10px;
            border: none;
            border-radius: 6px;
            background-color: #ecf0f1;
            color: #2c3e50;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .filter-select:focus {
            outline: none;
            background-color: #dfe6e9;
        }
        
        .filter-select:hover {
            background-color: #dfe6e9;
        }
        
        .filter-select-container::after {
            content: '\f0d7';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            pointer-events: none;
        }
        
        .action-btn:hover, .filter-select:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }
        
        .action-btn:active, .filter-select:active {
            transform: translateY(0);
        }
        
        .table-container {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 15px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }
        
        thead {
            background-color: #34495e;
            color: white;
        }
        
        th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        
        th.sortable:hover {
            background-color: #2c3e50;
        }
        
        .sort-indicator {
            margin-left: 4px;
            opacity: 0.7;
        }
        
        tbody tr {
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tbody tr:hover {
            background-color: #f0f7ff;
        }
        
        td {
            padding: 8px;
            font-size: 12.5px;
        }
        
        input, select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12.5px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .profit-cell {
            font-weight: 600;
        }
        
        .date-cell {
            cursor: pointer;
            position: relative;
        }
        
        .date-cell:hover {
            color: #3498db;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .delete-btn i {
            font-size: 11px;
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .toast {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 500;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .file-input {
            display: none;
        }
        
        /* è®¡ç®—å™¨æ ·å¼ */
        .calculator-container {
            position: fixed;
            bottom: 15px;
            right: 15px;
            width: 300px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
            overflow: hidden;
        }
        
        .calculator-header {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .calculator-title {
            font-weight: 600;
            font-size: 15px;
        }
        
        .calculator-close {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .calculator-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .calculator-display {
            padding: 12px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
            text-align: right;
            font-size: 22px;
            font-weight: 600;
            min-height: 55px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            word-break: break-all;
            overflow-wrap: break-word;
            font-family: 'Courier New', monospace;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .calculator-history {
            font-size: 13px;
            color: #7f8c8d;
            min-height: 18px;
            width: 100%;
            text-align: right;
            margin-bottom: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .calculator-current {
            font-size: 26px;
            width: 100%;
            text-align: right;
            word-break: break-all;
        }
        
        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background-color: #ddd;
        }
        
        .calculator-btn {
            border: none;
            padding: 15px 8px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .calculator-btn:hover {
            background-color: #f5f5f5;
        }
        
        .calculator-btn.operator {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .calculator-btn.equals {
            background-color: #e67e22;
            color: white;
            font-weight: 600;
        }
        
        .calculator-btn.equals:hover {
            background-color: #d35400;
        }
        
        .calculator-btn.clear {
            background-color: #e74c3c;
            color: white;
            font-weight: 600;
        }
        
        .calculator-btn.clear:hover {
            background-color: #c0392b;
        }
        
        .calculator-btn.zero {
            grid-column: span 2;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            
            .header {
                margin-bottom: 12px;
                padding: 12px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .total-profit {
                font-size: 22px;
            }
            
            .actions {
                margin-bottom: 12px;
                gap: 6px;
            }
            
            .action-btn, .filter-select {
                font-size: 12px;
                padding: 8px 10px;
            }
            
            .action-btn i {
                font-size: 13px;
                margin-right: 4px;
            }
            
            .filter-select-container {
                min-width: 120px;
            }
            
            .filter-select {
                padding: 8px 25px 8px 8px;
            }
            
            th, td {
                padding: 6px;
                font-size: 12px;
            }
            
            input, select {
                padding: 5px 6px;
                font-size: 12px;
            }
            
            .table-container {
                margin-bottom: 12px;
            }
            
            .calculator-container {
                width: 280px;
                right: 8px;
                bottom: 8px;
            }
            
            .calculator-display {
                font-size: 18px;
                min-height: 50px;
            }
            
            .calculator-history {
                font-size: 11px;
            }
            
            .calculator-current {
                font-size: 22px;
            }
            
            .calculator-btn {
                padding: 12px 6px;
                font-size: 14px;
            }
        }
    </style>

<style id="cloud-product-level-ui">
/* äº§å“çº§ â˜ï¸ æŒ‰é’®è°ƒä¼˜ */
.cloud-fab, .cloud-button, #cloudButton {
  top: calc(env(safe-area-inset-top, 0px) + 40px) !important;
  right: 16px !important;
  bottom: auto !important;
  box-shadow: 0 6px 18px rgba(0,0,0,.18);
  transition: opacity .25s ease, transform .25s ease;
}

/* æ»šåŠ¨æ—¶å¼±åŒ–å­˜åœ¨æ„Ÿ */
body.scrolling-down .cloud-fab,
body.scrolling-down .cloud-button,
body.scrolling-down #cloudButton {
  opacity: .55;
  transform: scale(.96);
}
</style>


<style id="cloud-force-shift">
/* å¼ºåˆ¶è§†è§‰ä¸‹ç§»ï¼šæ— è®ºåŸæœ¬ç”¨ top / transform / JS è®¡ç®— */
.cloud-fab, .cloud-button, #cloudButton {
  transform: translateY(20px) !important;
}
</style>


<style id="cloud-final-fix">
/* è°ƒè¯•çº§å¼ºåˆ¶ä½ç§»ï¼š60pxï¼Œå¿…é¡»è‚‰çœ¼å¯è§ */
.cloud-fab, .cloud-button, #cloudButton,
[data-cloud], [data-cloud-button], .cloud-entry {
  transform: translateY(60px) !important;
  outline: 2px dashed red !important;
}

/* åœ¨é¡¶éƒ¨ç”»ä¸€æ¡å‚è€ƒçº¿ï¼Œæ–¹ä¾¿å¯¹æ¯” */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: red;
  z-index: 9999;
}
</style>


<style id="v15k-no-redline">
/* å¼ºåˆ¶ç§»é™¤ä»»ä½•å†å²è°ƒè¯•çº¢çº¿/çº¢æ¡† */
body::before { content: none !important; display: none !important; }
*[style*="outline: 2px dashed red"], *[style*="outline:2px dashed red"] { outline: none !important; }
</style>

</head>
<body>

<!--
=====================================================
æé’±å§ v4 Â· å¤–æŒ‚éª¨æ¶ STEP 2ï¼ˆå®˜æ–¹åœ°åŸºç‰ˆï¼‰
-----------------------------------------------------
å®šä¹‰ï¼š
- æœ¬æ–‡ä»¶æ˜¯â€œå¤–æŒ‚ç³»ç»Ÿâ€çš„å”¯ä¸€åˆæ³•åœ°åŸº
- åªéªŒè¯ï¼šUI + ç‚¹å‡»é“¾è·¯ + äººå·¥è§¦å‘
- ä¸æ¥ Supabase
- ä¸è¯»å†™ orders
- ä¸è‡ªåŠ¨è§¦å‘ä»»ä½•äº‘ç«¯è¡Œä¸º

ä»»ä½•äº‘ç«¯èƒ½åŠ›ï¼š
- å¿…é¡»åœ¨æ­¤æ–‡ä»¶åŸºç¡€ä¸Šæ¼”è¿›
- å¿…é¡»ä¿æŒâ€œæ‰‹åŠ¨ç‚¹å‡»è§¦å‘â€
=====================================================
-->

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> å•†ä¸šè®¢å•åˆ©æ¶¦ç®¡ç†ç³»ç»Ÿ</h1>
            <p>æ€»è®¡ <span id="total-count">0</span> ç¬”è®¢å•</p>
            <div class="total-profit" id="total-profit">æ€»åˆ©æ¶¦: Â¥0.00</div>
            <div class="filter-status" id="filter-status">
                <i class="fas fa-filter"></i> <span id="filter-status-text">æ˜¾ç¤ºå…¨éƒ¨è®¢å•</span>
            </div>
        </div>
        
        <div class="actions">
            <button class="action-btn btn-add" id="add-btn">
                <i class="fas fa-plus-circle"></i> æ–°å¢
            </button>
            <button class="action-btn btn-export" id="export-btn">
                <i class="fas fa-file-export"></i> å¯¼å‡º
            </button>
            <button class="action-btn btn-import" id="import-btn">
                <i class="fas fa-file-import"></i> å¯¼å…¥
            </button>
            <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls">
            <button class="action-btn btn-save" id="save-btn">
                <i class="fas fa-save"></i> ä¿å­˜
            </button>
            <button class="action-btn btn-calculator" id="calculator-btn">
                <i class="fas fa-calculator"></i> è®¡ç®—å™¨
            </button>
            
            <!-- ä¸‹å•äººç­›é€‰æ¡† -->
            <div class="filter-select-container">
                <select class="filter-select" id="customer-filter">
                    <option value="">å…¨éƒ¨ä¸‹å•äºº</option>
                    <!-- ä¸‹å•äººé€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </select>
            </div>
            
            <!-- äº§å“ç­›é€‰æ¡† -->
            <div class="filter-select-container">
                <select class="filter-select" id="product-filter">
                    <option value="">å…¨éƒ¨äº§å“</option>
                    <!-- äº§å“é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </select>
            </div>
            
            <button class="action-btn btn-clear-filter" id="clear-filter">
                <i class="fas fa-times-circle"></i> æ¸…é™¤ç­›é€‰
            </button>
        </div>
        
        <div class="table-container">
            <table id="orders-table">
                <thead>
                    <tr>
                        <th style="width: 70px;" class="sortable" id="date-header">
                            æ—¥æœŸ
                            <span class="sort-indicator" id="date-sort">â†“</span>
                        </th>
                        <th>ä¸‹å•äºº</th>
                        <th>äº§å“</th>
                        <th style="width: 80px;">ä¸‹å•é‡‘é¢</th>
                        <th style="width: 60px;">è¿”æ¬¾</th>
                        <th style="width: 60px;">è¿è´¹</th>
                        <th style="width: 80px;" class="sortable" id="sell-amount-header">
                            å”®å‡ºé‡‘é¢
                            <span class="sort-indicator" id="sell-amount-sort">â†•</span>
                        </th>
                        <th style="width: 80px;">åˆ©æ¶¦</th>
                        <th style="width: 100px;">ç‰©æµå•å·</th>
                        <th>å¤‡æ³¨</th>
                        <th style="width: 60px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- è¡Œå°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            å•†ä¸šè®¢å•åˆ©æ¶¦ç®¡ç†ç³»ç»Ÿ &copy; 2026 | ä¸“ä¸ºç§»åŠ¨ç«¯ä¼˜åŒ–
        </div>
    </div>
    
    <!-- è®¡ç®—å™¨å®¹å™¨ -->
    <div class="calculator-container" id="calculator">
        <div class="calculator-header">
            <div class="calculator-title">è®¡ç®—å™¨</div>
            <button class="calculator-close" id="calculator-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="calculator-display">
            <div class="calculator-history" id="calculator-history"></div>
            <div class="calculator-current" id="calculator-current">0</div>
        </div>
        <div class="calculator-buttons">
            <button class="calculator-btn clear" data-action="clear">C</button>
            <button class="calculator-btn clear" data-action="clear-entry">CE</button>
            <button class="calculator-btn operator" data-action="percent">%</button>
            <button class="calculator-btn operator" data-action="divide">Ã·</button>
            
            <button class="calculator-btn" data-number="7">7</button>
            <button class="calculator-btn" data-number="8">8</button>
            <button class="calculator-btn" data-number="9">9</button>
            <button class="calculator-btn operator" data-action="multiply">Ã—</button>
            
            <button class="calculator-btn" data-number="4">4</button>
            <button class="calculator-btn" data-number="5">5</button>
            <button class="calculator-btn" data-number="6">6</button>
            <button class="calculator-btn operator" data-action="subtract">-</button>
            
            <button class="calculator-btn" data-number="1">1</button>
            <button class="calculator-btn" data-number="2">2</button>
            <button class="calculator-btn" data-number="3">3</button>
            <button class="calculator-btn operator" data-action="add">+</button>
            
            <button class="calculator-btn zero" data-number="0">0</button>
            <button class="calculator-btn" data-action="decimal">.</button>
            <button class="calculator-btn equals" data-action="equals">=</button>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // åˆå§‹åŒ–æ•°æ®
        let orders = JSON.parse(localStorage.getItem('orderProfitData')) || [];
        let isDateFullFormat = {};
        
        // æ’åºçŠ¶æ€
        let dateSortState = 'desc'; // 'none', 'asc', 'desc' - é»˜è®¤æŒ‰æ—¥æœŸé™åº
        let sellAmountSortState = 'none'; // 'none', 'asc', 'desc'
        
        // ç­›é€‰çŠ¶æ€
        let currentCustomerFilter = ''; // å½“å‰ç­›é€‰çš„ä¸‹å•äºº
        let currentProductFilter = ''; // å½“å‰ç­›é€‰çš„äº§å“
        
        // DOMå…ƒç´ 
        const tableBody = document.getElementById('table-body');
        const addBtn = document.getElementById('add-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const fileInput = document.getElementById('file-input');
        const saveBtn = document.getElementById('save-btn');
        const calculatorBtn = document.getElementById('calculator-btn');
        const totalProfitElement = document.getElementById('total-profit');
        const totalCountElement = document.getElementById('total-count');
        const toast = document.getElementById('toast');
        const dateHeader = document.getElementById('date-header');
        const dateSortIndicator = document.getElementById('date-sort');
        const sellAmountHeader = document.getElementById('sell-amount-header');
        const sellAmountSortIndicator = document.getElementById('sell-amount-sort');
        const filterStatusText = document.getElementById('filter-status-text');
        
        // ç­›é€‰ç›¸å…³DOMå…ƒç´ 
        const customerFilter = document.getElementById('customer-filter');
        const productFilter = document.getElementById('product-filter');
        const clearFilterBtn = document.getElementById('clear-filter');
        
        // è®¡ç®—å™¨ç›¸å…³DOMå…ƒç´ 
        const calculator = document.getElementById('calculator');
        const calculatorCurrent = document.getElementById('calculator-current');
        const calculatorHistory = document.getElementById('calculator-history');
        const calculatorClose = document.getElementById('calculator-close');
        const calculatorButtons = document.querySelectorAll('.calculator-btn');
        
        // è®¡ç®—å™¨çŠ¶æ€
        let calculatorDisplayValue = '0';
        let calculatorHistoryValue = '';
        let firstOperand = null;
        let operator = null;
        let waitingForSecondOperand = false;
        let shouldResetDisplay = false;
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸ºæœˆ-æ—¥
        function formatDateToMonthDay(dateString) {
            if (!dateString || dateString === 'undefined') return 'ç‚¹å‡»è®¾ç½®';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}-${day}`;
        }
        
        // è®¡ç®—å•è¡Œåˆ©æ¶¦
        function calculateProfit(sellAmount, orderAmount, refund, shipping) {
            const sell = parseFloat(sellAmount) || 0;
            const order = parseFloat(orderAmount) || 0;
            const ref = parseFloat(refund) || 0;
            const ship = parseFloat(shipping) || 0;
            
            return sell - order - ref - ship;
        }
        
        // æ ¼å¼åŒ–è´§å¸
        function formatCurrency(amount) {
            return 'Â¥' + parseFloat(amount || 0).toFixed(2);
        }
        
        // è®¡ç®—å¹¶æ›´æ–°æ€»åˆ©æ¶¦
        function updateTotalProfit() {
            let totalProfit = 0;
            const filteredOrders = getFilteredOrders();
            
            filteredOrders.forEach(order => {
                const profit = calculateProfit(
                    order.sellAmount, 
                    order.orderAmount, 
                    order.refund, 
                    order.shipping
                );
                totalProfit += profit;
            });
            
            totalProfitElement.textContent = `æ€»åˆ©æ¶¦: ${formatCurrency(totalProfit)}`;
            totalProfitElement.className = `total-profit ${totalProfit >= 0 ? 'profit-positive' : 'profit-negative'}`;
            totalCountElement.textContent = filteredOrders.length;
        }
        
        // è·å–ç­›é€‰åçš„è®¢å•
        function getFilteredOrders() {
            return orders.filter(order => {
                // æ£€æŸ¥ä¸‹å•äººç­›é€‰
                const customerMatch = !currentCustomerFilter || order.customer === currentCustomerFilter;
                // æ£€æŸ¥äº§å“ç­›é€‰
                const productMatch = !currentProductFilter || order.product === currentProductFilter;
                
                return customerMatch && productMatch;
            });
        }
        
        // æ ¹æ®æ’åºçŠ¶æ€æ’åºè®¢å•
        function sortOrders(ordersToSort) {
            if (dateSortState === 'none' && sellAmountSortState === 'none') {
                return ordersToSort;
            }
            
            // åˆ›å»ºå‰¯æœ¬è¿›è¡Œæ’åº
            const sortedOrders = [...ordersToSort];
            
            sortedOrders.sort((a, b) => {
                // ä¼˜å…ˆæŒ‰æ—¥æœŸæ’åº
                if (dateSortState !== 'none') {
                    const aDate = new Date(a.date || '1970-01-01').getTime();
                    const bDate = new Date(b.date || '1970-01-01').getTime();
                    
                    if (aDate !== bDate) {
                        return dateSortState === 'desc' ? bDate - aDate : aDate - bDate;
                    }
                }
                
                // å¦‚æœæ—¥æœŸç›¸åŒï¼Œå†æŒ‰å”®å‡ºé‡‘é¢æ’åº
                if (sellAmountSortState !== 'none') {
                    const aAmount = parseFloat(a.sellAmount) || 0;
                    const bAmount = parseFloat(b.sellAmount) || 0;
                    
                    if (aAmount !== bAmount) {
                        return sellAmountSortState === 'desc' ? bAmount - aAmount : aAmount - bAmount;
                    }
                }
                
                return 0;
            });
            
            return sortedOrders;
        }
        
        // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
        function updateSortIndicators() {
            // æ›´æ–°æ—¥æœŸæ’åºæŒ‡ç¤ºå™¨
            switch(dateSortState) {
                case 'none':
                    dateSortIndicator.textContent = 'â†•';
                    break;
                case 'asc':
                    dateSortIndicator.textContent = 'â†‘';
                    break;
                case 'desc':
                    dateSortIndicator.textContent = 'â†“';
                    break;
            }
            
            // æ›´æ–°å”®å‡ºé‡‘é¢æ’åºæŒ‡ç¤ºå™¨
            switch(sellAmountSortState) {
                case 'none':
                    sellAmountSortIndicator.textContent = 'â†•';
                    break;
                case 'asc':
                    sellAmountSortIndicator.textContent = 'â†‘';
                    break;
                case 'desc':
                    sellAmountSortIndicator.textContent = 'â†“';
                    break;
            }
        }
        
        // åˆ‡æ¢æ—¥æœŸæ’åºçŠ¶æ€
        function toggleDateSort() {
            const states = ['desc', 'asc', 'none'];
            const currentIndex = states.indexOf(dateSortState);
            dateSortState = states[(currentIndex + 1) % states.length];
            
            // å¦‚æœå¯ç”¨äº†æ—¥æœŸæ’åºï¼Œåˆ™ç¦ç”¨å”®å‡ºé‡‘é¢æ’åº
            if (dateSortState !== 'none') {
                sellAmountSortState = 'none';
            }
            
            updateSortIndicators();
            renderTable();
            updateTotalProfit();
            showToast(`å·²æŒ‰æ—¥æœŸ${dateSortState === 'none' ? 'å–æ¶ˆæ’åº' : dateSortState === 'asc' ? 'å‡åºæ’åº' : 'é™åºæ’åº'}`);
        }
        
        // åˆ‡æ¢å”®å‡ºé‡‘é¢æ’åºçŠ¶æ€
        function toggleSellAmountSort() {
            const states = ['none', 'asc', 'desc'];
            const currentIndex = states.indexOf(sellAmountSortState);
            sellAmountSortState = states[(currentIndex + 1) % states.length];
            
            // å¦‚æœå¯ç”¨äº†å”®å‡ºé‡‘é¢æ’åºï¼Œåˆ™ç¦ç”¨æ—¥æœŸæ’åº
            if (sellAmountSortState !== 'none') {
                dateSortState = 'none';
            }
            
            updateSortIndicators();
            renderTable();
            showToast(`å·²æŒ‰å”®å‡ºé‡‘é¢${sellAmountSortState === 'none' ? 'å–æ¶ˆæ’åº' : sellAmountSortState === 'asc' ? 'å‡åºæ’åº' : 'é™åºæ’åº'}`);
        }
        
        // åˆ›å»ºè¡¨æ ¼è¡Œ
        function createTableRow(order, index) {
            const row = document.createElement('tr');
            const profit = calculateProfit(order.sellAmount, order.orderAmount, order.refund, order.shipping);
            
            // å¤„ç†æ—¥æœŸæ˜¾ç¤º
            const dateDisplay = isDateFullFormat[index] ? order.date : formatDateToMonthDay(order.date);
            
            row.innerHTML = `
                <td class="date-cell" data-index="${index}" data-full-date="${order.date || ''}">${dateDisplay}</td>
                <td><input type="text" class="editable" data-field="customer" value="${order.customer || ''}"></td>
                <td><input type="text" class="editable" data-field="product" value="${order.product || ''}"></td>
                <td><input type="number" step="0.01" class="editable" data-field="orderAmount" value="${order.orderAmount || '0'}"></td>
                <td><input type="number" step="0.01" class="editable" data-field="refund" value="${order.refund || '0'}"></td>
                <td><input type="number" step="0.01" class="editable" data-field="shipping" value="${order.shipping || '0'}"></td>
                <td><input type="number" step="0.01" class="editable" data-field="sellAmount" value="${order.sellAmount || '0'}"></td>
                <td class="profit-cell" style="color: ${profit >= 0 ? '#2ecc71' : '#e74c3c'}">${formatCurrency(profit)}</td>
                <td><input type="text" class="editable" data-field="trackingNumber" value="${order.trackingNumber || ''}"></td>
                <td>
                    <div style="display:flex;align-items:center;gap:4px;">
                        <input type="text" class="editable note-input" data-field="notes" value="${order.notes || ''}">
                        <button type="button" class="scan-btn" title="æ‰«ç å¡«å…¥å¤‡æ³¨">ğŸ“·</button>
                    </div>
                </td>
                <td><button class="delete-btn" data-index="${index}"><i class="fas fa-trash"></i> åˆ é™¤</button></td>
            `;
            
            return row;
        }
        
        // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
        function updateFilterStatus() {
            const filteredOrders = getFilteredOrders();
            let statusText = '';
            
            if (currentCustomerFilter && currentProductFilter) {
                statusText = `ç­›é€‰: ä¸‹å•äºº=${currentCustomerFilter}, äº§å“=${currentProductFilter} (${filteredOrders.length} æ¡è®°å½•)`;
            } else if (currentCustomerFilter) {
                statusText = `ç­›é€‰: ä¸‹å•äºº=${currentCustomerFilter} (${filteredOrders.length} æ¡è®°å½•)`;
            } else if (currentProductFilter) {
                statusText = `ç­›é€‰: äº§å“=${currentProductFilter} (${filteredOrders.length} æ¡è®°å½•)`;
            } else {
                statusText = `æ˜¾ç¤ºå…¨éƒ¨è®¢å• (${filteredOrders.length} æ¡è®°å½•)`;
            }
            
            filterStatusText.textContent = statusText;
            filterStatusText.style.color = (currentCustomerFilter || currentProductFilter) ? '#3498db' : '#bdc3c7';
        }
        
        // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
        function updateFilterOptions() {
            // è·å–æ‰€æœ‰ä¸é‡å¤çš„ä¸‹å•äºº
            const customers = [...new Set(orders.map(order => order.customer).filter(c => c))];
            // è·å–æ‰€æœ‰ä¸é‡å¤çš„äº§å“
            const products = [...new Set(orders.map(order => order.product).filter(p => p))];
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"å…¨éƒ¨ä¸‹å•äºº"é€‰é¡¹ï¼‰
            const currentCustomerValue = customerFilter.value;
            customerFilter.innerHTML = '<option value="">å…¨éƒ¨ä¸‹å•äºº</option>';
            
            // æ·»åŠ ä¸‹å•äººé€‰é¡¹
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer;
                option.textContent = customer;
                customerFilter.appendChild(option);
            });
            
            // æ¢å¤å½“å‰é€‰ä¸­çš„å€¼
            customerFilter.value = currentCustomerValue;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"å…¨éƒ¨äº§å“"é€‰é¡¹ï¼‰
            const currentProductValue = productFilter.value;
            productFilter.innerHTML = '<option value="">å…¨éƒ¨äº§å“</option>';
            
            // æ·»åŠ äº§å“é€‰é¡¹
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productFilter.appendChild(option);
            });
            
            // æ¢å¤å½“å‰é€‰ä¸­çš„å€¼
            productFilter.value = currentProductValue;
        }
        
        // åº”ç”¨ç­›é€‰
        function applyFilter() {
            currentCustomerFilter = customerFilter.value;
            currentProductFilter = productFilter.value;
            renderTable();
            updateFilterStatus();
            
            if (currentCustomerFilter || currentProductFilter) {
                let message = 'å·²ç­›é€‰: ';
                if (currentCustomerFilter) message += `ä¸‹å•äºº=${currentCustomerFilter}`;
                if (currentCustomerFilter && currentProductFilter) message += ', ';
                if (currentProductFilter) message += `äº§å“=${currentProductFilter}`;
                showToast(message);
            } else {
                showToast('å·²æ˜¾ç¤ºå…¨éƒ¨è®¢å•');
            }
        }
        
        // æ¸…é™¤ç­›é€‰
        function clearFilter() {
            customerFilter.value = '';
            productFilter.value = '';
            currentCustomerFilter = '';
            currentProductFilter = '';
            renderTable();
            updateFilterStatus();
            showToast('ç­›é€‰å·²æ¸…é™¤ï¼Œæ˜¾ç¤ºå…¨éƒ¨è®¢å•');
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            tableBody.innerHTML = '';
            
            const filteredOrders = getFilteredOrders();
            
            if (filteredOrders.length === 0) {
                const emptyRow = document.createElement('tr');
                let message = '';
                
                if (currentCustomerFilter && currentProductFilter) {
                    message = `æ²¡æœ‰æ‰¾åˆ°ä¸‹å•äººä¸º"${currentCustomerFilter}"ä¸”äº§å“ä¸º"${currentProductFilter}"çš„è®¢å•è®°å½•`;
                } else if (currentCustomerFilter) {
                    message = `æ²¡æœ‰æ‰¾åˆ°ä¸‹å•äººä¸º"${currentCustomerFilter}"çš„è®¢å•è®°å½•`;
                } else if (currentProductFilter) {
                    message = `æ²¡æœ‰æ‰¾åˆ°äº§å“ä¸º"${currentProductFilter}"çš„è®¢å•è®°å½•`;
                } else {
                    message = 'æš‚æ— è®¢å•æ•°æ®ï¼Œç‚¹å‡»ä¸Šæ–¹"æ–°å¢"æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡è®¢å•è®°å½•';
                }
                
                emptyRow.innerHTML = `<td colspan="11" style="text-align: center; padding: 20px; color: #7f8c8d;">${message}</td>`;
                tableBody.appendChild(emptyRow);
                return;
            }
            
            // æ ¹æ®æ’åºçŠ¶æ€è·å–è®¢å•åˆ—è¡¨
            const ordersToRender = sortOrders(filteredOrders);
            
            // æ¸²æŸ“è®¢å•è¡Œ
            ordersToRender.forEach((order, index) => {
                // è·å–åŸå§‹ç´¢å¼•
                const originalIndex = orders.indexOf(order);
                const row = createTableRow(order, originalIndex);
                tableBody.appendChild(row);
            });
            
            // é‡æ–°ç»‘å®šäº‹ä»¶
            bindEvents();
            
            // æ›´æ–°æ€»åˆ©æ¶¦
            updateTotalProfit();
            
            // æ›´æ–°ç­›é€‰çŠ¶æ€
            updateFilterStatus();
        }
        
        // æ·»åŠ æ–°è¡Œ
        function addNewRow() {
            const newOrder = {
                date: new Date().toISOString().split('T')[0],
                customer: '',
                product: '',
                orderAmount: '0',
                refund: '0',
                shipping: '0',
                sellAmount: '0',
                trackingNumber: '',
                notes: ''
            };
            
            // æ–°è®¢å•æ·»åŠ åˆ°æ•°ç»„å¼€å¤´
            orders.unshift(newOrder);
            
            // ç¡®ä¿æŒ‰æ—¥æœŸé™åºæ’åº
            dateSortState = 'desc';
            sellAmountSortState = 'none';
            
            // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
            updateFilterOptions();
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderTable();
            
            showToast('å·²æ·»åŠ æ–°è®¢å•è¡Œï¼Œè¯·ç¼–è¾‘ä¿¡æ¯');
        }
        
        // åˆ é™¤è¡Œ
        function deleteRow(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®¢å•è®°å½•å—ï¼Ÿ')) {
                // ä»æ•°ç»„ä¸­åˆ é™¤
                const deletedCustomer = orders[index].customer;
                const deletedProduct = orders[index].product;
                orders.splice(index, 1);
                
                // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
                updateFilterOptions();
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç­›é€‰çš„ä¸‹å•äººæˆ–äº§å“ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…é™¤ç­›é€‰
                if (currentCustomerFilter === deletedCustomer || currentProductFilter === deletedProduct) {
                    // é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼Œç­›é€‰å™¨ä¼šè‡ªåŠ¨å¤„ç†
                    renderTable();
                } else {
                    renderTable();
                }
                
                showToast('è®¢å•å·²åˆ é™¤');
            }
        }
        
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨ - ä¿®å¤ï¼šå§‹ç»ˆä¿å­˜å…¨éƒ¨æ•°æ®
        function saveData() {
            try {
                // ä»è¡¨æ ¼ä¸­è·å–æœ€æ–°æ•°æ®ï¼ˆåªæ›´æ–°æ˜¾ç¤ºçš„è¡Œï¼‰
                updateOrdersFromTable();
                
                // ä¿å­˜å…¨éƒ¨è®¢å•æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('orderProfitData', JSON.stringify(orders));
                showToast('æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä¿å­˜å…¨éƒ¨æ•°æ®ï¼‰');
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®æ—¶å‡ºé”™:', error);
                showToast('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // ä»è¡¨æ ¼ä¸­æ›´æ–°è®¢å•æ•°æ® - ä¿®å¤ï¼šåªæ›´æ–°æ˜¾ç¤ºçš„è¡Œï¼Œä¸æ›¿æ¢æ•´ä¸ªordersæ•°ç»„
        function updateOrdersFromTable() {
            const rows = tableBody.querySelectorAll('tr');
            
            // éå†æ‰€æœ‰è¡Œ
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                
                // è·³è¿‡ç©ºè¡Œæç¤º
                if (row.cells.length <= 1) continue;
                
                const inputs = row.querySelectorAll('input');
                if (inputs.length === 0) continue;
                
                // è·å–è¡Œçš„åŸå§‹ç´¢å¼•
                const dateCell = row.querySelector('.date-cell');
                const indexAttr = dateCell ? dateCell.getAttribute('data-index') : null;
                
                if (indexAttr === null || indexAttr === undefined) continue;
                
                const index = parseInt(indexAttr);
                
                // å¦‚æœç´¢å¼•æœ‰æ•ˆï¼Œæ›´æ–°å¯¹åº”çš„è®¢å•æ•°æ®
                if (index >= 0 && index < orders.length) {
                    // è·å–æ—¥æœŸ
                    const dateValue = dateCell ? dateCell.getAttribute('data-full-date') : '';
                    
                    // æ›´æ–°è®¢å•æ•°æ®
                    orders[index].date = dateValue || new Date().toISOString().split('T')[0];
                    orders[index].customer = inputs[0] ? inputs[0].value : '';
                    orders[index].product = inputs[1] ? inputs[1].value : '';
                    orders[index].orderAmount = inputs[2] ? inputs[2].value : '0';
                    orders[index].refund = inputs[3] ? inputs[3].value : '0';
                    orders[index].shipping = inputs[4] ? inputs[4].value : '0';
                    orders[index].sellAmount = inputs[5] ? inputs[5].value : '0';
                    orders[index].trackingNumber = inputs[6] ? inputs[6].value : '';
                    orders[index].notes = inputs[7] ? inputs[7].value : '';
                }
            }
            
            // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
            updateFilterOptions();
        }
        
        // å¯¼å‡ºä¸ºExcel - ä¿®å¤ï¼šå¯¼å‡ºå…¨éƒ¨æ•°æ®ï¼Œä¸ä»…ä»…æ˜¯ç­›é€‰åçš„æ•°æ®
        function exportToExcel() {
            try {
                // é¦–å…ˆæ›´æ–°è¡¨æ ¼ä¸­çš„æ•°æ®åˆ°ordersæ•°ç»„
                updateOrdersFromTable();
                
                // å‡†å¤‡å¯¼å‡ºæ•°æ® - å¯¼å‡ºå…¨éƒ¨æ•°æ®
                const exportData = orders.map(order => {
                    const profit = calculateProfit(
                        order.sellAmount, 
                        order.orderAmount, 
                        order.refund, 
                        order.shipping
                    );
                    
                    return {
                        'æ—¥æœŸ': order.date,
                        'ä¸‹å•äºº': order.customer,
                        'äº§å“': order.product,
                        'ä¸‹å•é‡‘é¢': parseFloat(order.orderAmount) || 0,
                        'è¿”æ¬¾': parseFloat(order.refund) || 0,
                        'è¿è´¹': parseFloat(order.shipping) || 0,
                        'å”®å‡ºé‡‘é¢': parseFloat(order.sellAmount) || 0,
                        'åˆ©æ¶¦': profit,
                        'ç‰©æµå•å·': order.trackingNumber,
                        'å¤‡æ³¨': order.notes
                    };
                });
                
                // æ·»åŠ æ±‡æ€»è¡Œ
                const totalProfit = exportData.reduce((sum, row) => sum + row.åˆ©æ¶¦, 0);
                exportData.push({
                    'æ—¥æœŸ': 'æ±‡æ€»',
                    'ä¸‹å•äºº': '',
                    'äº§å“': '',
                    'ä¸‹å•é‡‘é¢': '',
                    'è¿”æ¬¾': '',
                    'è¿è´¹': '',
                    'å”®å‡ºé‡‘é¢': 'æ€»è®¡',
                    'åˆ©æ¶¦': totalProfit,
                    'ç‰©æµå•å·': '',
                    'å¤‡æ³¨': ''
                });
                
                // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'è®¢å•åˆ©æ¶¦æ•°æ®');
                
                // è®¾ç½®åˆ—å®½
                const wscols = [
                    {wch: 12}, // æ—¥æœŸ
                    {wch: 10}, // ä¸‹å•äºº
                    {wch: 20}, // äº§å“
                    {wch: 10}, // ä¸‹å•é‡‘é¢
                    {wch: 10}, // è¿”æ¬¾
                    {wch: 10}, // è¿è´¹
                    {wch: 10}, // å”®å‡ºé‡‘é¢
                    {wch: 10}, // åˆ©æ¶¦
                    {wch: 20}, // ç‰©æµå•å·
                    {wch: 30}  // å¤‡æ³¨
                ];
                worksheet['!cols'] = wscols;
                
                // ç”Ÿæˆæ–‡ä»¶å
                const dateStr = new Date().toISOString().split('T')[0];
                const filename = `è®¢å•åˆ©æ¶¦æ•°æ®_${dateStr}.xlsx`;
                
                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(workbook, filename);
                showToast('æ•°æ®å·²å¯¼å‡ºä¸ºExcelæ–‡ä»¶ï¼ˆå¯¼å‡ºå…¨éƒ¨æ•°æ®ï¼‰');
            } catch (error) {
                console.error('å¯¼å‡ºExcelæ—¶å‡ºé”™:', error);
                showToast('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }
        
        // ä»Excelå¯¼å…¥
        function importFromExcel(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // è½¬æ¢æ•°æ®æ ¼å¼
                    const importedOrders = jsonData
                        .filter(row => row['æ—¥æœŸ'] && row['æ—¥æœŸ'] !== 'æ±‡æ€»')
                        .map(row => ({
                            date: row['æ—¥æœŸ'] instanceof Date ? 
                                  row['æ—¥æœŸ'].toISOString().split('T')[0] : 
                                  String(row['æ—¥æœŸ'] || ''),
                            customer: String(row['ä¸‹å•äºº'] || ''),
                            product: String(row['äº§å“'] || ''),
                            orderAmount: String(row['ä¸‹å•é‡‘é¢'] || '0'),
                            refund: String(row['è¿”æ¬¾'] || '0'),
                            shipping: String(row['è¿è´¹'] || '0'),
                            sellAmount: String(row['å”®å‡ºé‡‘é¢'] || '0'),
                            trackingNumber: String(row['ç‰©æµå•å·'] || ''),
                            notes: String(row['å¤‡æ³¨'] || '')
                        }));
                    
                    if (importedOrders.length === 0) {
                        showToast('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„è®¢å•æ•°æ®');
                        return;
                    }
                    
                    // ç¡®è®¤å¯¼å…¥
                    if (confirm(`ä»Excelæ–‡ä»¶ä¸­æ‰¾åˆ° ${importedOrders.length} æ¡è®¢å•è®°å½•ï¼Œæ˜¯å¦å¯¼å…¥ï¼Ÿ`)) {
                        orders = importedOrders;
                        // é‡ç½®æ’åºçŠ¶æ€ä¸ºæ—¥æœŸé™åº
                        dateSortState = 'desc';
                        sellAmountSortState = 'none';
                        updateSortIndicators();
                        // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
                        updateFilterOptions();
                        renderTable();
                        showToast(`æˆåŠŸå¯¼å…¥ ${importedOrders.length} æ¡è®¢å•è®°å½•`);
                    }
                } catch (error) {
                    console.error('å¯¼å…¥Excelæ—¶å‡ºé”™:', error);
                    showToast('å¯¼å…¥å¤±è´¥: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ç»‘å®šè¾“å…¥æ¡†å˜åŒ–äº‹ä»¶
            const inputs = tableBody.querySelectorAll('input');
            inputs.forEach(input => {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
                
                newInput.addEventListener('change', function() {
                    const row = this.closest('tr');
                    const indexAttr = row.querySelector('.date-cell')?.getAttribute('data-index');
                    
                    if (indexAttr === null || indexAttr === undefined) return;
                    
                    const index = parseInt(indexAttr);
                    const field = this.getAttribute('data-field');
                    
                    // æ›´æ–°æ•°æ®
                    if (index >= 0 && index < orders.length) {
                        orders[index][field] = this.value;
                        
                        // å¦‚æœæ˜¯ä¸‹å•äººæˆ–äº§å“å­—æ®µå‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°ç­›é€‰å™¨é€‰é¡¹
                        if (field === 'customer' || field === 'product') {
                            updateFilterOptions();
                        }
                        
                        // é‡æ–°è®¡ç®—åˆ©æ¶¦
                        const profitCell = row.querySelector('.profit-cell');
                        if (profitCell) {
                            const profit = calculateProfit(
                                orders[index].sellAmount,
                                orders[index].orderAmount,
                                orders[index].refund,
                                orders[index].shipping
                            );
                            
                            profitCell.textContent = formatCurrency(profit);
                            profitCell.style.color = profit >= 0 ? '#2ecc71' : '#e74c3c';
                            
                            // æ›´æ–°æ€»åˆ©æ¶¦
                            updateTotalProfit();
                        }
                    }
                });
                
                // å®æ—¶è®¡ç®—
                newInput.addEventListener('input', function() {
                    if (this.hasAttribute('data-field')) {
                        const row = this.closest('tr');
                        const field = this.getAttribute('data-field');
                        
                        if (field === 'orderAmount' || field === 'refund' || 
                            field === 'shipping' || field === 'sellAmount') {
                            
                            const orderAmountInput = row.querySelector('input[data-field="orderAmount"]');
                            const refundInput = row.querySelector('input[data-field="refund"]');
                            const shippingInput = row.querySelector('input[data-field="shipping"]');
                            const sellAmountInput = row.querySelector('input[data-field="sellAmount"]');
                            
                            if (!orderAmountInput || !refundInput || !shippingInput || !sellAmountInput) return;
                            
                            const orderAmount = parseFloat(orderAmountInput.value) || 0;
                            const refund = parseFloat(refundInput.value) || 0;
                            const shipping = parseFloat(shippingInput.value) || 0;
                            const sellAmount = parseFloat(sellAmountInput.value) || 0;
                            
                            const profit = sellAmount - orderAmount - refund - shipping;
                            const profitCell = row.querySelector('.profit-cell');
                            
                            if (profitCell) {
                                profitCell.textContent = formatCurrency(profit);
                                profitCell.style.color = profit >= 0 ? '#2ecc71' : '#e74c3c';
                                
                                // æ›´æ–°æ€»åˆ©æ¶¦
                                updateTotalProfit();
                            }
                        }
                    }
                });
            });
            
            // ç»‘å®šæ—¥æœŸå•å…ƒæ ¼ç‚¹å‡»äº‹ä»¶
            const dateCells = tableBody.querySelectorAll('.date-cell');
            dateCells.forEach(cell => {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newCell = cell.cloneNode(true);
                cell.parentNode.replaceChild(newCell, cell);
                
                newCell.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    const fullDate = this.getAttribute('data-full-date');
                    
                    if (!fullDate || fullDate === 'undefined' || fullDate === '') {
                        // å¦‚æœæ²¡æœ‰æ—¥æœŸï¼Œè®¾ç½®ä¸ºä»Šå¤©
                        const today = new Date().toISOString().split('T')[0];
                        this.setAttribute('data-full-date', today);
                        this.textContent = formatDateToMonthDay(today);
                        
                        // æ›´æ–°æ•°æ®
                        const rowIndex = parseInt(index);
                        if (rowIndex >= 0 && rowIndex < orders.length) {
                            orders[rowIndex].date = today;
                        }
                        return;
                    }
                    
                    if (isDateFullFormat[index]) {
                        // åˆ‡æ¢åˆ°ç®€ç•¥æ ¼å¼
                        this.textContent = formatDateToMonthDay(fullDate);
                        isDateFullFormat[index] = false;
                    } else {
                        // åˆ‡æ¢åˆ°å®Œæ•´æ ¼å¼
                        const date = new Date(fullDate);
                        if (!isNaN(date.getTime())) {
                            this.textContent = date.toLocaleDateString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            });
                        } else {
                            this.textContent = fullDate;
                        }
                        isDateFullFormat[index] = true;
                    }
                });
            });
            
            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            const deleteButtons = tableBody.querySelectorAll('.delete-btn');
            deleteButtons.forEach(button => {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                newButton.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteRow(index);
                });
            });
        }
        
        // è®¡ç®—å™¨åŠŸèƒ½
        function initCalculator() {
            // æ˜¾ç¤ºè®¡ç®—å™¨
            calculatorBtn.addEventListener('click', function() {
                calculator.style.display = 'block';
            });
            
            // å…³é—­è®¡ç®—å™¨
            calculatorClose.addEventListener('click', function() {
                calculator.style.display = 'none';
            });
            
            // è®¡ç®—å™¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            calculatorButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    const number = this.getAttribute('data-number');
                    
                    if (number !== null) {
                        inputNumber(number);
                    } else if (action !== null) {
                        handleAction(action);
                    }
                    
                    // æ›´æ–°æ˜¾ç¤º
                    updateCalculatorDisplay();
                });
            });
            
            // è¾“å…¥æ•°å­—
            function inputNumber(number) {
                if (waitingForSecondOperand) {
                    calculatorDisplayValue = number;
                    waitingForSecondOperand = false;
                } else {
                    calculatorDisplayValue = calculatorDisplayValue === '0' ? number : calculatorDisplayValue + number;
                }
                
                // æ›´æ–°å†å²æ˜¾ç¤º
                if (operator !== null && firstOperand !== null && !waitingForSecondOperand) {
                    calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)} ${calculatorDisplayValue}`;
                } else if (operator !== null && firstOperand !== null && waitingForSecondOperand) {
                    calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)}`;
                } else {
                    calculatorHistoryValue = '';
                }
            }
            
            // å¤„ç†æ“ä½œç¬¦
            function handleAction(action) {
                switch (action) {
                    case 'clear':
                        // å®Œå…¨æ¸…é™¤
                        calculatorDisplayValue = '0';
                        calculatorHistoryValue = '';
                        firstOperand = null;
                        operator = null;
                        waitingForSecondOperand = false;
                        shouldResetDisplay = false;
                        break;
                    case 'clear-entry':
                        // æ¸…é™¤å½“å‰è¾“å…¥
                        calculatorDisplayValue = '0';
                        if (operator !== null && firstOperand !== null) {
                            calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)}`;
                        } else {
                            calculatorHistoryValue = '';
                        }
                        break;
                    case 'decimal':
                        if (!calculatorDisplayValue.includes('.')) {
                            calculatorDisplayValue += '.';
                        }
                        break;
                    case 'percent':
                        const currentValue = parseFloat(calculatorDisplayValue);
                        calculatorDisplayValue = (currentValue / 100).toString();
                        calculatorHistoryValue = `${currentValue}% =`;
                        break;
                    case 'add':
                    case 'subtract':
                    case 'multiply':
                    case 'divide':
                        handleOperator(action);
                        break;
                    case 'equals':
                        if (operator && firstOperand !== null) {
                            const secondOperand = parseFloat(calculatorDisplayValue);
                            const result = calculate(firstOperand, secondOperand, operator);
                            
                            // ç¡®ä¿ç»“æœæ˜¯ç²¾ç¡®çš„ï¼Œé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
                            const preciseResult = Math.round(result * 1000000) / 1000000;
                            
                            // æ˜¾ç¤ºå®Œæ•´è®¡ç®—è¿‡ç¨‹
                            calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)} ${secondOperand} =`;
                            calculatorDisplayValue = preciseResult.toString();
                            
                            // é‡ç½®çŠ¶æ€ï¼Œä½†ä¿ç•™ç»“æœä½œä¸ºä¸‹ä¸€æ¬¡è®¡ç®—çš„ç¬¬ä¸€ä¸ªæ“ä½œæ•°
                            firstOperand = preciseResult;
                            waitingForSecondOperand = true;
                            shouldResetDisplay = true;
                        }
                        break;
                }
            }
            
            // å¤„ç†è¿ç®—ç¬¦
            function handleOperator(nextOperator) {
                const inputValue = parseFloat(calculatorDisplayValue);
                
                if (operator !== null && !waitingForSecondOperand) {
                    // å¦‚æœå·²ç»æœ‰æ“ä½œç¬¦å’Œç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼Œå¹¶ä¸”å·²ç»è¾“å…¥äº†ç¬¬äºŒä¸ªæ“ä½œæ•°ï¼Œå…ˆè®¡ç®—
                    const result = calculate(firstOperand, inputValue, operator);
                    const preciseResult = Math.round(result * 1000000) / 1000000;
                    calculatorDisplayValue = preciseResult.toString();
                    firstOperand = preciseResult;
                } else {
                    // å¦åˆ™è®¾ç½®ç¬¬ä¸€ä¸ªæ“ä½œæ•°
                    firstOperand = inputValue;
                }
                
                operator = nextOperator;
                waitingForSecondOperand = true;
                shouldResetDisplay = true;
                
                // æ›´æ–°å†å²æ˜¾ç¤º
                calculatorHistoryValue = `${firstOperand} ${getOperatorSymbol(operator)}`;
            }
            
            // æ‰§è¡Œè®¡ç®—
            function calculate(first, second, operator) {
                switch (operator) {
                    case 'add': return first + second;
                    case 'subtract': return first - second;
                    case 'multiply': return first * second;
                    case 'divide': return first / second;
                    default: return second;
                }
            }
            
            // è·å–æ“ä½œç¬¦ç¬¦å·
            function getOperatorSymbol(op) {
                switch (op) {
                    case 'add': return '+';
                    case 'subtract': return '-';
                    case 'multiply': return 'Ã—';
                    case 'divide': return 'Ã·';
                    default: return '';
                }
            }
            
            // æ ¼å¼åŒ–æ˜¾ç¤ºæ•°å­—
            function formatDisplayNumber(numStr) {
                const num = parseFloat(numStr);
                if (isNaN(num)) return '0';
                
                // å¦‚æœæ˜¯æ•´æ•°ï¼Œä¸æ˜¾ç¤ºå°æ•°ç‚¹
                if (Number.isInteger(num)) {
                    return num.toString();
                }
                
                // å¦åˆ™æ˜¾ç¤ºæœ€å¤š6ä½å°æ•°
                return num.toFixed(6).replace(/\.?0+$/, '');
            }
            
            // æ›´æ–°è®¡ç®—å™¨æ˜¾ç¤º
            function updateCalculatorDisplay() {
                calculatorCurrent.textContent = formatDisplayNumber(calculatorDisplayValue);
                calculatorHistory.textContent = calculatorHistoryValue;
            }
        }
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            addBtn.addEventListener('click', addNewRow);
            exportBtn.addEventListener('click', exportToExcel);
            importBtn.addEventListener('click', () => fileInput.click());
            saveBtn.addEventListener('click', saveData);
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    importFromExcel(this.files[0]);
                    this.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥
                }
            });
            
            // ç»‘å®šæ’åºäº‹ä»¶
            dateHeader.addEventListener('click', toggleDateSort);
            sellAmountHeader.addEventListener('click', toggleSellAmountSort);
            
            // ç»‘å®šç­›é€‰äº‹ä»¶
            customerFilter.addEventListener('change', applyFilter);
            productFilter.addEventListener('change', applyFilter);
            clearFilterBtn.addEventListener('click', clearFilter);
            
            // åˆå§‹åŒ–è®¡ç®—å™¨
            initCalculator();
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
            updateFilterOptions();
            
            renderTable();
            initEventListeners();
            updateSortIndicators();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„æ•°æ®
            if (orders.length > 0) {
                showToast(`å·²åŠ è½½ ${orders.length} æ¡è®¢å•è®°å½•ï¼Œé»˜è®¤æŒ‰æ—¥æœŸé™åºæ’åˆ—`);
            } else {
                showToast('æ¬¢è¿ä½¿ç”¨è®¢å•åˆ©æ¶¦ç®¡ç†ç³»ç»Ÿï¼Œç‚¹å‡»"æ–°å¢"æŒ‰é’®å¼€å§‹æ·»åŠ è®¢å•');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);
        
        // ç›‘å¬é¡µé¢ç¦»å¼€å‰ä¿å­˜æ•°æ®
        
        /* ========= å¤‡æ³¨æ‰«ç åŠŸèƒ½ ========= */
        let currentScanTargetInput = null;
        let html5QrCode = null;

        const scannerModal = document.createElement('div');
        scannerModal.style.cssText = `
        position:fixed;inset:0;background:rgba(0,0,0,.6);
        display:none;align-items:center;justify-content:center;z-index:9999;
        `;
        scannerModal.innerHTML = `
        <div style="background:#fff;width:90%;max-width:420px;border-radius:10px;padding:10px;">
            <div style="text-align:right;color:#e74c3c;font-size:14px;cursor:pointer;" id="closeScannerBtn">å…³é—­ âœ–</div>
            <div id="reader" style="width:100%;"></div>
        </div>
        `;
        document.body.appendChild(scannerModal);

        function openScanner(inputEl){
            currentScanTargetInput = inputEl;
            scannerModal.style.display = 'flex';

            html5QrCode = new Html5Qrcode("reader");
            // ä»…ç”¨äºï¼šæ‰«ææ¡å½¢ç /äºŒç»´ç ï¼Œç„¶åå†™å…¥ã€Œå¤‡æ³¨ã€è¾“å…¥æ¡†ï¼ˆæœ¬åœ°æ•°æ®ä¼˜å…ˆï¼Œä¸è§¦ç¢°å…¶å®ƒå­—æ®µï¼‰
            let _formatsToSupport = undefined;
            try {
                if (typeof Html5QrcodeSupportedFormats !== "undefined") {
                    _formatsToSupport = [
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.CODE_39,
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E,
                        Html5QrcodeSupportedFormats.ITF,
                        Html5QrcodeSupportedFormats.QR_CODE,
                    ].filter(Boolean);
                }
            } catch(e) {}
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 280, aspectRatio: 1.7778, disableFlip: false, formatsToSupport: _formatsToSupport },
                decodedText => {
                    currentScanTargetInput.value = decodedText;
                    currentScanTargetInput.dispatchEvent(new Event('change'));
                    closeScanner();
                }
            ).catch(err=>{
                showToast("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™");
                closeScanner();
            });
        }

        function closeScanner(){
            scannerModal.style.display = 'none';
            if(html5QrCode){
                html5QrCode.stop().then(()=>html5QrCode.clear());
                html5QrCode = null;
            }
        }

        document.addEventListener('click', function(e){
            if(e.target && e.target.classList.contains('scan-btn')){
                const input = e.target.closest('td').querySelector('.note-input');
                if(input) openScanner(input);
            }
            if(e.target && e.target.id === 'closeScannerBtn'){
                closeScanner();
            }
        });

        window.addEventListener('beforeunload', function() {
            updateOrdersFromTable();
            localStorage.setItem('orderProfitData', JSON.stringify(orders));
        });
    </script>

<style>
.cloud-addon-panel{position:fixed;right:20px;bottom:20px;z-index:2147483647;font-family:sans-serif}
.cloud-addon-toggle{width:56px;height:56px;border-radius:16px;background:#111827;color:#fff;
display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer}
.cloud-addon-card{position:fixed;right:20px;bottom:90px;width:260px;background:#fff;
border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.25);padding:10px;display:none}
.cloud-addon-card button{width:100%;margin:6px 0;padding:10px;border-radius:12px;
border:1px solid #e5e7eb;background:#f9fafb;font-weight:700;cursor:pointer}
</style>

<div class="cloud-addon-panel">
  <div class="cloud-addon-card" id="addon-card">
    <button onclick="alert('ã€STEP 2ã€‘ç™»å½•å ä½ï¼šä»…éªŒè¯äº¤äº’ï¼Œä¸åšä»»ä½•äº‘ç«¯æ“ä½œ')">ğŸ” ç™»å½•</button>
    <button onclick="alert('ã€STEP 2ã€‘é€€å‡ºå ä½ï¼šä»…éªŒè¯äº¤äº’')">ğŸšª é€€å‡º</button>
    <button onclick="alert('ã€STEP 3ã€‘æ­¤åŠŸèƒ½å°šæœªæ¥å…¥ï¼ˆå¿…é¡»æ‰‹åŠ¨ï¼‰')">â¬†ï¸ ä¿å­˜åˆ°äº‘ç«¯</button>
    <button onclick="alert('ã€STEP 3ã€‘æ­¤åŠŸèƒ½å°šæœªæ¥å…¥ï¼ˆå¿…é¡»æ‰‹åŠ¨ï¼‰')">â¬‡ï¸ ä»äº‘ç«¯æ‹‰å–</button>
    <button onclick="alert('ã€STEP 4ã€‘ç®¡ç†å‘˜åŠŸèƒ½å°šæœªæ¥å…¥')">ğŸ‘¤ ç®¡ç†å‘˜</button>
  </div>
  <div class="cloud-addon-toggle" id="addon-toggle">â˜ï¸</div>
</div>

<script>
(function(){
 const t=document.getElementById('addon-toggle');
 const c=document.getElementById('addon-card');
 t.onclick=function(){ c.style.display = (c.style.display==='block')?'none':'block'; };
})();
</script>


<script>
/* ======== æƒé™é—¨ç¦ï¼šç™»å½•åæ‰èƒ½ å¢åŠ  / å¯¼å…¥ / å¯¼å‡ºï¼ˆStep 2ï¼‰ ======== */
(function(){
  // å•ä¸€çœŸç›¸æºï¼šç™»å½•æ€ï¼ˆStep2 ä»…UIæƒé™ï¼Œä¸è§¦ç¢°æ•°æ®/äº‘ç«¯ï¼‰
  window.__isLoggedIn = false;

  function toast(msg){
    try{ if(typeof showToast==='function') showToast(msg); else alert(msg); }
    catch(e){ alert(msg); }
  }

  // æ ¹æ®æŒ‰é’®æ–‡å­—åŒ¹é…â€œå†™æ“ä½œâ€
  const WRITE_KEYWORDS = ['å¢åŠ ','æ–°å¢','å¯¼å…¥','å¯¼å‡º'];

  function isWriteButton(btn){
    const t = (btn.innerText || btn.textContent || '').trim();
    return WRITE_KEYWORDS.some(k => t.includes(k));
  }

  function applyGate(){
    const buttons = Array.from(document.querySelectorAll('button'));
    buttons.forEach(btn=>{
      if(!isWriteButton(btn)) return;

      // è§†è§‰æ€
      btn.disabled = !window.__isLoggedIn;
      btn.style.opacity = window.__isLoggedIn ? '1' : '0.55';
      btn.style.cursor  = window.__isLoggedIn ? 'pointer' : 'not-allowed';

      // ç‚¹å‡»é—¨ç¦ï¼ˆå…œåº•ï¼‰
      btn.addEventListener('click', function(e){
        if(!window.__isLoggedIn){
          e.preventDefault(); e.stopPropagation();
          toast('è¯·å…ˆç™»å½•åå†ä½¿ç”¨è¯¥åŠŸèƒ½');
          return false;
        }
      }, true); // æ•è·é˜¶æ®µï¼Œé˜²æ­¢è¢«å…¶å®ƒç›‘å¬åæ‰
    });
  }

  // ä¾›å¤–æŒ‚ç™»å½•æŒ‰é’®è°ƒç”¨ï¼ˆä¸è‡ªåŠ¨è§¦å‘ä»»ä½•ä¸šåŠ¡ï¼‰
  window.__setLoginState = function(v){
    window.__isLoggedIn = !!v;
    applyGate();
  };

  // åˆå§‹ï¼šæœªç™»å½•
  applyGate();
})();
</script>


<script>
/* ======== è®¡ç®—å™¨æ‹–åŠ¨æ¡ï¼ˆç¨³å®šåˆå¹¶ç‰ˆï¼šä¸å½±å“æƒé™/äº‘ç«¯ï¼‰ ======== */
(function(){
  const selectors = ['#calculator','#calculator-panel','.calculator','.calc-panel','[data-role="calculator"]'];

  function attach(){
    let panel=null;
    for(const sel of selectors){
      const el=document.querySelector(sel);
      if(el){ panel=el; break; }
    }
    if(!panel) return false;

    panel.style.position='fixed';
    panel.style.zIndex=panel.style.zIndex||'10020';

    if(panel.querySelector('.calc-drag-handle')) return true;

    const handle=document.createElement('div');
    handle.className='calc-drag-handle';
    handle.textContent='â‡• æ‹–åŠ¨è®¡ç®—å™¨';
    handle.style.cssText=[
      'height:36px',
      'line-height:36px',
      'background:#2563eb',
      'color:#fff',
      'font-weight:700',
      'text-align:center',
      'cursor:move',
      'user-select:none'
    ].join(';');

    panel.prepend(handle);

    let sx=0,sy=0,ox=0,oy=0,drag=false;

    function start(e){
      drag=true;
      const p=(e.touches&&e.touches[0])||e;
      sx=p.clientX; sy=p.clientY;
      const r=panel.getBoundingClientRect();
      ox=r.left; oy=r.top;
      document.addEventListener('mousemove',move);
      document.addEventListener('mouseup',end);
      document.addEventListener('touchmove',move,{passive:false});
      document.addEventListener('touchend',end);
      e.preventDefault();
    }
    function move(e){
      if(!drag) return;
      const p=(e.touches&&e.touches[0])||e;
      panel.style.left=(ox+p.clientX-sx)+'px';
      panel.style.top =(oy+p.clientY-sy)+'px';
      panel.style.right='auto'; panel.style.bottom='auto';
      e.preventDefault();
    }
    function end(){
      drag=false;
      document.removeEventListener('mousemove',move);
      document.removeEventListener('mouseup',end);
      document.removeEventListener('touchmove',move);
      document.removeEventListener('touchend',end);
    }

    handle.addEventListener('mousedown',start);
    handle.addEventListener('touchstart',start,{passive:false});
    return true;
  }

  let tries=0;
  const timer=setInterval(()=>{
    tries++;
    if(attach()||tries>20) clearInterval(timer);
  },500);
})();
</script>


<script>
/* ======== å®˜æ–¹åœ°åŸº APIï¼šäº‘ç«¯å¿«ç…§ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼Œæ•´åŒ…è¦†ç›–ï¼‰ ======== */
(function(){
  function getClient(){ return window.__supa || null; }

  window.saveSnapshotToCloud = async function saveSnapshotToCloud(){
    if(!window.__isLoggedIn){ alert('è¯·å…ˆç™»å½•'); return; }
    if(!confirm('æ˜¯å¦ç¡®è®¤ç”¨ã€å½“å‰æœ¬åœ°æ•°æ®ã€‘è¦†ç›–äº‘ç«¯ï¼Ÿ')) return;

    const client = getClient();
    if(!client){ alert('Supabase æœªåˆå§‹åŒ–'); return; }

    const { data:u, error:ue } = await client.auth.getUser();
    if(ue || !u?.user){ alert('æ— æ³•è·å–ç”¨æˆ·'); return; }

    const { error } = await client
      .from('app_state_user')
      .update({ data: window.orders })
      .eq('id', u.user.id);

    if(error){ alert('ä¿å­˜å¤±è´¥ï¼š' + error.message); return; }
    alert('å·²ä¿å­˜åˆ°äº‘ç«¯');
  };

  window.loadSnapshotFromCloud = async function loadSnapshotFromCloud(){
    if(!window.__isLoggedIn){ alert('è¯·å…ˆç™»å½•'); return; }

    const client = getClient();
    if(!client){ alert('Supabase æœªåˆå§‹åŒ–'); return; }

    const { data:u, error:ue } = await client.auth.getUser();
    if(ue || !u?.user){ alert('æ— æ³•è·å–ç”¨æˆ·'); return; }

    const { data, error } = await client
      .from('app_state_user')
      .select('data')
      .eq('id', u.user.id)
      .single();

    if(error){ alert('æ‹‰å–å¤±è´¥ï¼š' + error.message); return; }
    if(!data){ alert('äº‘ç«¯æš‚æ— æ•°æ®'); return; }

    if(!confirm('äº‘ç«¯æ•°æ®å°†ã€è¦†ç›–å½“å‰æœ¬åœ°æ•°æ®ã€‘ï¼Œæ˜¯å¦ç¡®è®¤ï¼Ÿ')) return;

    window.orders = data.data;
    if(typeof render === 'function') render();
    alert('å·²ä»äº‘ç«¯æ‹‰å–');
  };
})();
</script>

<script>
/* ======== UI æ”¶å£ï¼šä¸»ç•Œé¢æ”¾å›æ—§ç‰ˆäº‘ç«¯æŒ‰é’®ï¼›â˜ï¸é¢æ¿ç§»é™¤ä¿å­˜/æ‹‰å– ======== */
document.addEventListener('DOMContentLoaded', function(){
  // â˜ï¸é¢æ¿ç§»é™¤â€œä¿å­˜åˆ°äº‘ç«¯/ä»äº‘ç«¯æ‹‰å–â€
  try{
    document.querySelectorAll('button,div').forEach(function(el){
      const t=(el.innerText||'').trim();
      if(t==='ä¿å­˜åˆ°äº‘ç«¯' || t==='ä»äº‘ç«¯æ‹‰å–'){ el.remove(); }
    });
  }catch(e){}

  function makeBtn(text,bg){
    const b=document.createElement('button');
    b.type='button';
    b.innerHTML=text;
    b.style.cssText='border:none;border-radius:999px;padding:10px 18px;font-weight:800;color:#fff;background:'+bg+';display:inline-flex;align-items:center;gap:8px;box-shadow:0 6px 18px rgba(0,0,0,.18);cursor:pointer;white-space:nowrap';
    return b;
  }

  const btnSave = makeBtn('', '#22c55e');
  const btnLoad = makeBtn('', '#3b82f6');
  btnSave.addEventListener('click', function(){ window.saveSnapshotToCloud && window.saveSnapshotToCloud(); });
  btnLoad.addEventListener('click', function(){ window.loadSnapshotFromCloud && window.loadSnapshotFromCloud(); });

  // å®šä½â€œæ€»åˆ©æ¶¦â€å¡ç‰‡
  let card=null;
  const divs=document.querySelectorAll('div');
  for(let i=0;i<divs.length;i++){
    const t=(divs[i].innerText||'');
    if(t.includes('æ€»åˆ©æ¶¦') && t.includes('ï¿¥')){ card=divs[i]; break; }
  }

  function placeIntoCard(c){
    let row=c.querySelector('.top-cloud-actions');
    if(!row){
      row=document.createElement('div');
      row.className='top-cloud-actions';
      row.style.cssText='position:absolute;right:20px;top:24px;display:flex;gap:14px;z-index:20';
      if(getComputedStyle(c).position==='static') c.style.position='relative';
      c.appendChild(row);
    }
    if(!row.contains(btnSave)) row.appendChild(btnSave);
    if(!row.contains(btnLoad)) row.appendChild(btnLoad);
  }

  if(card){ placeIntoCard(card); }
  else{
    const box=document.createElement('div');
    box.style.cssText='position:fixed;right:16px;top:120px;z-index:99999;display:flex;gap:10px';
    box.appendChild(btnSave);
    box.appendChild(btnLoad);
    document.body.appendChild(box);
  }
});
</script>


<script>
/* ======== å®˜æ–¹åœ°åŸº APIï¼šäº‘ç«¯å¿«ç…§ï¼ˆä¿®æ­£ç‰ˆï¼šå¯¹é½ orders / localStorage / upsertï¼‰ ======== */
(function(){
  function getClient(){ return window.__supa || null; }
  const LS_KEY = 'orderProfitData';

  function getOrders(){
    try{ return (typeof orders !== 'undefined') ? orders : (JSON.parse(localStorage.getItem(LS_KEY))||[]); }
    catch(e){ return []; }
  }
  function setOrders(next){
    try{
      if(typeof orders !== 'undefined'){ orders = Array.isArray(next) ? next : []; }
      localStorage.setItem(LS_KEY, JSON.stringify(Array.isArray(next)?next:[]));
    }catch(e){}
    if(typeof render === 'function') render();
  }

  window.saveSnapshotToCloud = async function saveSnapshotToCloud(){
    if(!window.__isLoggedIn){ alert('è¯·å…ˆç™»å½•'); return; }
    if(!confirm('æ˜¯å¦ç¡®è®¤ç”¨ã€å½“å‰æœ¬åœ°æ•°æ®ã€‘è¦†ç›–äº‘ç«¯ï¼Ÿ')) return;

    const client = getClient();
    if(!client){ alert('Supabase æœªåˆå§‹åŒ–'); return; }

    const { data:u, error:ue } = await client.auth.getUser();
    if(ue || !u?.user){ alert('æ— æ³•è·å–ç”¨æˆ·'); return; }

    const payload = { id: u.user.id, data: getOrders() };

    // ç”¨ upsertï¼šä¸å­˜åœ¨å°±åˆ›å»ºï¼Œå­˜åœ¨å°±è¦†ç›–ï¼ˆé¿å… update 0 è¡Œâ€œæˆåŠŸä½†æ²¡å˜åŒ–â€ï¼‰
    const { error } = await client
      .from('app_state_user')
      .upsert(payload, { onConflict: 'id' });

    if(error){ alert('ä¿å­˜å¤±è´¥ï¼š' + error.message); return; }
    alert('å·²ä¿å­˜åˆ°äº‘ç«¯');
  };

  window.loadSnapshotFromCloud = async function loadSnapshotFromCloud(){
    if(!window.__isLoggedIn){ alert('è¯·å…ˆç™»å½•'); return; }

    const client = getClient();
    if(!client){ alert('Supabase æœªåˆå§‹åŒ–'); return; }

    const { data:u, error:ue } = await client.auth.getUser();
    if(ue || !u?.user){ alert('æ— æ³•è·å–ç”¨æˆ·'); return; }

    const { data, error } = await client
      .from('app_state_user')
      .select('data')
      .eq('id', u.user.id)
      .maybeSingle();

    if(error){ alert('æ‹‰å–å¤±è´¥ï¼š' + error.message); return; }
    if(!data || data.data == null){ alert('äº‘ç«¯æš‚æ— æ•°æ®'); return; }

    if(!confirm('äº‘ç«¯æ•°æ®å°†ã€è¦†ç›–å½“å‰æœ¬åœ°æ•°æ®ã€‘ï¼Œæ˜¯å¦ç¡®è®¤ï¼Ÿ')) return;

    setOrders(data.data);
    alert('å·²ä»äº‘ç«¯æ‹‰å–');
  };
})();
</script>


<script>
/* ===== ç™»å½•æ€æŒä¹…åŒ–æ¢å¤ï¼ˆä»…æ¢å¤ç™»å½•çŠ¶æ€ï¼Œä¸æ‹‰æ•°æ®ï¼‰ ===== */
document.addEventListener('DOMContentLoaded', function(){
  if(!window.__supa) return;
  window.__supa.auth.getSession().then(function(res){
    if(res && res.data && res.data.session){
      window.__isLoggedIn = true;
      console.log('[AUTH] session restored');
    }
  });
});
</script>


<script>
/* ===== â˜ï¸ é¢æ¿ï¼šäº‘ç«¯æŒ‰é’®å›å½’ï¼ˆä»…è°ƒç”¨åœ°åŸº APIï¼‰ ===== */
document.addEventListener('DOMContentLoaded', function(){
  // æ‰¾åˆ° â˜ï¸ é¢æ¿å®¹å™¨ï¼ˆå…œåº•ï¼‰
  let panel = document.querySelector('.cloud-panel') || document.querySelector('.addon-panel') || null;
  if(!panel) return;

  // é¿å…é‡å¤æ’å…¥
  if(panel.querySelector('.cloud-snapshot-actions')) return;

  const box = document.createElement('div');
  box.className = 'cloud-snapshot-actions';
  box.style.cssText = 'margin-top:12px;display:flex;flex-direction:column;gap:8px';

  const btnSave = document.createElement('button');
  btnSave.textContent = 'â˜ï¸ ä¿å­˜åˆ°äº‘ç«¯';
  btnSave.onclick = function(){
    if(window.saveSnapshotToCloud) window.saveSnapshotToCloud();
  };

  const btnLoad = document.createElement('button');
  btnLoad.textContent = 'â¬‡ï¸ ä»äº‘ç«¯æ‹‰å–';
  btnLoad.onclick = function(){
    if(window.loadSnapshotFromCloud) window.loadSnapshotFromCloud();
  };

  box.appendChild(btnSave);
  box.appendChild(btnLoad);
  panel.appendChild(box);
});
</script>


<script>
/* ===== ä¸»ç•Œé¢ï¼šç§»é™¤æ®‹ç•™çš„äº‘ç«¯â€œâ˜ï¸ä¿å­˜/æ‹‰å–â€æŒ‰é’®ï¼ˆåªä¿ç•™â˜ï¸é¢æ¿å…¥å£ï¼‰ ===== */
document.addEventListener('DOMContentLoaded', function(){
  // åˆ é™¤æ€»åˆ©æ¶¦å¡ç‰‡å³ä¾§æ’å…¥çš„å®¹å™¨
  document.querySelectorAll('.top-cloud-actions,.cloud-actions-row').forEach(function(el){ el.remove(); });

  // åˆ é™¤å¯èƒ½å­˜åœ¨çš„å³ä¸Š/å³ä¾§å…œåº•æµ®å±‚
  ['cloud-force-fab','cloud-csp-fab','cloud-direct-actions','cloud-csp-actions','cloud-fab'].forEach(function(id){
    var el=document.getElementById(id);
    if(el) el.remove();
  });

  // æ–‡æœ¬å…œåº•ï¼šæŠŠä¸»ç•Œé¢çš„â€œâ˜ï¸ ä¿å­˜/â¬‡ï¸ æ‹‰å–â€æŒ‰é’®ç§»é™¤ï¼ˆâ˜ï¸é¢æ¿é‡Œçš„ä¿ç•™ï¼‰
  document.querySelectorAll('button').forEach(function(btn){
    var t=(btn.innerText||'').trim();
    if(t==='â˜ï¸ ä¿å­˜' || t==='â¬‡ï¸ æ‹‰å–'){
      if(!btn.closest('.cloud-snapshot-actions')) btn.remove();
    }
  });
});
</script>

<script>
/* ======== v7 UI æ¸…ç†ï¼ˆä»…æ¸… UIï¼Œä¸æ”¹åœ°åŸº API / Supabase / ordersï¼‰ ======== */
document.addEventListener('DOMContentLoaded', function () {
  /* 1) ç™»å½•æ€æ¢å¤ï¼šå¿…é¡»èµ° __setLoginState(true)ï¼Œä¸ç›´æ¥æ”¹ __isLoggedIn */
  try{
    if (window.__supa && typeof window.__setLoginState === 'function') {
      window.__supa.auth.getSession().then(function(res){
        if(res && res.data && res.data.session){
          window.__setLoginState(true);
          console.log('[AUTH][v7] session restored via __setLoginState(true)');
        }
      });
    }
  }catch(e){}

  /* 2) ä¸»ç•Œé¢ï¼šå½»åº•ç§»é™¤ä»»ä½•äº‘ç«¯ä¿å­˜/æ‹‰å–å…¥å£ï¼ˆæŒ‰é’®/æ®‹å½±/ç»å¯¹å®šä½ç©ºèƒ¶å›Š/å³ä¸Šè§’ç©ºç™½åœ†è§’ï¼‰ */
  function isInCloudPanel(el){
    return !!(el && el.closest && el.closest('.cloud-addon-panel, #addon-card, .cloud-snapshot-actions, .cloud-panel, .addon-panel, [data-cloud-panel]'));
  }

  // 2.1 åˆ é™¤å†å²é—ç•™å®¹å™¨
  try{
    document.querySelectorAll('.top-cloud-actions,.cloud-actions-row,.cloud-snapshot-actions').forEach(function(el){
      // cloud-snapshot-actions åªå…è®¸å‡ºç°åœ¨äº‘é¢æ¿é‡Œ
      if(!isInCloudPanel(el)) el.remove();
    });
  }catch(e){}

  // 2.2 åˆ é™¤å¸¸è§å…œåº•æµ®å±‚ ID
  try{
    ['cloud-force-fab','cloud-csp-fab','cloud-direct-actions','cloud-csp-actions','cloud-fab'].forEach(function(id){
      var el=document.getElementById(id);
      if(el && !isInCloudPanel(el)) el.remove();
    });
  }catch(e){}

  // 2.3 åˆ é™¤â€œæ€»åˆ©æ¶¦å¡ç‰‡å³ä¾§ç»¿/è“èƒ¶å›Šæ®‹å½±â€å’Œå…¶å®ƒç©ºæŒ‰é’®
  function looksLikeGhostPill(btn){
    try{
      if(!btn || btn.tagName !== 'BUTTON') return false;
      if(isInCloudPanel(btn)) return false;
      var t = (btn.innerText || btn.textContent || '').trim();
      // v5 é‡Œé‚£ä¸¤ä¸ªèƒ¶å›Šæ˜¯ç©ºæ–‡æœ¬æŒ‰é’®
      var emptyText = (t === '');
      var cs = window.getComputedStyle(btn);
      var br = parseFloat(cs.borderRadius || '0');
      var bg = (cs.backgroundColor || '') + ' ' + (cs.backgroundImage || '');
      var pillish = br >= 20; // 999px ä¼šéå¸¸å¤§
      // ç»¿è‰²/è“è‰²ï¼ˆä¸ç²¾ç¡®åŒ¹é…ï¼Œé¿å…ä¸»é¢˜å·®å¼‚ï¼‰
      var maybeGreenBlue = /rgb\(\s*(34|59)\s*,\s*(197|130)\s*,\s*(94|246)\s*\)/.test(cs.backgroundColor || '') || /22c55e|3b82f6/i.test(bg);
      return emptyText && pillish && maybeGreenBlue;
    }catch(e){
      return false;
    }
  }

  try{
    document.querySelectorAll('button').forEach(function(btn){
      if(looksLikeGhostPill(btn)) btn.remove();
    });
  }catch(e){}

  // 2.4 åˆ é™¤å³ä¸Šè§’ç©ºç™½åœ†è§’æŒ‰é’®ï¼ˆç»å¯¹/å›ºå®šå®šä½ï¼Œæ¥è¿‘å³ä¸Šè§’ï¼Œä¸”æ— æ–‡æœ¬/æ—  aria-labelï¼‰
  try{
    var vw = window.innerWidth || document.documentElement.clientWidth;
    document.querySelectorAll('button,[role="button"],a').forEach(function(el){
      if(isInCloudPanel(el)) return;
      var txt = (el.innerText || el.textContent || '').replace(/\s+/g,'').trim();
      var aria = (el.getAttribute && (el.getAttribute('aria-label')||'').trim()) || '';
      if(txt || aria) return;

      var cs = window.getComputedStyle(el);
      if(!cs) return;
      if(cs.position !== 'fixed' && cs.position !== 'absolute') return;

      var r = el.getBoundingClientRect();
      var nearTopRight = (vw - r.right) <= 28 && r.top <= 28;
      var sizeLikeBtn = r.width >= 18 && r.width <= 90 && r.height >= 18 && r.height <= 90;

      if(nearTopRight && sizeLikeBtn){
        el.remove();
      }
    });
  }catch(e){}

  /* 3) â˜ï¸ é¢æ¿ï¼šä¿å­˜/æ‹‰å–ä¿æŒå¯ç”¨ï¼ˆä»è°ƒç”¨åœ°åŸº APIï¼‰ï¼Œé¢æ¿åªåšå…¥å£ä¸ç›´è¿ orders/Supabase */
  try{
    var card = document.getElementById('addon-card');
    if(card){
      // ç§»é™¤å ä½/æ—§ç‰ˆæŒ‰é’®ï¼ˆåªæ¸…é¢æ¿å†…éƒ¨â€œä¿å­˜/æ‹‰å–â€é‚£ä¸¤é¢—ï¼‰
      Array.from(card.querySelectorAll('button')).forEach(function(b){
        var t=(b.innerText||'').trim();
        if(t.includes('ä¿å­˜åˆ°äº‘ç«¯') || t.includes('ä»äº‘ç«¯æ‹‰å–') || t.includes('ä¿å­˜äº‘ç«¯') || t==='â˜ï¸ ä¿å­˜åˆ°äº‘ç«¯' || t==='â¬‡ï¸ ä»äº‘ç«¯æ‹‰å–'){
          b.remove();
        }
      });

      // é¿å…é‡å¤æ’å…¥
      if(!card.querySelector('[data-v7-cloud-actions="1"]')){
        var box=document.createElement('div');
        box.setAttribute('data-v7-cloud-actions','1');
        box.style.cssText='margin-top:8px;display:flex;flex-direction:column;gap:8px';

        function mk(text){
          var b=document.createElement('button');
          b.type='button';
          b.textContent=text;
          return b;
        }
        var btnSave = mk('â˜ï¸ ä¿å­˜åˆ°äº‘ç«¯');
        btnSave.onclick = function(){ if(window.saveSnapshotToCloud) window.saveSnapshotToCloud(); };

        var btnLoad = mk('â¬‡ï¸ ä»äº‘ç«¯æ‹‰å–');
        btnLoad.onclick = function(){ if(window.loadSnapshotFromCloud) window.loadSnapshotFromCloud(); };

        box.appendChild(btnSave);
        box.appendChild(btnLoad);
        card.appendChild(box);
      }
    }
  }catch(e){}

  /* 4) é˜²ä¸²çº¿ï¼šä¸»ç•Œé¢æœ¬åœ°â€œä¿å­˜â€æŒ‰é’®ä¸å…è®¸è§¦å‘äº‘ç«¯ä¿å­˜ï¼ˆæŸäº›å†å²è„šæœ¬ç”¨â€œåŒ…å«ä¿å­˜â€åšç»‘å®šï¼‰ */
  try{
    var localSaveBtn = document.getElementById('save-btn');
    if(localSaveBtn && !isInCloudPanel(localSaveBtn)){
      localSaveBtn.addEventListener('click', function(e){
        // æ•è·é˜¶æ®µæ‹¦æˆªæ‰€æœ‰åç»­ç›‘å¬å™¨ï¼ˆåŒ…æ‹¬è¯¯ç»‘çš„äº‘ç«¯ä¿å­˜ï¼‰
        e.preventDefault();
        e.stopImmediatePropagation();
        if(typeof saveData === 'function') saveData();
      }, true);
    }
  }catch(e){}

  /* 5) å…œåº•ï¼šé˜»æ­¢ä¸»ç•Œé¢ä»»ä½•â€œäº‘ç«¯ä¿å­˜/æ‹‰å–â€ç‚¹å‡»é“¾è·¯ï¼ˆåªå…è®¸äº‘é¢æ¿å†…è§¦å‘ï¼‰ */
  try{
    document.addEventListener('click', function(e){
      var el = e.target && e.target.closest ? e.target.closest('button,a,[role="button"]') : null;
      if(!el) return;
      if(isInCloudPanel(el)) return;

      var t=(el.innerText||el.textContent||'').trim();
      // åªæ‹¦â€œäº‘ç«¯/å¿«ç…§â€ç›¸å…³ï¼Œä¸æ‹¦æœ¬åœ°ä¿å­˜
      var cloudHit = /äº‘ç«¯|å¿«ç…§|snapshot|â˜ï¸|ä»äº‘ç«¯|åˆ°äº‘ç«¯|æ‹‰å–äº‘ç«¯/i.test(t);
      if(cloudHit){
        e.preventDefault();
        e.stopImmediatePropagation();
        return false;
      }
    }, true);
  }catch(e){}

  /* 6) è‹¥åç»­è„šæœ¬åˆæ’å…¥ä¸»ç•Œé¢äº‘æŒ‰é’®ï¼šç”¨ MutationObserver ç»§ç»­æ¸…æ‰ï¼ˆä»ç„¶åªåš UI æ¸…ç†ï¼‰ */
  try{
    var mo = new MutationObserver(function(){
      // é‡å¤æ‰§è¡Œæœ€å…³é”®çš„å‡ æ¡æ¸…ç†
      document.querySelectorAll('.top-cloud-actions,.cloud-actions-row').forEach(function(el){
        if(!isInCloudPanel(el)) el.remove();
      });
      document.querySelectorAll('button').forEach(function(btn){
        if(looksLikeGhostPill(btn)) btn.remove();
      });
    });
    mo.observe(document.body, { childList:true, subtree:true });
  }catch(e){}
});
</script>

<script>
/* ======== v8 ç™»å½•UIä¼˜åŒ– + â˜ï¸é¢æ¿æŒ‰é’®ç»‘å®šï¼ˆä»…æ‰‹åŠ¨è§¦å‘åœ°åŸºAPIï¼Œä¸ç›´è¿orders/Supabaseå†™å…¥ï¼‰ ======== */
document.addEventListener('DOMContentLoaded', () => {
  // ---------- 1) ç™»å½•å¼¹çª— UI ----------
  const style = document.createElement('style');
  style.textContent = `
    .login-modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:20050;padding:16px}
    .login-modal{width:min(420px, 100%);background:#fff;border-radius:18px;box-shadow:0 18px 50px rgba(0,0,0,.28);overflow:hidden}
    .login-modal header{padding:18px 18px 10px 18px;display:flex;align-items:center;justify-content:space-between}
    .login-modal h3{margin:0;font-size:16px;letter-spacing:.2px}
    .login-close{border:none;background:#f3f4f6;border-radius:10px;width:34px;height:34px;cursor:pointer;font-size:16px}
    .login-modal .body{padding:12px 18px 18px 18px}
    .login-field{display:flex;flex-direction:column;gap:8px;margin:12px 0}
    .login-field label{font-size:12px;color:#6b7280}
    .login-input{display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px}
    .login-input input{border:none;outline:none;flex:1;font-size:14px}
    .login-eye{border:none;background:#f3f4f6;border-radius:10px;padding:6px 10px;cursor:pointer;font-weight:700}
    .login-actions{display:flex;gap:10px;margin-top:14px}
    .login-actions button{flex:1;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-ghost{background:#f3f4f6;color:#111827}
    .login-hint{margin-top:10px;font-size:12px;color:#6b7280;line-height:1.4}
    .login-err{margin-top:10px;font-size:12px;color:#b91c1c;display:none}
    .login-badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#ecfeff;color:#155e75;border:1px solid #cffafe}
  `;
  document.head.appendChild(style);

  const mask = document.createElement('div');
  mask.className = 'login-modal-mask';
  mask.innerHTML = `
    <div class="login-modal" role="dialog" aria-modal="true" aria-label="ç™»å½•">
      <header>
        <h3>ğŸ” ç™»å½• <span class="login-badge" id="login-status-badge">æœªç™»å½•</span></h3>
        <button class="login-close" id="login-close" aria-label="å…³é—­">âœ•</button>
      </header>
      <div class="body">
        <div class="login-field">
          <label>é‚®ç®±</label>
          <div class="login-input">
            <span aria-hidden="true">ğŸ“§</span>
            <input id="login-email" type="email" autocomplete="email" placeholder="name@example.com" />
          </div>
        </div>

        <div class="login-field">
          <label>å¯†ç </label>
          <div class="login-input">
            <span aria-hidden="true">ğŸ”‘</span>
            <input id="login-password" type="password" autocomplete="current-password" placeholder="è¯·è¾“å…¥å¯†ç " />
            <button class="login-eye" id="login-eye" type="button">æ˜¾ç¤º</button>
          </div>
        </div>

        <div class="login-actions">
          <button class="btn-ghost" id="login-cancel" type="button">å–æ¶ˆ</button>
          <button class="btn-primary" id="login-submit" type="button">ç™»å½•</button>
        </div>

        <div class="login-err" id="login-err"></div>
        <div class="login-hint">æç¤ºï¼šç™»å½•æ€å·²æŒä¹…åŒ–ï¼›åˆ·æ–°åä»…æ¢å¤æƒé™çŠ¶æ€ï¼Œä¸ä¼šè‡ªåŠ¨äº‘ç«¯ä¿å­˜/æ‹‰å–ã€‚</div>
      </div>
    </div>
  `;
  document.body.appendChild(mask);

  const $ = (id) => document.getElementById(id);
  const close = () => (mask.style.display = 'none');
  const open  = () => (mask.style.display = 'flex');

  mask.addEventListener('click', (e) => { if(e.target === mask) close(); });
  $('login-close').onclick = close;
  $('login-cancel').onclick = close;

  $('login-eye').onclick = () => {
    const inp = $('login-password');
    const isPwd = inp.type === 'password';
    inp.type = isPwd ? 'text' : 'password';
    $('login-eye').textContent = isPwd ? 'éšè—' : 'æ˜¾ç¤º';
  };

  function setErr(msg){
    const el=$('login-err');
    if(!msg){ el.style.display='none'; el.textContent=''; return; }
    el.style.display='block';
    el.textContent=msg;
  }

  // ---------- 2) Supabase Authï¼ˆåªç”¨äºç™»å½•æ€ï¼Œä¸åšäº‘ç«¯æ•°æ®è¯»å†™ï¼‰ ----------
  // è‹¥é¡µé¢é‡Œå·²æœ‰ __supaï¼Œå°±å¤ç”¨ï¼›å¦åˆ™å°è¯•åˆå§‹åŒ–ï¼ˆä¿ç•™ persistSessionï¼‰
  function getClient(){
    if(window.__supa) return window.__supa;
    if(!(window.supabase && window.supabase.createClient)) return null;

    try{
      const SUPABASE_URL = 'https://yqsjkdndasbdfmjwahwk.supabase.co';
      const SUPABASE_KEY = 'sb_publishable_8owDy_9hIN3uaBCzd6jncg_i8e68dL0';
      window.__supa = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_KEY,
        { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false } }
      );
      return window.__supa;
    }catch(e){
      return null;
    }
  }

  async function refreshLoginBadge(){
    const badge = $('login-status-badge');
    badge.textContent = window.__isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•';
    badge.style.background = window.__isLoggedIn ? '#ecfdf5' : '#ecfeff';
    badge.style.color = window.__isLoggedIn ? '#065f46' : '#155e75';
    badge.style.borderColor = window.__isLoggedIn ? '#bbf7d0' : '#cffafe';
  }

  // åˆ·æ–°æ¢å¤ï¼šå¿…é¡»èµ° __setLoginState(true)
  (async () => {
    const client = getClient();
    if(!client || typeof window.__setLoginState !== 'function') { refreshLoginBadge(); return; }
    try{
      const { data } = await client.auth.getSession();
      if(data && data.session){ window.__setLoginState(true); }
      else { window.__setLoginState(false); }
    }catch(e){
      // ä¸æ‰“æ–­é¡µé¢ä½¿ç”¨
    }finally{
      refreshLoginBadge();
    }

    // åŒæ­¥ç›‘å¬
    try{
      client.auth.onAuthStateChange((_event, session) => {
        if(typeof window.__setLoginState === 'function'){
          window.__setLoginState(!!session);
          refreshLoginBadge();
        }
      });
    }catch(e){}
  })();

  async function doLogin(){
    setErr('');
    const email = ($('login-email').value || '').trim();
    const password = $('login-password').value || '';
    if(!email) return setErr('è¯·è¾“å…¥é‚®ç®±');
    if(!password) return setErr('è¯·è¾“å…¥å¯†ç ');

    const client = getClient();
    if(!client) return setErr('ç™»å½•æ¨¡å—æœªå°±ç»ªï¼ˆsupabase æœªåŠ è½½ï¼‰');

    $('login-submit').disabled = true;
    $('login-submit').textContent = 'ç™»å½•ä¸­...';

    try{
      const { error } = await client.auth.signInWithPassword({ email, password });
      if(error) return setErr('ç™»å½•å¤±è´¥ï¼š' + error.message);

      if(typeof window.__setLoginState === 'function') window.__setLoginState(true);
      refreshLoginBadge();
      close();
      try{ if(typeof showToast==='function') showToast('ç™»å½•æˆåŠŸ'); }catch(e){}
    }catch(e){
      setErr('ç™»å½•å¤±è´¥ï¼š' + (e && e.message ? e.message : 'æœªçŸ¥é”™è¯¯'));
    }finally{
      $('login-submit').disabled = false;
      $('login-submit').textContent = 'ç™»å½•';
    }
  }

  $('login-submit').onclick = doLogin;
  mask.addEventListener('keydown', (e) => { if(e.key === 'Enter') doLogin(); if(e.key === 'Escape') close(); });

  async function doLogout(){
    const client = getClient();
    if(!client){ if(typeof window.__setLoginState==='function') window.__setLoginState(false); refreshLoginBadge(); return; }
    try{ await client.auth.signOut(); }catch(e){}
    if(typeof window.__setLoginState==='function') window.__setLoginState(false);
    refreshLoginBadge();
    try{ if(typeof showToast==='function') showToast('å·²é€€å‡º'); }catch(e){}
  }

  // ---------- 3) â˜ï¸é¢æ¿æŒ‰é’®ï¼šåªåš UI å…¥å£ï¼Œè°ƒç”¨åœ°åŸº API ----------
  const cloudCard = document.getElementById('addon-card') || document.querySelector('.cloud-addon-card');
  if(cloudCard){
    const btns = Array.from(cloudCard.querySelectorAll('button'));
    const byText = (kw) => btns.find(b => (b.innerText||'').includes(kw));

    const btnLogin  = byText('ç™»å½•');
    const btnLogout = byText('é€€å‡º');
    const btnSave   = byText('ä¿å­˜åˆ°äº‘ç«¯');
    const btnLoad   = byText('ä»äº‘ç«¯æ‹‰å–');

    if(btnLogin){
      btnLogin.onclick = () => { refreshLoginBadge(); open(); setTimeout(()=>$('login-email').focus(), 50); };
    }
    if(btnLogout){
      btnLogout.onclick = () => { if(confirm('ç¡®è®¤é€€å‡ºç™»å½•ï¼Ÿ')) doLogout(); };
    }

    // åœ°åŸº APIï¼šåªå…è®¸æ‰‹åŠ¨è§¦å‘
    if(btnSave){
      btnSave.onclick = async () => {
        if(!window.__isLoggedIn){ open(); return; }
        if(typeof window.saveSnapshotToCloud !== 'function'){
          alert('åœ°åŸº API æœªå°±ç»ªï¼šsaveSnapshotToCloud()'); return;
        }
        try{ await window.saveSnapshotToCloud(); }catch(e){ alert('ä¿å­˜å¤±è´¥ï¼š'+(e?.message||e)); }
      };
    }
    if(btnLoad){
      btnLoad.onclick = async () => {
        if(!window.__isLoggedIn){ open(); return; }
        if(typeof window.loadSnapshotFromCloud !== 'function'){
          alert('åœ°åŸº API æœªå°±ç»ªï¼šloadSnapshotFromCloud()'); return;
        }
        try{ await window.loadSnapshotFromCloud(); }catch(e){ alert('æ‹‰å–å¤±è´¥ï¼š'+(e?.message||e)); }
      };
    }
  }

});
</script>


<script>
/* v9 UIè¡¥ä¸ï¼šæ‰“å¼€ç™»å½•æ—¶è‡ªåŠ¨æ”¶èµ·â˜ï¸é¢æ¿ï¼Œé¿å…é®æŒ¡è§†é‡ï¼ˆä¸è§¦å‘ä»»ä½•äº‘ç«¯è¯»å†™ï¼‰ */
document.addEventListener('DOMContentLoaded', () => {
  const card = document.getElementById('addon-card') || document.querySelector('.cloud-addon-card');
  const mask = document.querySelector('.login-modal-mask');
  if(!card || !mask) return;

  const isLoginBtn = (btn) => {
    const t = (btn.textContent || '').trim();
    return t.includes('ç™»å½•') || t.toLowerCase().includes('login');
  };

  // 1) ç‚¹å‡»â˜ï¸é¢æ¿é‡Œçš„â€œç™»å½•â€æŒ‰é’®ï¼šå…ˆæ”¶èµ·é¢æ¿ï¼Œå†æ‰“å¼€ç™»å½•å¼¹çª—
  const btns = Array.from(card.querySelectorAll('button,[role="button"],a'));
  const loginBtn = btns.find(isLoginBtn);
  if(loginBtn){
    loginBtn.addEventListener('click', (e) => {
      // å…¼å®¹åŸæœ‰å†…è” onclickï¼ˆalert / openLogin / å…¶ä»–ï¼‰ï¼Œæˆ‘ä»¬æ¥ç®¡ä¸€æ¬¡
      e.preventDefault();
      e.stopPropagation();
      card.style.display = 'none';
      // æ‰“å¼€æˆ‘ä»¬å·²ç»æ³¨å…¥çš„ç™»å½•å¼¹çª—
      mask.style.display = 'flex';
      try{
        // èšç„¦é‚®ç®±è¾“å…¥
        const email = document.getElementById('login-email');
        if(email) email.focus();
      }catch(_){}
    }, {capture:true});
  }

  // 2) å…œåº•ï¼šåªè¦ç™»å½•å¼¹çª—æ˜¾ç¤ºï¼Œå°±å¼ºåˆ¶æ”¶èµ·â˜ï¸é¢æ¿
  const mo = new MutationObserver(() => {
    const disp = getComputedStyle(mask).display;
    if(disp !== 'none'){
      card.style.display = 'none';
    }
  });
  mo.observe(mask, {attributes:true, attributeFilter:['style','class']});
});
</script>


<script>
(function(){
  let lastY = window.scrollY;
  window.addEventListener('scroll', () => {
    const now = window.scrollY;
    if (now > lastY + 8) {
      document.body.classList.add('scrolling-down');
    } else if (now < lastY - 8) {
      document.body.classList.remove('scrolling-down');
    }
    lastY = now;
  }, { passive: true });
})();
</script>


<script>
/*
  v15 ç»ˆææ–¹æ¡ˆï¼š
  - â˜ï¸ æŒ‰é’®ç”± JS åŠ¨æ€æ’å…¥ / é‡ç®—ä½ç½®
  - ä½¿ç”¨ MutationObserver æ•è·çœŸå®èŠ‚ç‚¹
  - åœ¨â€œæœ€ç»ˆèŠ‚ç‚¹â€ä¸Šå¼ºåˆ¶ translateY(20px)
*/
(function () {
  const OFFSET = 20;

  function applyShift(el) {
    if (!el || el.__cloudShiftApplied) return;
    el.__cloudShiftApplied = true;

    const prevTransform = getComputedStyle(el).transform;
    if (prevTransform && prevTransform !== 'none') {
      el.style.transform = prevTransform + ` translateY(${OFFSET}px)`;
    } else {
      el.style.transform = `translateY(${OFFSET}px)`;
    }
  }

  function scan() {
    document.querySelectorAll('button, div, a').forEach(el => {
      const txt = (el.innerText || '').trim();
      if (txt === 'â˜ï¸' || txt === 'â˜') {
        applyShift(el);
      }
    });
  }

  // åˆæ¬¡æ‰«æ
  scan();

  // ç›‘å¬ DOM å˜åŒ–ï¼ˆåº”å¯¹ JS é‡æ–°æ¸²æŸ“ / ä½ç½®é‡ç®—ï¼‰
  const mo = new MutationObserver(() => scan());
  mo.observe(document.body, { childList: true, subtree: true });
})();
</script>


<script>
/*
 v15kï¼ˆæŒ‰ä½ çš„è¦æ±‚ï¼‰ï¼š
 - åŸºçº¿ï¼šv15
 - æœºåˆ¶ï¼šå®Œå…¨æ²¿ç”¨ v15d çš„â€œè¯»å– computed transform â†’ è¿½åŠ  scaleâ€çš„æ–¹å¼ï¼ˆä½ è®¾å¤‡ä¸Šç¡®è®¤å¯è§ï¼‰
 - ç›®æ ‡ï¼šç­‰æ•ˆâ‰ˆ14pxï¼šç”¨ BASE_FONT_PX=16 + SCALE=0.85
 - é¢å¤–ç¨³æ˜¾ï¼šè¯†åˆ« â˜ï¸ å…ƒç´ æ—¶æ›´å®½æ¾ï¼ˆtextContent å« â˜ï¼‰
*/
(function(){
  const BASE_FONT_PX = 16;
  const SCALE = 0.85;

  function isCloudEl(el){
    const t = (el.textContent || '').trim();
    if (t === 'â˜ï¸' || t === 'â˜') return true;
    // å®½æ¾ï¼šåªè¦åŒ…å«äº‘å­—ç¬¦ï¼ˆé¿å…å‰åæœ‰ä¸å¯è§å­—ç¬¦ï¼‰
    if (t.includes('â˜')) return true;
    return false;
  }

  function apply(el){
    if (!el || el.__cloudScaled14) return;
    el.__cloudScaled14 = true;

    // è®© emoji å­—å½¢ç¨³å®šäº›
    el.style.fontSize = BASE_FONT_PX + 'px';
    el.style.lineHeight = '1';

    // v15d åŒæ¬¾ï¼šä» computed transform å–â€œæœ€ç»ˆå®šä½â€ï¼Œåœ¨å…¶åå åŠ  scale
    const prev = getComputedStyle(el).transform;
    const base = (prev && prev !== 'none') ? prev.replace(/scale\([^\)]*\)/g,'').trim() : '';

    if (base) {
      el.style.transform = base + ' scale(' + SCALE + ')';
    } else {
      el.style.transform = 'scale(' + SCALE + ')';
    }
  }

  function scan(){
    document.querySelectorAll('button,div,a,[role="button"]').forEach(el=>{
      if (isCloudEl(el)) apply(el);
    });
  }

  scan();
  const mo = new MutationObserver(scan);
  mo.observe(document.body,{childList:true,subtree:true});
})();
</script>


<script>
/*
v22ï¼šäº‘ç«¯è´¦å·ç®¡ç†å‘˜ï¼ˆè¯»å–æ—§ç®¡ç†å‘˜å®ç°é€»è¾‘ï¼‰
- çœŸå®äº‘ç«¯è´¦å·ï¼šé€šè¿‡ Supabase Edge Functionsï¼ˆadmin-create-user / reset-password / admin-delete-userï¼‰
- æ˜¾ç¤ºæ‰€æœ‰è´¦å·ï¼šè¯»å– user_profilesï¼ˆPROFILE_TABLEï¼‰åˆ—è¡¨
- å°å·/å¯ç™»å½•ï¼šæ›´æ–° user_profiles.disabledï¼ˆRLS éœ€å…è®¸ç®¡ç†å‘˜æ›´æ–°ï¼›æ²¿ç”¨æ—§ç‰ˆé€»è¾‘ï¼‰
- ä»éµå®ˆï¼šä¸è‡ªåŠ¨äº‘ç«¯ä¿å­˜/æ‹‰å–è®¢å•å¿«ç…§ï¼›ç®¡ç†å‘˜æ“ä½œæ˜¯â€œæ‰‹åŠ¨ç‚¹å‡»â€è§¦å‘
*/
(function(){
  const SUPABASE_URL = (typeof window.SUPABASE_URL === 'string' && window.SUPABASE_URL) || 'https://yqsjkdndasbdfmjwahwk.supabase.co';
  const SUPABASE_KEY = (typeof window.SUPABASE_KEY === 'string' && window.SUPABASE_KEY) || (typeof window.SUPABASE_PUBLISHABLE_KEY==='string' && window.SUPABASE_PUBLISHABLE_KEY) || 'sb_publishable_8owDy_9hIN3uaBCzd6jncg_i8e68dL0';
  const PROFILE_TABLE = 'user_profiles';

  function toast(msg){
    try{
      if(typeof window.amMsg === 'function'){ window.amMsg(String(msg||''), false); return; }
    }catch(e){}
    alert(String(msg||''));
  }

  function h(tag, attrs={}, kids=[]){
    const el=document.createElement(tag);
    for(const k in attrs){
      const v=attrs[k];
      if(k==='style') Object.assign(el.style, v);
      else if(k==='class') el.className=v;
      else if(k.startsWith('on') && typeof v==='function') el.addEventListener(k.slice(2), v);
      else el.setAttribute(k, v);
    }
    kids.forEach(c=> el.appendChild(typeof c==='string'?document.createTextNode(c):c));
    return el;
  }

  function getClient(){
    return window.__supa || (window.supabase && window.supabase.createClient ? null : null);
  }

  async function getSession(){
    const client = getClient();
    if(!client) throw new Error('Supabase æœªåˆå§‹åŒ–');
    const { data, error } = await client.auth.getSession();
    if(error) throw error;
    return data && data.session ? data.session : null;
  }

  async function getAccessToken(){
    const s = await getSession();
    return s && s.access_token ? s.access_token : null;
  }

  async function getCurrentEmail(){
    const s = await getSession();
    return s && s.user && s.user.email ? s.user.email : '';
  }

  async function callEdge(fnName, body){
    // å…¼å®¹ç§»åŠ¨ç«¯å Authorizationï¼štoken æ”¾ bodyï¼›Edge Function Verify JWT éœ€ OFFï¼ˆæ—§ç‰ˆå°±æ˜¯è¿™ä¹ˆåšçš„ï¼‰
    const token = await getAccessToken();
    if(!token) throw new Error('ä¼šè¯å·²å¤±æ•ˆï¼šè¯·é‡æ–°ç™»å½•');
    const url = SUPABASE_URL.replace(/\/$/,'') + '/functions/v1/' + fnName + '?t=' + Date.now();
    const payload = Object.assign({ access_token: token }, body||{});
    const resp = await fetch(url, {
      method:'POST',
      mode:'cors',
      cache:'no-store',
      headers:{
        'apikey': SUPABASE_KEY,
        'Content-Type':'application/json'
      },
      body: JSON.stringify(payload)
    });
    let json=null;
    try{ json = await resp.json(); }catch(e){}
    if(!resp.ok){
      const msg = (json && (json.error||json.message)) ? (json.error||json.message) : (resp.status+' '+resp.statusText);
      throw new Error(msg);
    }
    if(json && json.error) throw new Error(json.error);
    return json;
  }

  function openAdminModal(){
    const overlay = h('div',{style:{
      position:'fixed', inset:'0', background:'rgba(0,0,0,.45)', zIndex: 999999,
      display:'flex', alignItems:'center', justifyContent:'center', padding:'16px'
    }});
    const card = h('div',{style:{
      width:'min(760px, 100%)', background:'#fff', borderRadius:'18px',
      boxShadow:'0 18px 60px rgba(0,0,0,.28)', overflow:'hidden'
    }});
    const head = h('div',{style:{
      padding:'14px 16px', display:'flex', alignItems:'center', justifyContent:'space-between',
      background:'linear-gradient(180deg,#f7f7f9,#ffffff)'
    }},[
      h('div',{style:{fontWeight:'900', fontSize:'15px'}},['ç®¡ç†å‘˜ Â· äº‘ç«¯è´¦å·']),
      h('div',{style:{display:'flex', gap:'8px'}},[
        h('button',{style:{border:'none', background:'rgba(0,0,0,.06)', borderRadius:'12px', padding:'8px 10px', cursor:'pointer'},
          onclick:()=>{ overlay.remove(); }},['å…³é—­'])
      ])
    ]);

    const body = h('div',{style:{padding:'14px 16px'}});
    const row = h('div',{style:{display:'grid', gridTemplateColumns:'1.1fr .9fr', gap:'12px'}});
    const left = h('div');
    const right = h('div');

    // Left: list
    const listCard = h('div',{style:{border:'1px solid rgba(0,0,0,.10)', borderRadius:'16px', overflow:'hidden'}});
    const listHead = h('div',{style:{padding:'10px 12px', display:'flex', justifyContent:'space-between', alignItems:'center', background:'#fafafa'}},[
      h('div',{style:{fontWeight:'800'}},['è´¦å·åˆ—è¡¨']),
      h('button',{style:{border:'none', background:'rgba(17,24,39,.08)', borderRadius:'12px', padding:'8px 10px', cursor:'pointer', fontSize:'13px', fontWeight:'800'},
        onclick:()=>loadList()},['åˆ·æ–°'])
    ]);
    const tableWrap = h('div',{style:{maxHeight:'52vh', overflow:'auto'}});
    const table = h('table',{style:{width:'100%', borderCollapse:'collapse', fontSize:'13px'}});
    const thead = h('thead',{},[
      h('tr',{},[
        h('th',{style:{textAlign:'left', padding:'10px 12px', borderBottom:'1px solid rgba(0,0,0,.06)'}},['é‚®ç®±']),
        h('th',{style:{textAlign:'left', padding:'10px 12px', borderBottom:'1px solid rgba(0,0,0,.06)'}},['çŠ¶æ€']),
        h('th',{style:{textAlign:'left', padding:'10px 12px', borderBottom:'1px solid rgba(0,0,0,.06)'}},['åˆ›å»ºæ—¶é—´'])
      ])
    ]);
    const tbody = h('tbody');
    table.appendChild(thead); table.appendChild(tbody);
    tableWrap.appendChild(table);
    listCard.appendChild(listHead);
    listCard.appendChild(tableWrap);

    // Right: actions
    const actCard = h('div',{style:{border:'1px solid rgba(0,0,0,.10)', borderRadius:'16px', padding:'12px'}});
    const actTitle = h('div',{style:{fontWeight:'900', marginBottom:'8px'}},['æ“ä½œ']);

    function input(placeholder, type='text'){
      return h('input',{type, placeholder, style:{
        width:'100%', padding:'10px 12px', borderRadius:'12px', border:'1px solid rgba(0,0,0,.14)',
        fontSize:'14px', outline:'none', marginBottom:'10px'
      }});
    }
    const emailI = input('ç›®æ ‡é‚®ç®±ï¼ˆä¾‹å¦‚ï¼ša@b.comï¼‰');
    const passI  = input('å¯†ç ï¼ˆ>=8ä½ï¼‰', 'password');

    function btn(label, onClick, danger=false){
      return h('button',{style:{
        width:'100%', padding:'11px 12px', borderRadius:'12px', border:'none',
        background: danger ? 'rgba(185,28,28,.10)' : '#111827',
        color: danger ? '#b91c1c' : '#fff',
        cursor:'pointer', fontSize:'14px', fontWeight:'900', marginBottom:'10px'
      }, onclick:onClick},[label]);
    }

    const createBtn = btn('æ–°å»ºè´¦å·', async ()=>{
      try{
        const admin_email = await getCurrentEmail();
        const target_email = (emailI.value||'').trim();
        const pw = (passI.value||'').trim();
        if(!target_email) return toast('è¯·è¾“å…¥ç›®æ ‡é‚®ç®±');
        if(!pw || pw.length<8) return toast('å¯†ç è‡³å°‘ 8 ä½');
        // å…¼å®¹å­—æ®µåï¼šåŒæ—¶å‘é€ email/target_email
        await callEdge('admin-create-user', { admin_email, target_email, email: target_email, target_password: pw });
        toast('åˆ›å»ºæˆåŠŸ');
        passI.value='';
        await loadList();
      }catch(e){ toast('åˆ›å»ºå¤±è´¥ï¼š'+(e?.message||e)); }
    });

    const resetBtn = btn('é‡ç½®å¯†ç ', async ()=>{
      try{
        const admin_email = await getCurrentEmail();
        const target_email = (emailI.value||'').trim();
        const pw = (passI.value||'').trim();
        if(!target_email) return toast('è¯·è¾“å…¥ç›®æ ‡é‚®ç®±');
        if(!pw || pw.length<8) return toast('å¯†ç è‡³å°‘ 8 ä½');
        await callEdge('reset-password', { admin_email, target_email, email: target_email, new_password: pw });
        toast('é‡ç½®æˆåŠŸ');
        passI.value='';
      }catch(e){ toast('é‡ç½®å¤±è´¥ï¼š'+(e?.message||e)); }
    });

    const delBtn = btn('åˆ é™¤è´¦å·ï¼ˆå±é™©ï¼‰', async ()=>{
      try{
        const admin_email = await getCurrentEmail();
        const target_email = (emailI.value||'').trim();
        if(!target_email) return toast('è¯·è¾“å…¥ç›®æ ‡é‚®ç®±');
        if(!confirm('ç¡®å®šåˆ é™¤è´¦å·ï¼š'+target_email+' ?\nåˆ é™¤åä¸å¯æ¢å¤')) return;
        // æ—§å‡½æ•°åï¼šadmin-delete-userï¼ˆzip æ–‡ä»¶ delete-user.ts å»ºè®®éƒ¨ç½²ä¸ºè¯¥åï¼‰
        await callEdge('admin-delete-user', { admin_email, target_email, email: target_email });
        toast('åˆ é™¤æˆåŠŸ');
        await loadList();
      }catch(e){ toast('åˆ é™¤å¤±è´¥ï¼š'+(e?.message||e)); }
    }, true);

    actCard.appendChild(actTitle);
    actCard.appendChild(emailI);
    actCard.appendChild(passI);
    actCard.appendChild(createBtn);
    actCard.appendChild(resetBtn);
    actCard.appendChild(delBtn);
    actCard.appendChild(h('div',{style:{fontSize:'12px', color:'rgba(0,0,0,.55)'}},[
      'å°å·/è§£å°ï¼šåœ¨å·¦ä¾§åˆ—è¡¨ç‚¹å‡»çŠ¶æ€å³å¯åˆ‡æ¢ï¼ˆå†™å…¥ user_profiles.disabledï¼‰ã€‚'
    ]));

    left.appendChild(listCard);
    right.appendChild(actCard);
    row.appendChild(left); row.appendChild(right);
    body.appendChild(row);

    card.appendChild(head); card.appendChild(body);
    overlay.appendChild(card);
    overlay.addEventListener('click',(e)=>{ if(e.target===overlay) overlay.remove(); });
    document.body.appendChild(overlay);

    async function loadList(){
      try{
        const client = getClient();
        if(!client) throw new Error('Supabase æœªåˆå§‹åŒ–');
        tbody.innerHTML = `<tr><td colspan="3" style="padding:10px 12px;color:#555">åŠ è½½ä¸­â€¦</td></tr>`;
        const { data, error } = await client
          .from(PROFILE_TABLE)
          .select('id,email,disabled,role,created_at,updated_at')
          .order('created_at',{ascending:false})
          .limit(300);
        if(error) throw error;
        if(!data || !data.length){
          tbody.innerHTML = `<tr><td colspan="3" style="padding:10px 12px;color:#555">æš‚æ— ç”¨æˆ·ï¼ˆæˆ–è¡¨/ç­–ç•¥æœªåˆå§‹åŒ–ï¼‰</td></tr>`;
          return;
        }
        tbody.innerHTML = '';
        data.forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.06)">${(r.email||r.id||'')}</td>
            <td style="padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.06)">
              <a href="javascript:void(0)" data-uid="${r.id}" data-enabled="${r.disabled===true?'0':'1'}" style="font-weight:800;text-decoration:none">
                ${r.disabled===true ? 'â›” å·²å°å·' : 'âœ… å¯ç™»å½•'}
              </a>
            </td>
            <td style="padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.06)">${(r.created_at||'').toString().replace('T',' ').slice(0,19)}</td>
          `;
          tbody.appendChild(tr);
        });

        tbody.querySelectorAll('a[data-uid]').forEach(a=>{
          a.onclick = async ()=>{
            try{
              const uid = a.getAttribute('data-uid');
              const cur = a.getAttribute('data-enabled') === '1';
              const nextEnabled = !cur;
              const { error: upE } = await client.from(PROFILE_TABLE).update({ disabled: !nextEnabled }).eq('id', uid);
              if(upE) throw upE;
              await loadList();
            }catch(e){ toast('æ›´æ–°å¤±è´¥ï¼š'+(e?.message||e)); }
          };
        });
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="3" style="padding:10px 12px;color:#e74c3c">è¯»å–å¤±è´¥ï¼š${(e?.message||e)}</td></tr>`;
      }
    }

    // åˆæ¬¡åŠ è½½
    loadList();
  }

  function bindAdminButton(){
    // â˜ï¸é¢æ¿å†…çš„â€œç®¡ç†å‘˜â€æŒ‰é’®ï¼ˆæ—§ç‰ˆå ä½ alertï¼‰â€”â€”å°½é‡å®½æ¾åŒ¹é…
    const btns = Array.from(document.querySelectorAll('.cloud-addon-card button, button'));
    const adminBtn = btns.find(b => (b.textContent||'').includes('ç®¡ç†å‘˜'));
    if(adminBtn && !adminBtn.__boundAdmin){
      adminBtn.__boundAdmin = true;
      adminBtn.addEventListener('click', (e)=>{
        e.preventDefault(); e.stopPropagation();
        (async ()=>{
          try{
            const email = await getCurrentEmail();
            if ((email||'').toLowerCase() !== '912872449@qq.com') {
              toast('æ— æƒé™ï¼šä»…ç®¡ç†å‘˜å¯è¿›å…¥');
              return;
            }
            openAdminModal();
          }catch(e){
            toast('æ— æ³•æ ¡éªŒæƒé™ï¼š'+(e?.message||e));
          }
        })();
      }, true);
    }
  }

  document.addEventListener('DOMContentLoaded', bindAdminButton);
  new MutationObserver(bindAdminButton).observe(document.body,{childList:true,subtree:true});
})();
</script>


<script>
/* v23ï¼šç®¡ç†å‘˜å…¥å£é‰´æƒï¼ˆéç®¡ç†å‘˜ä¸å¯è¿›å…¥/ä¸å¯è§ï¼‰ */
(function(){
  const ADMIN_EMAIL = '912872449@qq.com';

  async function getEmailSafe(){
    try{
      if (typeof getCurrentEmail === 'function'){
        const e = await getCurrentEmail();
        return (e||'').toLowerCase();
      }
    }catch(_){}
    try{
      const c = window.__supa || null;
      if (c && c.auth && c.auth.getSession){
        const { data } = await c.auth.getSession();
        const e = data && data.session && data.session.user ? data.session.user.email : '';
        return (e||'').toLowerCase();
      }
    }catch(_){}
    return '';
  }

  async function gateAdminButton(){
    const btns = Array.from(document.querySelectorAll('.cloud-addon-card button, button'));
    const adminBtn = btns.find(b => (b.textContent||'').includes('ç®¡ç†å‘˜'));
    if(!adminBtn) return;

    const email = await getEmailSafe();
    const isAdmin = email === ADMIN_EMAIL;

    if (adminBtn.__gated) return;
    adminBtn.__gated = true;

    if (!isAdmin){
      // æ›´äº§å“çš„è¡¨ç°ï¼šç›´æ¥éšè—å…¥å£
      adminBtn.style.display = 'none';
      // å¦‚éœ€â€œå¯è§ä½†ä¸å¯ç‚¹â€ï¼Œæ”¹ä¸ºï¼š
      // adminBtn.disabled = true;
      // adminBtn.style.opacity = '0.5';
      // adminBtn.title = 'ä»…ç®¡ç†å‘˜å¯ç”¨';
    }
  }

  gateAdminButton();
  new MutationObserver(()=>gateAdminButton()).observe(document.body, {childList:true, subtree:true});
})();
</script>

</body>
</html>






<script>



<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ======== æ­£å¼ç™»å½•ï¼ˆé‚®ç®±+å¯†ç ï¼‰ ======== */
(function(){
  const SUPABASE_URL = 'https://yqsjkdndasbdfmjwahwk.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_8owDy_9hIN3uaBCzd6jncg_i8e68dL0';
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false } });
  window.__supa = client;

  // ç®€å•ç™»å½•æ¡†
  function openLogin(){
    const email = prompt('è¯·è¾“å…¥é‚®ç®±');
    if(!email) return;
    const pwd = prompt('è¯·è¾“å…¥å¯†ç ');
    if(!pwd) return;
    client.auth.signInWithPassword({email,password:pwd}).then(r=>{
      if(r.error){alert('ç™»å½•å¤±è´¥:'+r.error.message);return;}
      __setLoginState(true);
      alert('ç™»å½•æˆåŠŸ');
    });
  }

  function logout(){
    client.auth.signOut();
    __setLoginState(false);
    alert('å·²é€€å‡º');
  }

  document.querySelectorAll('button').forEach(b=>{
    const t=b.innerText||'';
    if(t.includes('ç™»å½•')) b.onclick=openLogin;
    if(t.includes('é€€å‡º')) b.onclick=logout;
  });
})();
</script>


<script>
/* ======== Step 3 äº‘ç«¯ä¿å­˜ / æ‹‰å–ï¼ˆæ­£å¼ç™»å½•æ•´åˆç‰ˆï¼‰ ======== */
(function(){
  function getClient(){
    return window.__supa || null;
  }

  async function cloudSave(){
    if(!window.__isLoggedIn){ alert('è¯·å…ˆç™»å½•'); return; }
    if(!confirm('æ˜¯å¦ç¡®è®¤ç”¨ã€å½“å‰æœ¬åœ°æ•°æ®ã€‘è¦†ç›–äº‘ç«¯ï¼Ÿ')) return;
    const client=getClient();
    if(!client){ alert('äº‘ç«¯æœªåˆå§‹åŒ–'); return; }

    const { data: u, error: ue } = await client.auth.getUser();
    if(ue||!u?.user){ alert('æ— æ³•è·å–ç”¨æˆ·'); return; }

    const { error } = await client
      .from('app_state_user')
      .update({ data: window.orders })
      .eq('id', u.user.id);

    if(error){ alert('ä¿å­˜å¤±è´¥ï¼š'+error.message); return; }
    alert('å·²ä¿å­˜åˆ°äº‘ç«¯');
  }

  async function cloudLoad(){
    if(!window.__isLoggedIn){ alert('è¯·å…ˆç™»å½•'); return; }
    const client=getClient();
    if(!client){ alert('äº‘ç«¯æœªåˆå§‹åŒ–'); return; }

    const { data: u, error: ue } = await client.auth.getUser();
    if(ue||!u?.user){ alert('æ— æ³•è·å–ç”¨æˆ·'); return; }

    const { data, error } = await client
      .from('app_state_user')
      .select('data')
      .eq('id', u.user.id)
      .single();

    if(error){ alert('æ‹‰å–å¤±è´¥ï¼š'+error.message); return; }
    if(!data){ alert('äº‘ç«¯æš‚æ— æ•°æ®'); return; }
    if(!confirm('äº‘ç«¯æ•°æ®å°†ã€è¦†ç›–å½“å‰æœ¬åœ°æ•°æ®ã€‘ï¼Œæ˜¯å¦ç¡®è®¤ï¼Ÿ')) return;

    window.orders = data.data;
    if(typeof render==='function') render();
    alert('å·²ä»äº‘ç«¯æ‹‰å–');
  }

  // bind by data-action if exists, else by text
  document.querySelectorAll('button').forEach(btn=>{
    const t=(btn.innerText||'');
    if(t.includes('ä¿å­˜åˆ°äº‘ç«¯')||t.includes('ä¿å­˜äº‘ç«¯')||t.includes('ä¿å­˜')) btn.addEventListener('click', cloudSave);
    if(t.includes('ä»äº‘ç«¯æ‹‰å–')||t.includes('æ‹‰å–')) btn.addEventListener('click', cloudLoad);
  });
})();
</script>
<script>
// v10: â˜ï¸ æ‚¬æµ®æŒ‰é’®ä¸Šç§»åˆ°é¡¶éƒ¨ï¼Œé¿å…é®æŒ¡åº•éƒ¨æ•°æ®ï¼ˆä»… UI è°ƒæ•´ï¼‰
document.addEventListener('DOMContentLoaded', () => {
  const panel = document.querySelector('.cloud-addon-panel');
  const toggle = document.getElementById('addon-toggle') || document.querySelector('.cloud-addon-toggle');
  const card = document.getElementById('addon-card') || document.querySelector('.cloud-addon-card');

  if (!panel || !toggle) return;

  // é‡‡ç”¨å®‰å…¨åŒº insetï¼Œå…¼å®¹åˆ˜æµ·å±
  const topInset = 'calc(env(safe-area-inset-top, 0px) + 12px)';
  const rightInset = 'calc(env(safe-area-inset-right, 0px) + 12px)';

  // æ‚¬æµ®å…¥å£ï¼šå³ä¸Šè§’
  panel.style.right = rightInset;
  panel.style.top = topInset;
  panel.style.bottom = 'auto';

  // å¼¹å‡ºå¡ç‰‡ï¼šæŒ‰é’®ä¸‹æ–¹
  if (card) {
    card.style.right = rightInset;
    card.style.top = 'calc(env(safe-area-inset-top, 0px) + 78px)';
    card.style.bottom = 'auto';
  }

  // è‹¥é¡µé¢æœ‰é¡¶éƒ¨å›ºå®šæ ï¼Œå°½é‡é¿å…é®æŒ¡ï¼ˆåªåšè½»é‡é¿è®©ï¼‰
  // è§„åˆ™ï¼šå¦‚æœ toggle è¦†ç›–åˆ°é¡µé¢ç¬¬ä¸€ä¸ªå¤§å¡ç‰‡é¡¶éƒ¨åŒºåŸŸï¼Œåˆ™å†ä¸‹ç§»ä¸€ç‚¹
  try {
    const firstCard = document.querySelector('.card, .summary-card, .container .card, .dashboard-card');
    if (firstCard) {
      const tRect = toggle.getBoundingClientRect();
      const cRect = firstCard.getBoundingClientRect();
      if (tRect.bottom > cRect.top && tRect.top < cRect.bottom) {
        panel.style.top = 'calc(env(safe-area-inset-top, 0px) + 60px)';
        if (card) card.style.top = 'calc(env(safe-area-inset-top, 0px) + 126px)';
      }
    }
  } catch(e) {}
});
</script>
